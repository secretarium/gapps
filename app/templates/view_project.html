{% extends "layouts/sidebar-nav.html" %}
{% import "helpers/snippets.html" as snippet with context %}
{% block before_head %}
{{ super() }}
{% import "helpers/src_macros.html" as macro %}
{{ macro.filehelper(grid=True, editor=True, driver=True, tags=True, confetti=True, files=True, apex=True, markdown=True) }}
<style xmlns="http://www.w3.org/1999/html">
	.breadcrumbs>ul>li+:before {
	  margin-top: 5px;
	}
</style>

{% endblock %}

{% block navbarLeft%}
<div class="flex items-center space-x-3">
  <img class="h-5 w-5" src="{{ url_for('static', filename='img/icon.png') }}">
  <span class="text-xl font-bold capitalize"><a href="/">{{config.APP_NAME}}</a></span>
</div>
{%endblock%}

{%block header%}{%endblock%}
{%block page_header%}{%endblock%}

{%block content%}
<div x-data="project()">
	<div class="drawer drawer-end z-50">
	<input @change="closeControlDrawer" id="right-drawer" type="checkbox" class="drawer-toggle" />
	<div class="drawer-content">
	</div>

	<div class="drawer-side">
		<label for="right-drawer" aria-label="close sidebar" class="drawer-overlay"></label>

		<div class="bg-base-200 flex flex-col h-screen w-3/4 px-6">

			<!-- Top Section (Static) -->
			<div class="border-b border-base-300 pt-4">
				<div x-show="!selectedSubControl">
					<div class="p-6 px-4 pb-2 border border-base-300 rounded-md">
						<div class="flex flex-row gap-x-8">
						<div class="flex flex-row gap-x-2">
							<h3 :class="{'text-error': !selectedControl.is_applicable}" class="my-auto text-xl" x-text="selectedControl.progress_completed"></h3>
							<div class="flex justify-stretch space-x-1 my-auto">
							  <template x-for="n in idToProgressBarMapping[selectedControl.id].total">
								<div
								  class="flex flex-col flex-nowrap justify-end w-0.5 h-6 bg-neutral-content opacity-90 rounded-full overflow-hidden relative"
								  role="progressbar"
								  :aria-valuenow="n <= idToProgressBarMapping[selectedControl.id].filledBars ? 100 : 0"
								  aria-valuemin="0"
								  aria-valuemax="100">
								  <div
									class="rounded-full overflow-hidden"
									:class="idToProgressBarMapping[selectedControl.id].color"
									:style="`height: ${n <= idToProgressBarMapping[selectedControl.id].filledBars ? '100%' : '0%'}`">
								  </div>
								  <span class="text-xs absolute bottom-0 left-0 right-0 text-center"></span>
								</div>
							  </template>
							</div>
						</div>

						<div class="flex justify-between w-full pl-8 border-l">
							<div class="flex flex-col">
								<span class="subtitle text-xs !mb-0" x-text="'Control Title - '+selectedControl.ref_code"></span>
								<span class="text-lg" x-text="selectedControl.name"></span>
							</div>
							<div class="flex flex-row gap-x-2">						
								<div class="dropdown dropdown-end">
								  <div tabindex="0" role="button" class="btn btn-sm opacity-80">Actions</div>
								  <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-[1] w-52 p-2 shadow gap-y-1">
									<li>
										<button x-show="selectedControl.is_applicable" @click="setAsNotApplicable(selectedControl)" class="btn btn-xs text-error">Mark as Not Applicable</button>
										<button x-show="!selectedControl.is_applicable" @click="setAsApplicable(selectedControl)" class="btn btn-xs text-success">Mark as Applicable</button>
									</li>
									<li>
										<button @click="changeControlTabInDrawer('subcontrols')" class="btn btn-xs">View Subcontrols</button>
									</li>

								  </ul>
								</div>
								<button @click="copyControlLink(selectedControl.id)" class="btn btn-sm opacity-80"><i class="ti ti-share text-xl"></i></button>
								<button @click="closeControlDrawer" class="btn btn-sm"><i class="ti ti-x text-xl"></i></button>
<!--                                <button class="btn"><i class="ti ti-external-link text-xl"></i></button>-->
							</div>
						</div>
					</div>
						<div class="grid grid-cols-12 my-6 gap-x-6">
						<div :class="{'my-auto': projectData.auditors.length}" class="col-span-2 border-r border-base-100">
							<div class="grid grid-cols-6 gap-x-4">
								<div class="col-span-6 flex flex-col mb-1">
									<div class="flex flex-row gap-x-2">
										<span class="subtitle text-xs">Control Status</span>
										<i @click="openQuickHelp(1)" class="ti ti-question-mark subtitle text-sm hover:cursor-pointer hover:text-warning"></i>
									</div>
									<div class="inline-flex">
										<span :class="{'text-warning': selectedControl.progress_completed<76 && selectedControl.progress_completed>29 , 'text-error': selectedControl.progress_completed<30, 'text-success': selectedControl.progress_completed>75}" class="my-auto px-2 rounded-lg text-ss uppercase font-semibold bg-base-100 inline-block" x-text="selectedControl.status"></span>
									</div>

								</div>
								<div x-show="projectData.auditors.length" class="col-span-6 flex flex-col">
									<div class="flex flex-row gap-x-2">
										<span class="subtitle text-xs">Review Status</span>
										<i @click="openQuickHelp(2)" class="ti ti-question-mark subtitle text-sm hover:cursor-pointer hover:text-warning"></i>
									</div>
									<div class="inline-flex">
										<span @click="changeControlTabInDrawer('auditor')" x-show="isAuditor" :class="{'text-warning': selectedControl.review_status==='infosec action' , 'text-error': selectedControl.review_status==='ready for auditor', 'text-success': selectedControl.review_status==='complete'}" class="my-auto px-2 rounded-lg text-ss uppercase font-semibold bg-base-100 inline-block hover:cursor-pointer hover:opacity-75" x-text="selectedControl.review_status"></span>
										<span @click="changeControlTabInDrawer('auditor')" x-show="!isAuditor" :class="{'text-error': selectedControl.review_status==='infosec action' , 'text-warning': selectedControl.review_status==='ready for auditor', 'text-success': selectedControl.review_status==='complete'}" class="my-auto px-2 rounded-lg text-ss uppercase font-semibold bg-base-100 inline-block hover:cursor-pointer hover:opacity-75" x-text="selectedControl.review_status"></span>
									</div>
								</div>
							</div>

						</div>
						<div class="col-span-4 border-r border-base-100">
							<div class="flex flex-col w-3/4">
								<div class="flex justify-between">
									<span class="subtitle text-xs">Controls Implemented</span>
									<span class="subtitle text-xs" x-text="selectedControl.progress_implemented+'%'"></span>
								</div>
								<progress
									:class="{
										'progress-error': selectedControl.progress_implemented < 30,
										'progress-warning': selectedControl.progress_implemented >= 30 && selectedControl.progress_implemented < 75,
										'progress-success': selectedControl.progress_implemented >= 75
									}"
									class="progress h-1" :value="selectedControl.progress_implemented+1" max="100"></progress>
								<div class="flex justify-between mt-4">
									<h3 class="subtitle text-xs">Evidence Collection</h3>
									<h3 class="subtitle text-xs" x-text="selectedControl.progress_evidence+'%'"></h3>
								</div>
								<progress
									:class="{
										'progress-error': selectedControl.progress_evidence < 30,
										'progress-warning': selectedControl.progress_evidence >= 30 && selectedControl.progress_evidence < 75,
										'progress-success': selectedControl.progress_evidence >= 75
									}"
									class="progress h-1" :value="selectedControl.progress_evidence+1" max="100"></progress>
							</div>
						</div>
						<div class="col-span-6">
							<div class="flex flex-col mb-2">
								<span class="subtitle text-xs">Control Description</span>
								<div x-data="{ expanded: false }"
									 :class="expanded ? 'h-40' : 'h-12'"
									 class="overflow-y-auto">

									<span class="text-xs" x-text="expanded ? (selectedControl.description || selectedControl.name) : (selectedControl.description || selectedControl.name).slice(0, 90) + '...'"></span>

									<button
										x-show="(selectedControl.description || selectedControl.name).length > 100"
										@click="expanded = !expanded"
										class="text-warning underline ml-2 text-xs">
										<span x-text="expanded ? 'See less' : 'See more'"></span>
									</button>
								</div>

							</div>
						</div>
					</div>
						<div role="tablist" class="tabs gap-x-2">
					  <button @click="changeControlTabInDrawer('details')" :class="{'btn-active': activeSideTab==='details'}" role="tab" class="tab btn btn-sm btn-ghost bg-base-100">Details</button>
					  <button @click="changeControlTabInDrawer('subcontrols')" :class="{'btn-active': activeSideTab==='subcontrols'}" role="tab" class="tab btn btn-sm btn-ghost bg-base-100">
						  <div>
							<i x-show="selectedControl.stats.subcontrols_complete===selectedControl.stats.applicable_subcontrols" class="ti ti-check text-success my-auto"></i>
							<i x-show="selectedControl.stats.subcontrols_complete!==selectedControl.stats.applicable_subcontrols" class="ti ti-alert-triangle text-error my-auto"></i>
							<span x-text="'Subcontrols ('+selectedControl.stats.subcontrols_complete+'/'+selectedControl.stats.applicable_subcontrols+')'"></span>
						  </div>
					  </button>
					  <button @click="changeControlTabInDrawer('auditor')" :class="{'btn-active': activeSideTab==='auditor'}" role="tab" class="tab btn btn-sm btn-ghost bg-base-100">
						  <div>
							<i x-show="selectedControl.review_complete" class="ti ti-check text-success my-auto"></i>
							<i x-show="selectedControl.stats.feedback && !selectedControl.review_complete" class="ti ti-alert-triangle text-warning my-auto"></i>
							<span x-text="'Auditor Review ('+selectedControl.stats.feedback+')'"></span>
						  </div>
					  </button>
					  <button @click="changeControlTabInDrawer('comments'); scrollToRecentMessagesInDrawer()" :class="{'btn-active': activeSideTab==='comments'}" role="tab" class="tab btn btn-sm btn-ghost bg-base-100" x-text="'Comments ('+messagesForControl.length+')'"></button>
					</div>
					</div>
				</div>
				<div x-show="selectedSubControl">
					<div class="p-6 px-4 pb-2 border border-base-300 rounded-md">
						<div class="flex flex-row gap-x-4">
						<div class="flex flex-row gap-x-2 my-auto">
							<button @click="closeSubControlInDrawer" data-tip="Back to control" class="btn btn-sm btn-ghost tooltip tooltip-right"><i class="ti ti-arrow-left text-2xl"></i></button>
							<h3 :class="{'text-error': !selectedSubControl.is_applicable}" class="my-auto text-xl" x-text="selectedSubControl.progress_completed"></h3>
							<div class="flex justify-stretch space-x-1 my-auto">
							  <template x-for="n in idToProgressBarMapping[selectedSubControl.id+'_progress'].total">
								<div
								  class="flex flex-col flex-nowrap justify-end w-0.5 h-6 bg-neutral-content opacity-90 rounded-full overflow-hidden relative"
								  role="progressbar"
								  :aria-valuenow="n <= idToProgressBarMapping[selectedSubControl.id+'_progress'].filledBars ? 100 : 0"
								  aria-valuemin="0"
								  aria-valuemax="100">
								  <div
									class="rounded-full overflow-hidden"
									:class="idToProgressBarMapping[selectedSubControl.id+'_progress'].color"
									:style="`height: ${n <= idToProgressBarMapping[selectedSubControl.id+'_progress'].filledBars ? '100%' : '0%'}`">
								  </div>
								  <span class="text-xs absolute bottom-0 left-0 right-0 text-center"></span>
								</div>
							  </template>
							</div>
						</div>

						<div class="flex justify-between w-full pl-4 border-l">
							<div class="flex flex-col pr-4">
								<span class="subtitle text-xs !mb-0" x-text="'SubControl Title - '+selectedSubControl.ref_code"></span>
								<span class="text-lg" x-text="selectedSubControl.name"></span>
							</div>
							<div class="flex flex-row gap-x-2">
								<div class="dropdown">
								  <div tabindex="0" role="button" class="btn btn-sm opacity-80">Actions</div>
								  <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-[1] w-52 p-2 shadow">
									<li>
										<button x-show="selectedSubControl.is_applicable" @click="setSubControlAsNotApplicable(selectedSubControl)" class="btn btn-xs text-error">Mark as Not Applicable</button>
										<button x-show="!selectedSubControl.is_applicable" @click="setSubControlAsApplicable(selectedSubControl)" class="btn btn-xs text-success">Mark as Applicable</button>
									</li>
								  </ul>
								</div>
								<div class="dropdown dropdown-bottom dropdown-end">
								  <div tabindex="0" role="button" class="btn btn-sm opacity-80">Switch Subcontrol</div>
								  <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-[1] w-96 p-2 shadow">
									<template x-for="subcontrol in selectedControl.subcontrols">
										<li @click="openSubControlInDrawer(subcontrol)">
											<div :class="{'opacity-50': selectedSubControl.id===subcontrol.id}" class="flex justify-between">
												<div x-show="subcontrol.is_applicable" class="flex flex-row gap-x-2 w-1/2">
													<span x-text="subcontrol.progress_completed"></span>
													<progress class="progress w-full h-1 my-auto" :value="subcontrol.progress_completed+1" max="100"></progress>
												</div>
												<div x-show="!subcontrol.is_applicable" class="flex flex-row gap-x-2 w-1/2">
													<span class="text-error">Not Applicable</span>
												</div>
												<span x-text="subcontrol.ref_code"></span>
											</div>
										</li>

									</template>
								  </ul>
								</div>
								<button @click="copySubControlLink(selectedSubControl.id)" class="btn btn-sm opacity-80"><i class="ti ti-share text-xl"></i></button>
							</div>
						</div>
					</div>
						<div class="grid grid-cols-12 my-4 gap-x-6">
							<div class="col-span-3 my-auto border-r border-base-100">
								<div class="grid grid-cols-6 gap-x-4">
									<div class="col-span-6 flex flex-col mb-1">
										<span class="subtitle text-xs"><i class="ti ti-sun mr-1 my-auto"></i>Subcontrol Status</span>
										<div class="inline-flex">
											<span x-text="selectedSubControl.completion_status"></span>
										</div>
									</div>
								</div>
							</div>
							<div class="col-span-4 border-r border-base-100">
								<div class="flex flex-col w-3/4">
									<div class="flex justify-between">
										<span class="subtitle text-xs">Implemented</span>
										<span class="subtitle text-xs" x-text="selectedSubControl.implemented+'%'"></span>
									</div>
									<progress
										:class="{
											'progress-error': selectedSubControl.implemented < 30,
											'progress-warning': selectedSubControl.implemented >= 30 && selectedSubControl.implemented < 75,
											'progress-success': selectedSubControl.implemented >= 75
										}"
										class="progress h-1" :value="selectedSubControl.implemented+1" max="100"></progress>
									<div class="flex justify-between mt-4">
										<h3 class="subtitle text-xs">Evidence Attached</h3>
										<h3 x-show="selectedSubControl.has_evidence" class="subtitle text-xs">100%</h3>
										<h3 x-show="!selectedSubControl.has_evidence" class="subtitle text-xs">0%</h3>
									</div>
									<progress x-show="selectedSubControl.has_evidence" class="progress h-1 progress-success" value="100" max="100"></progress>
									<progress x-show="!selectedSubControl.has_evidence" class="progress h-1 progress-error" value="1" max="100"></progress>
								</div>
							</div>
							<div class="col-span-5">
								<div class="flex flex-col mb-2">
									<span class="subtitle text-xs">Subcontrol Description</span>
									<div x-data="{ expanded: false }"
										 :class="expanded ? 'h-40' : 'h-12'"
										 class="overflow-y-auto">

										<span class="text-xs" x-text="expanded ? (selectedControl.description || selectedSubControl.name) : (selectedControl.description || selectedSubControl.name).slice(0, 90) + '...'"></span>

										<button
											x-show="(selectedControl.description || selectedSubControl.name).length > 100"
											@click="expanded = !expanded"
											class="text-warning underline ml-2 text-xs">
											<span x-text="expanded ? 'See less' : 'See more'"></span>
										</button>
									</div>


								</div>
							</div>
						</div>

						<div role="tablist" class="tabs gap-x-2">
						  <button @click="closeSubControlInDrawer" role="tab" class="text-sm tab subtitle hover:opacity-50"><i class="ti ti-arrow-left text-xg mr-2 my-auto"></i>Other subcontrols</button>
						  <button @click="changeSubControlTabInDrawer('details')" :class="{'btn-active': activeSubSideTab==='details'}" role="tab" class="tab btn btn-sm btn-ghost bg-base-100">Details</button>
						  <button x-show="!selectedSubControl.has_evidence" @click="changeSubControlTabInDrawer('evidence')" :class="{'btn-active': activeSubSideTab==='evidence'}" role="tab" class="tab btn btn-sm btn-ghost bg-base-100">
							<i class="ti ti-x text-error my-auto text-lg mr-1"></i>Evidence
						  </button>
						  <button x-show="selectedSubControl.has_evidence" @click="changeSubControlTabInDrawer('evidence')" :class="{'btn-active': activeSubSideTab==='evidence'}" role="tab" class="tab btn btn-sm btn-ghost bg-base-100">
							<i class="ti ti-check text-success my-auto text-lg mr-1"></i><span x-text="'Evidence ('+selectedSubControl.evidence.length+')'"></span>
						  </button>
						  <button @click="changeSubControlTabInDrawer('comments'); scrollToRecentMessagesInDrawer()" :class="{'btn-active': activeSubSideTab==='comments'}" role="tab" class="tab btn btn-sm btn-ghost bg-base-100" x-text="'Comments ('+messagesForControl.length+')'"></button>
						</div>
					</div>
				</div>
			</div>

			<!-- Scrollable Middle Section -->
			<div id="middle-section" class="flex-1 overflow-y-auto p-4">

	<!--            Control drawer content-->
				<div x-show="!selectedSubControl">
					<div x-show="activeSideTab==='details'" class="card">
						<div class="grid grid-cols-12 gap-4">
						<div class="col-span-full">
							<div x-show="!selectedControl.is_applicable" role="alert" class="alert text-error bg-base-300">
								<i class="ti ti-x text-lg"></i>
								<span class="text-sm">
									This control has been marked as 'Not Applicable'. There are action items here unless the control is set as Applicable.
								</span>
							</div>
						</div>
						<div class="col-span-4">
							<div class="card card-body bg-base-300">
								<div class="card-title">Completion %</div>
								<figure>
									<div
									  :class="{'text-warning': selectedControl.progress_completed<76 && selectedControl.progress_completed>49 , 'text-error': selectedControl.progress_completed<50, 'text-success': selectedControl.progress_completed>75}"
									  class="radial-progress text-sm font-semibold my-2 border-base-100 border-2 mt-6"
									  :style="'--value:' + selectedControl.progress_completed + '; --size: 12rem; --thickness: 2px;'"
									  role="progressbar" x-text="selectedControl.progress_completed+'%'">
									</div>
								</figure>
							</div>
						</div>
						<div class="col-span-8">
							<div class="grid grid-cols-6 gap-6">
								<div class="col-span-2">
									<h4 class="subtitle text-sm">Status</h4>
									<div class="flex flex-row">
										<i :class="{'ti-progress-alert text-warning':selectedControl.status === 'not started', 'ti-toggle-left text-error':selectedControl.status === 'not applicable','ti-progress-bolt text-warning':selectedControl.status === 'in progress','ti-check text-success':selectedControl.status === 'complete' }" class="ti mr-2 my-auto text-lg"></i>
										<p class="capitalize my-auto" x-text="selectedControl.status"></p>
									</div>
								</div>
								<div class="col-span-2">
									<h4 class="subtitle text-sm">Reference Code</h4>
									<p x-text="selectedControl.ref_code"></p>
								</div>
								<div class="col-span-2">
									<h4 class="subtitle text-sm">Applicable</h4>
									<div class="flex flex-row">
										<input x-show="selectedControl.is_applicable" x-model="selectedControl.is_applicable" @change="setAsNotApplicable(selectedControl)" type="checkbox" :class="{'toggle-success':selectedControl.is_applicable}" class="toggle toggle-sm" :checked="selectedControl.is_applicable" />
										<input x-show="!selectedControl.is_applicable" x-model="selectedControl.is_applicable" @change="setAsApplicable(selectedControl)" type="checkbox" :class="{'toggle-success':selectedControl.is_applicable}" class="toggle toggle-sm" :checked="selectedControl.is_applicable" />
									</div>
								</div>
								<div class="col-span-2">
									<h4 class="subtitle text-sm">Completed Subcontrols</h4>
									<div class="flex flex-row gap-x-2">
										<i :class="{
										  'ti-check text-success': selectedControl.stats['subcontrols_complete'] >= selectedControl.stats['applicable_subcontrols'],
										  'ti-alert-triangle text-error': selectedControl.stats['subcontrols_complete'] < selectedControl.stats['applicable_subcontrols']
										}"
										class="ti my-auto"></i>
										<span class="underline underline-offset-4 hover:cursor-pointer" @click="changeControlTab('subcontrols')" x-text="selectedControl.stats['subcontrols_complete']+'/'+selectedControl.stats['applicable_subcontrols']"></span>
										<button @click="changeControlTabInDrawer('subcontrols')" class="btn btn-xs bg-base-100">View<i class="ti ti-arrow-right"></i></button>

									</div>
								</div>
								<div class="col-span-2">
									<h4 class="subtitle text-sm">Auditor Review Status<span data-tip="The auditor will review the control and update the status" class="tooltip ml-2 hover:opacity-75"><i class="ti ti-question-mark"></i></span></h4>
									<div x-show="projectData.auditors.length" class="flex flex-row gap-x-2">
										<div x-show="isAuditor" class="my-auto">
											<i x-show="selectedControl.review_status === 'infosec action'" class="ti ti-progress text-lg text-warning"></i>
											<i x-show="selectedControl.review_status === 'ready for auditor'" class="ti ti-spy text-lg text-error"></i>
											<i x-show="selectedControl.review_status === 'complete'" class="ti ti-check text-success text-lg "></i>
										</div>
										<div x-show="!isAuditor" class="my-auto">
											<i x-show="selectedControl.review_status === 'infosec action'" class="ti ti-progress text-lg text-warning"></i>
											<i x-show="selectedControl.review_status === 'ready for auditor'" class="ti ti-spy text-warning text-lg"></i>
											<i x-show="selectedControl.review_status === 'complete'" class="ti ti-check text-success text-lg "></i>
										</div>
										<span class="capitalize my-auto" x-text="selectedControl.review_status"></span>
										<button x-on:click="changeControlTab('feedback')" class="btn btn-xs bg-base-100">View<i class="ti ti-arrow-right"></i></button>
									</div>
									<div x-show="!projectData.auditors.length" class="flex flex-row gap-x-2">
										<span class="my-auto" x-show="!projectData.auditors.length">No Auditor</span>
										<button @click="closeControlDrawer;switchTab({'tab': 'user management'})" class="btn btn-xs text-warning bg-base-100">Update<i class="ti ti-arrow-right"></i></button>
									</div>

								</div>
								<div class="col-span-2">
									<h4 class="subtitle text-sm">Tags</h4>
									<div class="flex flex-wrap gap-2">
										<template x-for="tag in selectedControl.tags">
											<div class="pill bg-base-300 my-auto hover:cursor-pointer">
												<span class="text-ss" x-text="tag.name"></span>
											</div>
										</template>
									</div>
								</div>
								<div class="col-span-6">
									<h4 class="my-2 subtitle text-sm">Recommended Guidance</h4>
									<span x-show="selectedControl.guidance" x-text="selectedControl.guidance"></span>
									<span x-show="!selectedControl.guidance">This control does not contain any guidance. It is recommended to review and address the subcontrols.</span>
								</div>
							</div>
						</div>

					</div>
					</div>
					<div x-show="activeSideTab==='subcontrols'" class="card">
					  <div role="alert" class="alert bg-base-300 mb-2">
						  <i class="ti ti-alert-triangle text-xs"></i>
						  <p class="text-xs">Open each subcontrol to update the implementation, attach evidence, add comments (etc). When all subcontrols are complete, the control is complete.</p>
					  </div>

					  <table class="table">
						<thead>
						  <tr>
							<th class="bg-base-300 rounded-tl-lg p-6 w-1">Open</th>
							<th class="bg-base-300 p-6">Status</th>
							<th class="bg-base-300 p-6">Subcontrol Title</th>
							<th class="bg-base-300 p-6 w-1">Implemented</th>
							<th class="bg-base-300 p-6 w-1">Evidence</th>
							<th class="bg-base-300 rounded-tr-lg p-6 w-1">Owner</th>
						  </tr>
						</thead>
						<tbody class="bg-base-300">
							<template x-for="subcontrol in selectedControl.subcontrols" :key="subcontrol.id">
							  <tr>
								<td><button @click="openSubControlInDrawer(subcontrol)" class="btn btn-sm btn-ghost"><i class="ti ti-maximize text-lg"></i></button></td>
								<td>
									<div x-show="subcontrol.is_complete && subcontrol.is_applicable" class="text-xs text-success">Complete</div>
									<div x-show="!subcontrol.is_applicable" class="text-xs text-error">Not Applicable</div>
									<div x-show="subcontrol.is_applicable && !subcontrol.is_complete" class="text-xs text-warning">In Progress</div>

								</td>

								<th @click="openSubControlInDrawer(subcontrol)" class="text-xs font-normal hover:cursor-pointer hover:underline hover:opacity-75" x-text="'['+subcontrol.ref_code+'] '+subcontrol.name"></th>
								<td>
									<div class="flex flex-row gap-x-1 justify-center">
										<span class="text-xs font-semibold" x-text="subcontrol.implemented"></span>
										<div class="flex flex-row gap-x-0.5">
										  <div class="flex space-x-1 my-auto">
											  <template x-for="n in idToProgressBarMapping[subcontrol.id].total">
												<div
												  class="flex flex-col flex-nowrap justify-end w-0.5 h-3 bg-neutral-content opacity-90 rounded-full overflow-hidden relative"
												  role="progressbar"
												  :aria-valuenow="n <= idToProgressBarMapping[subcontrol.id].filledBars ? 100 : 0"
												  aria-valuemin="0"
												  aria-valuemax="100">
												  <div
													class="rounded-full overflow-hidden"
													:class="idToProgressBarMapping[subcontrol.id].color"
													:style="`height: ${n <= idToProgressBarMapping[subcontrol.id].filledBars ? '100%' : '0%'}`">
												  </div>
												  <span class="text-xs absolute bottom-0 left-0 right-0 text-center"></span>
												</div>
											  </template>
										  </div>
										</div>
									</div>

								</td>
								<td>
									<div class="text-center">
										<i x-show="subcontrol.has_evidence" class="ti ti-check text-success"></i>
										<i x-show="!subcontrol.has_evidence" class="ti ti-x text-error"></i>
									</div>
								</td>
								<td class="text-center">
									<div class="avatar placeholder">
										<div x-show="subcontrol.owner==='Missing Owner'" class="bg-base-100 text-error w-6 rounded-full">
											<i class="ti ti-alert-triangle"></i>
										</div>
										<div x-show="subcontrol.owner!=='Missing Owner'" class="bg-base-100 w-6 rounded-full">
											<span class="text-ss uppercase" x-text="subcontrol.owner[0]"></span>
										</div>
									</div>
								</td>
							  </tr>
							</template>
						</tbody>
					  </table>

					</div>
					<div x-show="activeSideTab==='auditor'" class="card">

						<div class="grid grid-cols-12 gap-x-4">
							<div x-show="projectData.auditors.length > 0" class="col-span-3 p-4 border-r border-base-100">
								<span class="text-lg mb-2"><i class="ti ti-cardboards mr-2"></i>Review Status</span>
								<div x-show="selectedControl.stats.feedback>0">
									<div x-show="selectedControl.review_status === 'infosec action'" role="alert" class="alert bg-base-100 my-2 text-warning">
										<span class="text-sm">
											Waiting on the InfoSec team to address the feedback.
										</span>
									</div>
									<div x-show="selectedControl.review_status === 'ready for auditor'" role="alert" class="alert bg-base-100 my-2 text-warning">
										<span class="text-sm">
											Waiting on the Auditor to review the responses.
										</span>
									</div>
									<div x-show="selectedControl.review_status === 'complete'" role="alert" class="alert my-2 bg-success">
										<span class="text-sm">
											Review is complete. There are no other action items.
										</span>
									</div>
									<button @click="updateReviewStatus('ready for auditor')" x-show="!isAuditor && selectedControl.review_status === 'infosec action'" class="btn btn-block btn-sm btn-success">Ready for Review</button>
									<div x-show="isAuditor" class="flex flex-col gap-y-4">
										<button :disabled="selectedControl.review_status === 'infosec action'" @click="openReviewModal('infosec action')" class="btn btn-sm btn-warning">Request InfoSec Action</button>
										<button :disabled="selectedControl.review_status === 'complete'" @click="openReviewModal('complete')" :disabled="selectedControl.review_status === 'complete" class="btn btn-sm btn-success">Mark as Complete</button>
									</div>
								</div>
								<div class="mt-4" x-show="selectedControl.stats.feedback===0">
									<div x-show="selectedControl.review_status === 'infosec action'" role="alert" class="alert bg-base-100 my-2 text-warning">
										<span class="text-sm">
											Waiting on the InfoSec team change the status.
										</span>
									</div>
									<div x-show="selectedControl.review_status === 'ready for auditor'" role="alert" class="alert bg-base-100 my-2 text-warning">
										<span class="text-sm">
											Waiting on the Auditor to review the control.
										</span>
									</div>
									<div x-show="selectedControl.review_status === 'complete'" role="alert" class="alert my-2 bg-base-100 text-success">
										<span class="text-sm">
											Review is complete. There are no other action items.
										</span>
									</div>
									<button @click="updateReviewStatus('ready for auditor')" x-show="!isAuditor && selectedControl.review_status === 'infosec action'" class="btn btn-block btn-sm btn-success">Ready for Review</button>
									<div x-show="isAuditor" class="flex flex-col gap-y-4">
										<button :disabled="selectedControl.review_status === 'infosec action'" @click="openReviewModal('infosec action')" class="btn btn-sm btn-warning">Request InfoSec Action</button>
										<button :disabled="selectedControl.review_status === 'complete'" @click="openReviewModal('complete')" :disabled="selectedControl.review_status === 'complete" class="btn btn-sm btn-success">Mark as Complete</button>
									</div>
								</div>
							</div>
							<div :class="{'col-span-9': projectData.auditors.length > 0, 'col-span-12':projectData.auditors.length === 0}">
								<div class="min-h-screen overflow-auto">
									<table x-show="selectedControl.stats.feedback>0" class="table">
										<thead>
										  <tr>
											<th x-show="!isAuditor" class="bg-base-300 rounded-tl-lg p-6 w-1">Open</th>
											<th x-show="isAuditor" class="bg-base-300 rounded-tl-lg p-6 w-1">Review</th>

											<th class="bg-base-300 p-6">Auditor Feedback</th>
											<th class="bg-base-300 rounded-tr-lg p-6 w-1/4">Status</th>
										  </tr>
										</thead>
										<tbody class="bg-base-300">
											<template x-for="feedback in selectedControl.feedback">
											  <tr>
												  <td><button @click="selectedFeedback=feedback;showFeedbackModal=true" class="btn btn-sm btn-ghost"><i class="ti ti-maximize text-lg"></i></button></td>
												  <td class="capitalize" x-text="feedback.title"></td>
												  <td class="capitalize" x-text="feedback.status"></td>
											  </tr>
											</template>
										</tbody>
									</table>

							<div x-show="selectedControl.stats.feedback<1" class="overflow-x-auto">
								<div class="hero mt-16">
								  <div class="hero-content text-center">
									<div x-show="!isAuditor && projectData.auditors.length" class="max-w-full">
									  <h1 class="text-xl font-semibold">No Feedback</h1>
									  <p class="py-2 px-10">The auditor has not created any feedback. There are no action items at this time.</p>
									</div>
									<div x-show="isAuditor" class="max-w-full">
									  <h1 class="text-xl font-semibold">No Feedback</h1>
									  <p class="py-2 px-10">You have not created any feedback for the InfoSec team. Create feedback to provide them with remediation or action items.</p>
									  <button @click="addFeedbackModal=true" class="btn btn-sm btn-success">Create Feedback</button>
									</div>
									<div x-show="!projectData.auditors.length" class="max-w-full">
									  <h1 class="text-xl font-semibold">No Auditors</h1>
									  <p class="py-2 px-10">You have not added an Auditor to this project. Please add one if you would like to utilize Auditor Reviews.</p>
									  <button @click="closeControlDrawer;switchTab({tab: 'user management'})" class="btn btn-sm btn-primary">Add Auditor</button>
									</div>
								  </div>
								</div>
							</div>
						</div>
							</div>
						</div>

					</div>
					<div x-show="activeSideTab==='comments'" class="flex-1 overflow-y-auto">
						<div x-show="messagesForControl.length===0" class="flex-grow hero-content text-center">
							<div class="max-w-md">
							  <h1 class="text-2xl font-semibold mt-10">No Comments</h1>
							  <p class="py-6">
								There are no comments! Start communicating with team members and auditors.
							  </p>
							</div>
						</div>
						<div x-show="messagesForControl.length>0" class="flex-grow overflow-y-auto">
							 <template x-for="message in messagesForControl" :key="message.id">
								<div :class='{"chat-start": isMessageFromAuditor(message), "chat-end": !isMessageFromAuditor(message)}' class="chat">
								  <div @click="deleteControlMessage(message)" @mouseenter="showDeleteControlMessage=true" @mouseleave="showDeleteMessage=false" class="chat-image avatar placeholder cursor-pointer">
									  <div class="bg-neutral text-neutral-content rounded-full w-8">
										<span x-show="!showDeleteControlMessage" class="text-xs uppercase" x-text="message.author_email[0]"></span>
										<span x-show="showDeleteControlMessage" class="text-xs uppercase"><i class='ti ti-trash text-error'></i></span>
									  </div>
								  </div>
								  <div class="chat-header mb-2">
									<span class="text-xs opacity-50 mr-1" x-text="simpleDate(message.date_added)"></span>
									<span x-text="message.author_email"></span>
								  </div>
								  <div class="chat-bubble text-sm" x-text="message.message"></div>
								</div>
							 </template>
						</div>
					</div>
				</div>

	<!--            Subcontrol drawer content-->
				<div x-show="selectedSubControl">
					<div x-show="activeSubSideTab==='details'" class="card p-4">
						<div class="grid grid-cols-10 gap-6">
							<div class="col-span-3">
								<div class="card card-body bg-base-300">
									<div class="card-title">Completion %</div>
									<figure>
										<div
										  :class="{'text-warning': selectedSubControl.progress_completed<76 && selectedSubControl.progress_completed>49 , 'text-error': selectedSubControl.progress_completed<50, 'text-success': selectedSubControl.progress_completed>75}"
										  class="radial-progress text-sm font-semibold my-2 border-base-100 border-2 mt-6"
										  :style="'--value:' + selectedSubControl.progress_completed + '; --size: 12rem; --thickness: 2px;'"
										  role="progressbar" x-text="selectedSubControl.progress_completed+'%'">
										</div>
									</figure>
								</div>

							</div>
							<div class="col-span-7">
								<div x-show="!selectedSubControl.is_applicable" role="alert" class="alert bg-base-300 mb-2 text-error">
									<i class="ti ti-x text-lg"></i>
									<span class="text-sm">
										This subcontrol has been marked as 'Not Applicable'. There are action items here.
									</span>
								</div>
								<div x-show="selectedSubControl.is_applicable && selectedSubControl.is_complete" role="alert" class="alert bg-base-300 text-success mb-2">
									<i class="ti ti-check text-lg"></i>
									<span class="text-sm">
										This subcontrol is complete. There are no other action items.
									</span>
								</div>
								<div class="grid grid-cols-6 gap-4">
									<div class="col-span-6">
										<h4 class="subtitle text-sm">Subcontrol Description</h4>
										<div class="flex flex-row">
											<div x-data="{ expanded: false }"
												 :class="expanded ? 'h-40' : 'h-16'"
												 class="overflow-y-auto">

												<span class="text-xs" x-text="expanded ? (selectedSubControl.guidance || selectedSubControl.description) : (selectedSubControl.guidance || selectedSubControl.description).slice(0, 200) + '...'"></span>

												<button
													x-show="(selectedSubControl.guidance || selectedSubControl.description).length > 100"
													@click="expanded = !expanded"
													class="text-warning underline ml-2 text-xs">
													<span x-text="expanded ? 'See less' : 'See more'"></span>
												</button>
											</div>

										</div>
									</div>
									<div class="col-span-4">
										<h4 class="subtitle text-sm">Status</h4>
										<div class="flex flex-row">
											<p class="my-auto" x-text="selectedSubControl.completion_status"></p>
										</div>
									</div>
									<div class="col-span-2">
										<h4 class="subtitle text-sm">Is Applicable</h4>
										<div class="flex flex-row">
											<input x-model="selectedSubControl.is_applicable" @change="updateSubcontrol(selectedSubControl)" type="checkbox" :class="{'toggle-success':selectedSubControl.is_applicable}" class="toggle toggle-sm" :checked="selectedSubControl.is_applicable" />
										</div>
									</div>
									 <div class="col-span-3">
										<h4 class="subtitle text-sm"><i x-show="selectedSubControl.implemented===0" class="ti ti-alert-triangle text-warning mr-1 my-auto"></i>Implementation Progress</h4>
										<select @change="updateSubcontrol(selectedSubControl)" x-model="selectedSubControl.implemented" class="select w-full select-sm">
										  <option value="0" :selected="parseInt(selectedSubControl.implemented) === 0">Not Implemented</option>
										  <option value="50" :selected="parseInt(selectedSubControl.implemented) > 0 && parseInt(selectedSubControl.implemented) < 100">Partially Implemented</option>
										  <option value="100" :selected="parseInt(selectedSubControl.implemented) === 100">Fully Implemented</option>
										</select>
									</div>
									<div class="col-span-3">
										<div class="flex flex-row">
											<h4 class="subtitle text-sm"><i x-show="!selectedSubControl.owner_id" class="ti ti-alert-triangle text-warning mr-1 my-auto"></i>Owner</h4>
										</div>
										<select @change="updateSubcontrol(selectedSubControl)" x-model="selectedSubControl.owner_id" class="select select-sm w-full">
											<option value="" :selected="selectedSubControl.owner === 'Missing Owner'">Missing Owner</option>
											<template  x-for="user in projectUsers">
												<option :value="user.id" x-text="user.email" :selected="selectedSubControl.owner === user.email"></option>
											</template>
										</select>
									</div>
									<div class="col-span-6">
										<h4 class="subtitle text-sm"><i x-show="!selectedSubControl.context" class="ti ti-alert-triangle text-warning mr-1 my-auto"></i>Implementation Details</h4>
										<textarea rows="5" @change="updateSubcontrol(selectedSubControl)" x-model="selectedSubControl.context" :value="selectedSubControl.context" x-text="selectedSubControl.context" :class="{'border-warning animate-pulse': !selectedSubControl.context && selectedSubControl.implemented>0}" class="textarea w-full" placeholder="Add information about how the subcontrol is satisfied. Provide details on the scope and any context for the auditor."></textarea>
										<p class="text-xs">Note: The implementation details describes how the InfoSec team satisfies the control.</p>
									</div>

								</div>
							</div>
						</div>
					</div>
					<div x-show="activeSubSideTab==='evidence'" class="card p-4">
						<div class="overflow-auto">
							<div class="text-center mt-5" x-show="loadingEvidence">
								<span class="loading loading-dots loading-lg"></span>
							</div>

							<div class="flex flex-col justify-center items-center min-h-[60vh] w-full" x-show="!loadingEvidence && !selectedSubControl.evidence.length">
								<div class="hero w-full h-full">
									<div class="hero-content text-center flex flex-col justify-center w-full h-full">
										<div class="max-w-md mx-auto">
											<h1 class="text-2xl font-bold">No Evidence</h1>
											<p class="py-6">
												No evidence has been uploaded for the subcontrol. Attach existing evidence or create new evidence.
											</p>
											<div class="flex flex-row gap-x-4 justify-center">
												<button class="btn btn-sm bg-base-100" @click="showAttachModal=true;attachEvidence()">Attach Evidence</button>
												<button @click="openCreateEvidenceModal" class="btn btn-sm btn-primary">Add Evidence</button>
											</div>
										</div>
									</div>
								</div>
							</div>


							<div x-show="!loadingEvidence && selectedSubControl.evidence.length">
								<div class="flex justify-between mb-2">
									<h1 class="text-2xl font-semibold">Evidence</h1>
									<div class="flex flex-row gap-x-2">
										<button class="btn btn-sm bg-base-100" @click="showAttachModal=true;attachEvidence()">Attach Evidence</button>
										<button @click="openCreateEvidenceModal" class="btn btn-sm btn-primary">Add Evidence</button>
									</div>
								</div>
								<div class="overflow-x-auto">
									  <table class="table bg-base-100">
										<!-- head -->
										<thead>
										  <tr>
											<th class="w-1 py-6"></th>
											<th>Evidence Name</th>
											<th>Description</th>
											<th class="w-1">Attached File</th>
											<th class="w-2 text-center">Actions</th>
										  </tr>
										</thead>
										<tbody>
											<template x-for="(item, index) in selectedSubControl.evidence">
											  <tr>
												<th></th>
												<td x-text="item.name"></td>
												<td x-text="item.description || 'No description'"></td>
												<td>
													<div x-show="item.file_name" class="flex flex-row gap-x-2">
														<i class="ti ti-download my-auto"></i>
														<a :href="'/api/v1/evidence/'+item.id+'/file'" :download="item.file['name']" class="btn btn-xs bg-base-100" x-text="item.file_name"></a>
													</div>
													<div x-show="!item.file_name">
														No files
													</div>

												</td>
												<td>
													<div class="flex flex-row gap-x-2">
														<button @click="removeEvidenceIndex=item.id;showRemoveEvidenceModal=true" class="btn btn-xs"><i class="ti ti-trash text-error"></i></button>
														<button @click="openEvidence(item)" class="btn btn-xs">View</button>

													</div>
												</td>
											  </tr>
											</template>
										</tbody>
									  </table>
									</div>
							</div>

						</div>

					</div>
					<div x-show="activeSubSideTab==='comments'" class="flex-1 overflow-y-auto">
						<div x-show="messagesForControl.length===0" class="flex-grow min-h-full hero-content text-center">
							<div class="max-w-md">
							  <h1 class="text-2xl font-semibold mt-10">No Comments</h1>
							  <p class="py-6">
								There are no comments! Start communicating with team members and auditors.
							  </p>
							</div>
						</div>
						<div x-show="messagesForControl.length>0" class="flex-grow min-h-full overflow-y-auto control-section">
							 <template x-for="message in messagesForControl" :key="message.id">
								<div :class='{"chat-start": isMessageFromAuditor(message), "chat-end": !isMessageFromAuditor(message)}' class="chat">
								  <div @click="deleteControlMessage(message)" @mouseenter="showDeleteControlMessage=true" @mouseleave="showDeleteMessage=false" class="chat-image avatar placeholder cursor-pointer">
									  <div class="bg-neutral text-neutral-content rounded-full w-8">
										<span x-show="!showDeleteControlMessage" class="text-xs uppercase" x-text="message.author_email[0]"></span>
										<span x-show="showDeleteControlMessage" class="text-xs uppercase"><i class='ti ti-trash text-error'></i></span>
									  </div>
								  </div>
								  <div class="chat-header mb-2">
									<span class="text-xs opacity-50 mr-1" x-text="simpleDate(message.date_added)"></span>
									<span x-text="message.author_email"></span>
								  </div>
								  <div class="chat-bubble text-sm" x-text="message.message"></div>
								</div>
							 </template>
						</div>
					</div>

				</div>

			</div>

			<!-- Sticky Footer -->
			<div class="border-t border-base-300 py-4">
<!--                Control message-->
				<div x-show="!selectedSubControl && activeSideTab==='comments'" class="relative flex">
					<input x-model="controlCurrentMessage" @keyup.enter="createControlMessage" type="text" placeholder="Write your message!" class="w-full input-md border border-base-100 bg-base-300 focus:outline-none pl-6 rounded-md py-3">
					<div class="absolute right-0 items-center inset-y-0 hidden sm:flex">
						<button @click="createControlMessage" :class='{"btn-disabled": !controlCurrentMessage}' class="btn btn-sm btn-success">
						   <span class="font-bold">Send</span>
						   <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-6 w-6 ml-2 transform rotate-90">
							  <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"></path>
						   </svg>
						</button>
					</div>
				</div>

<!--                Subcontrol message-->
				<div x-show="selectedSubControl && activeSubSideTab==='comments'" class="relative flex">
					<input x-model="controlCurrentMessage" @keyup.enter="createControlMessage" type="text" placeholder="Write your message!" class="w-full input-md border border-base-100 bg-base-300 focus:outline-none pl-6 rounded-md py-3">
					<div class="absolute right-0 items-center inset-y-0 hidden sm:flex">
						<button @click="createControlMessage" :class='{"btn-disabled": !controlCurrentMessage}' class="btn btn-sm btn-success">
						   <span class="font-bold">Send</span>
						   <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-6 w-6 ml-2 transform rotate-90">
							  <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"></path>
						   </svg>
						</button>
					</div>
				</div>

			</div>
		</div>
	</div>
</div>

<!--    Drawer to view the selected reports-->
<div class="drawer drawer-end z-50">
	<input @change="closeReportDrawer" id="report-drawer" type="checkbox" class="drawer-toggle" />
	<div class="drawer-content">
	</div>

	<div class="drawer-side">
		<label for="report-drawer" aria-label="close sidebar" class="drawer-overlay"></label>

		<div class="bg-base-200 flex flex-col h-screen w-3/4 px-6">

			<!-- Top Section (Static) -->
			<div class="border-b border-base-300 pt-4">
				<div>
					<div class="p-6 px-4 pb-1 border border-base-300 rounded-lg">
						<div class="flex flex-row gap-x-6">
						<div class="flex flex-row gap-x-2 my-auto">
                        	<span :class="{'bg-primary': selectedReport.status==='new', 'bg-warning': selectedReport.status==='in_progress', 'bg-success': selectedReport.status==='mitigated', 'bg-success opacity-80': selectedReport.status==='accepted'}" class="pill" x-text="selectedReport.status"></span>
						</div>

						<div class="flex justify-between w-full pl-6 border-l">
							<div class="flex flex-col">
								<span class="subtitle text-xs !mb-0" x-text="'Report Title - '+selectedReport.id"></span>
								<span class="text-xl" x-text="selectedReport.title"></span>
							</div>
							<div class="flex flex-row gap-x-2">
								<button @click="copyRiskLink(selectedReport.id)" class="btn btn-sm btn-ghost border border-base-300"><i class="ti ti-share text-xl"></i></button>
								<button @click="closeReportDrawer" class="btn btn-sm btn-ghost border border-base-300"><i class="ti ti-x text-xl"></i></button>

							</div>
						</div>
					</div>
						<div class="grid grid-cols-12 my-6 gap-x-6">
						<div class="col-span-6">
							<div class="flex flex-col mb-2">
								<span class="subtitle text-sm">Risk Description</span>
								<div
								  x-data="{ expanded: false }"
								  class="overflow-y-auto"
								  :class="expanded ? 'h-40' : ''"
								>
								  <span class="text-xs">
									<template x-if="selectedReport.description.length > 500">
									  <p class="font-normal text-xs" x-text="expanded ? selectedReport.description : selectedReport.description.slice(0, 500) + '...'"></p>
									</template>
									<template x-if="selectedReport.description.length <= 500">
									  <p class="font-normal text-xs" x-text="selectedReport.description"></p>
									</template>
								  </span>

								  <button
									x-show="selectedReport.description.length > 500"
									@click="expanded = !expanded"
									class="underline text-ss"
								  >
									<p class="font-normal text-xs" x-text="expanded ? 'See less' : 'See more'"></p>
								  </button>
								</div>
							</div>
						</div>
					</div>
						<div role="tablist" class="tabs gap-x-2">
					  <button @click="changeTabInDrawer('overview')" :class="{'btn-active': activeReportTab==='overview'}" role="tab" class="tab btn btn-sm btn-ghost bg-base-100 text-sm hover:opacity-50">Overview</button>
					  <button @click="changeTabInDrawer('comments'); scrollToRecentMessagesInDrawer()" :class="{'btn-active': activeReportTab==='comments'}" role="tab" class="tab btn btn-sm btn-ghost bg-base-100 text-sm hover:opacity-50" x-text="'Comments ('+riskMessages.length+')'"></button>
					</div>
					</div>
				</div>
			</div>

			<!-- Scrollable Middle Section -->
			<div id="risk-middle-section" class="flex-1 overflow-y-auto p-4">

	<!--            Control drawer content-->
				<div>
					<div x-show="activeReportTab==='overview'" class="card">
						<div class="grid grid-cols-12 gap-4">
							<div class="col-span-4">
								<div class="card card-body border border-base-300">
									<div class="card-title">Risk Level</div>
									<figure>
										<div class="radial-progress text-sm font-semibold my-2 border-base-100 border-2 mt-6 text-error uppercase" :style="'--value:' + selectedReport.risk_level + '; --size: 12rem; --thickness: 2px;'" role="progressbar" x-text="selectedReport.risk"></div>
									</figure>
								</div>
							</div>
							<div class="col-span-8">
								<div class="grid grid-cols-6 gap-2">
									<div class="col-span-2">
										<div class="flex flex-row">
											<h4 class="subtitle text-sm">Risk Status</h4>
										</div>
										<select @change="updateRisk(selectedReport)" x-model="selectedReport.status" class="select select-sm w-full">
											<option value="new" :selected="selectedReport.status === 'new'">New</option>
											<option value="in_progress" :selected="selectedReport.status === 'in_progress'">In Progress</option>
											<option value="accepted" :selected="selectedReport.status === 'accepted'">Accepted</option>
											<option value="mitigated" :selected="selectedReport.status === 'mitigated'">Mitigated</option>
										</select>
									</div>
									<div class="col-span-2">
										<div class="flex flex-row">
											<h4 class="subtitle text-sm">Risk Level</h4>
										</div>
										<select @change="updateRisk(selectedReport)" x-model="selectedReport.risk" class="select select-sm w-full">
											<option value="critical" :selected="selectedReport.risk === 'critical'">Critical</option>
											<option value="high" :selected="selectedReport.risk === 'high'">High</option>
											<option value="moderate" :selected="selectedReport.risk === 'moderate'">Moderate</option>
											<option value="low" :selected="selectedReport.risk === 'low'">Low</option>
											<option value="unknown" :selected="selectedReport.risk === 'unknown'">Unknown</option>

										</select>
									</div>
									<div class="col-span-2">
										<div class="flex flex-row">
											<h4 class="subtitle text-sm"><i x-show="!selectedReport.assignee" class="ti ti-alert-triangle text-warning mr-1 my-auto"></i>Assignee</h4>
										</div>
										<select @change="updateRisk(selectedReport)" x-model="selectedReport.assignee" class="select select-sm w-full">
											<option value="" :selected="selectedReport.assignee === 'Missing Assignee'">Missing Assignee</option>
											<template  x-for="user in tenantUsers">
												<option :value="user.id" x-text="user.email" :selected="selectedReport.assignee === user.id"></option>
											</template>
										</select>
									</div>
									<div class="col-span-6">
										<h4 class="my-2 subtitle text-sm">Risk Description</h4>
										<textarea rows="4" @change="updateRisk(selectedReport)" x-model="selectedReport.description" :value="selectedReport.description" x-text="selectedReport.description" class="textarea w-full" placeholder="No description as been provided."></textarea>
									</div>
									<div class="col-span-6">
										<h4 class="my-2 subtitle text-sm">Risk Remediation</h4>
										<textarea rows="4" @change="updateRisk(selectedReport)" x-model="selectedReport.remediation" :value="selectedReport.remediation" x-text="selectedReport.remediation" class="textarea w-full" placeholder="No remediation as been provided."></textarea>
									</div>
								</div>
							</div>
						</div>
					</div>

					<div x-show="activeReportTab==='comments'" class="flex-1 overflow-y-auto">
						<div x-show="riskMessages.length===0" class="flex-grow hero-content text-center">
							<div class="max-w-md">
							  <h1 class="text-2xl font-semibold mt-10">No Comments</h1>
							  <p class="py-6">
								There are no comments! Start communicating with team members
							  </p>
							</div>
						</div>
						<div x-show="riskMessages.length>0" class="flex-grow overflow-y-auto">
							 <template x-for="message in riskMessages" :key="message.id">
								<div :class='{"chat-start": message.author_email === $store.currentUser.email, "chat-end": message.author_email !== $store.currentUser.email}' class="chat">
								  <div @click="deleteControlMessage(message)" class="chat-image avatar placeholder cursor-pointer">
									  <div class="bg-base-300 rounded-full w-8">
										<span class="text-xs uppercase" x-text="message.author_email[0]"></span>
									  </div>
								  </div>
								  <div class="chat-header mb-2">
									<span class="text-xs opacity-50 mr-1" x-text="simpleDate(message.date_added)"></span>
									<p class="font-normal" x-text="message.author_email"></p>
								  </div>
								  <div class="chat-bubble" x-text="message.message"></div>
								</div>
							 </template>
						</div>
					</div>
				</div>

			</div>

			<!-- Sticky Footer -->
			<div class="border-t border-base-300 py-4">
<!--                Control message-->
				<div x-show="activeReportTab==='comments'" class="relative flex">
					<input x-model="currentMessage" @keyup.enter="createRiskMessage(selectedReport)" type="text" placeholder="Write your message!" class="w-full input-md border border-base-100 bg-base-300 focus:outline-none pl-6 rounded-md py-3">
					<div class="absolute right-0 items-center inset-y-0 hidden sm:flex">
						<button @click="createRiskMessage(selectedReport)" :class='{"btn-disabled": !currentMessage}' class="btn btn-sm btn-success">
						   <span class="font-bold">Send</span>
						   <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-5 w-5 ml-2 transform rotate-90">
							  <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"></path>
						   </svg>
						</button>
					</div>
				</div>

			</div>
		</div>
	</div>
</div>

<!--    Policy drawer-->
	<div class="drawer drawer-end z-50">
	  <input id="policy-drawer" type="checkbox" class="drawer-toggle" />
	  <div class="drawer-content">
		<!-- Page content here -->
	  </div>
	  <div class="drawer-side">
		<label for="policy-drawer" aria-label="close sidebar" class="drawer-overlay"></label>
		<div class="flex flex-col card-body bg-base-200 min-h-full w-1/2">
<!--            Header-->
			<div class="flex-shrink-0">
				<div class="flex items-center justify-between px-3">
				  <h2 class="text-xl font-bold capitalize" x-text="selectedPolicy.name"></h2>
				  <div class="flex items-center space-x-2">
					  <span x-show="selectedPolicy.is_published" class="p-2 rounded-lg text-[10px] bg-base-100 text-success">Published</span>
					  <span x-show="!selectedPolicy.is_published" class="p-2 rounded-lg text-[10px] bg-base-100 text-error">Not Published</span>
				  </div>
				</div>
			</div>
<!--            Body-->
			<div class="flex-1 overflow-y-auto p-4">
				<div class="grid grid-cols-12 gap-4">
					<div class="col-span-6">
						<label class="block text-sm font-medium mb-2">Description</label>
						<textarea x-model="selectedPolicy.description" class="textarea textarea-bordered w-full" placeholder="Provide a description for the policy"></textarea>
					</div>

					<div class="col-span-6">
						<label class="block text-sm font-medium mb-2">Reviewer</label>
						<select x-model="selectedPolicy.reviewer" class="select select-sm select-bordered w-full">
						  <option value="" selected="">Please select...</option>
						  <template x-for="user in projectUsers">
							<option :selected="selectedPolicy.reviewer === user.email" x-text="user.email" :value="user.email"></option>
						  </template>
						</select>
					</div>
				</div>

			</div>
<!--            Bottom navbar-->
			<div class="flex flex-row gap-x-2 border-t border-base-300">
				<button @click="updatePolicy" class="btn btn-warning w-1/2">Update</button>
				<a :href="'/projects/'+projectId+'/policy-center?policy-id='+selectedPolicy.id" class="btn bg-base-100 w-1/2">View Policy<i class="ti ti-arrow-right ml-1 text-xl my-auto"></i></a>
			</div>

		</div>
	  </div>
	</div>

<!--    Evidence drawer-->
	<div class="drawer drawer-end z-50">
	  <input @change="closeEvidenceDrawer" id="evidence-drawer" type="checkbox" class="drawer-toggle" />
	  <div class="drawer-content">
		<!-- Page content here -->
	  </div>
	  <div class="drawer-side">
		<label for="evidence-drawer" aria-label="close sidebar" class="drawer-overlay"></label>
		<div class="flex flex-col card-body bg-base-200 min-h-full w-3/4">
<!--            Header-->
			<div class="flex-shrink-0">
				<div class="flex items-center justify-between px-3">
				  <div class="flex flex-row">
					<div class="breadcrumbs card-title text-xl">
					  <ul>
						<li><a>Evidence</a></li>
						<li><a class="capitalize" x-text="selectedEvidence.name"></a></li>
					  </ul>
					</div>
				  </div>
				  <div class="flex items-center space-x-2"></div>
				</div>
			</div>
<!--            Body-->
			<div class="flex-1 overflow-y-auto p-4">
				<div class="grid grid-cols-12 gap-4">
					<div class="col-span-12">
					   <div class="card bg-base-200 w-full">
						  <div>
							<div x-show="selectedEvidence.controls.length>0" role="alert" class="alert bg-base-100 mb-2">
								<i class="ti ti-alert-triangle text-warning text-lg"></i>
								<span class="text-sm text-warning">
									If you edit or change the evidence below, it will impact all the associated controls.
								</span>
							</div>
							<div class="grid grid-cols-6 gap-x-4">
								<div class="col-span-3">
									<div class="bg-base-100 p-6 rounded-md">
										<div class="grid grid-cols-6 rounded-md gap-y-4 gap-x-2">
											<div class="col-span-6">
											  <label class="block text-sm font-medium mb-2">Evidence Name</label>
											  <input type="text" class="input input-sm text-xs input-bordered w-full" x-model="selectedEvidence.name" placeholder="Provide name for the evidence...">
											</div>
											<div class="col-span-6">
											  <label class="block text-sm font-medium mb-2">Description</label>
											  <textarea class="textarea textarea-sm textarea-bordered w-full" x-model="selectedEvidence.description" placeholder="Add description"></textarea>
											</div>
											<div class="col-span-6">
											  <label class="block text-sm font-medium mb-2">Content</label>
											  <textarea class="textarea textarea-sm textarea-bordered w-full" x-model="selectedEvidence.content" placeholder="Add content"></textarea>
											</div>
											<div class="col-span-6">
												  <div class="flex flex-row gap-x-2">
													<i x-show="!selectedEvidence.file_name" class="ti ti-alert-triangle text-error my-auto"></i>
													<label class="block text-sm font-medium">Evidence File</label>
												  </div>
												  <table x-show="selectedEvidence.file_name" class="table bg-base-200 mt-2">
													<thead>
													  <tr>
														<th class="py-4">Uploaded File</th>
														<th class="py-4">Backend</th>
														<th class="text-center w-1">Actions</th>
													  </tr>
													</thead>
													<tbody>
													  <tr>
														<td class="font-semibold" x-text="selectedEvidence.file_name"></td>
														<td class="font-semibold" x-text="selectedEvidence.file_provider.toUpperCase()"></td>
														<td>
															<div class="flex flex-row gap-x-4">
																<a :href="'/api/v1/evidence/'+selectedEvidence.id+'/file'" :download="selectedEvidence.file['name']" class="btn btn-xs bg-base-100">Download</a>
															</div>
														</td>
													  </tr>
													</tbody>
												  </table>
										   </div>
											<div x-show="!selectedEvidence.file_name" class="col-span-6">
												<input @change="evidenceFile=$event.target.files[0]" type="file" class="file-input file-input-xs w-full bg-base-200" />
											</div>

											<div class="col-span-6">
												<button @click="updateEvidence" class="btn btn-sm btn-warning">Update Evidence</button>
											</div>
										</div>

									</div>
								</div>
								<div class="col-span-3 h-full overflow-y-auto">
								  <div role="alert" class="alert bg-base-100 mb-2">
									  <i class="ti ti-alert-triangle text-warning"></i>
									  <span class="text-sm">Associate subcontrols with the evidence.</span>
									  <div>
										  <button @click="associatedEvidence=selectedEvidence;showAssociationModal=true" class="btn btn-xs text-warning">Edit Association</button>
									  </div>
								  </div>
								  <table class="table">
									<thead>
									  <tr>
										<th class="bg-base-100 p-4 rounded-tl-md"></th>
										<th class="bg-base-100 p-4" x-text="'Associated Subcontrol ('+selectedEvidence.controls.length+')'"></th>
									  </tr>
									</thead>
									<tbody class="bg-base-100 overflow-y-auto">
										<template x-for="(control, index) in selectedEvidence.controls">
										  <tr>
											<td class="text-xs font-semibold" x-text="index+1"></td>
											<td class="text-xs font-semibold" x-text="control.name"></td>
										  </tr>
										</template>
									</tbody>
								  </table>
								</div>
							</div>
						  </div>
						</div>
					</div>
				</div>
			</div>
		</div>
	  </div>
	</div>


	<div :class="{'mb-5': !simpleInterface}" class="grid grid-cols-9 gap-8">
		<div class="col-span-9">
			<div class="lg:flex lg:items-center lg:justify-between">
				<div class="min-w-0 flex-1">
					<div class="breadcrumbs text-lg font-bold sm:tracking-tight py-0">
						<ul>
							<li><a href="{{url_for('main.projects')}}">Home</a></li>
							<li><a href="{{url_for('main.projects')}}">Projects</a></li>
							<li><a class="capitalize" href="{{url_for('main.view_project', pid=project.id)}}">{{project.name}}</a></li>
							<li class="capitalize" x-text="selectedTab"></li>
						</ul>
					</div>

				</div>
				<div class="flex space-x-2">
					<span class="hidden sm:block">
						<button @click="showAuditHelp=true" x-show="isAuditor" class="btn btn-xs mx-2">Auditor<i class="ti ti-spy text-error text-lg"></i></button>
					</span>


					<span x-show="selectedTab==='controls'" class="hidden sm:block">
						<div class="tooltip tooltip-left" data-tip="Toggle Analytics">
							<button @click="toggleDashboard" :class="{'btn-warning': showDashboard}" class="btn btn-xs" x-text="showDashboard ? 'Hide Analytics' : 'Show Analytics'"></button>
						</div>
					</span>					
					<span x-show="selectedTab==='controls'" class="hidden sm:block">
					  <div class="tooltip tooltip-left" data-tip="Refresh data from Server">
						  <button @click="refreshData" :class="{'btn-disabled': disableRefreshBtn}" class="btn btn-xs"><span x-show="disableRefreshBtn" class="loading loading-infinity loading-sm"></span>Refresh Data</button>
					  </div>
					</span>
					<span x-show="selectedTab==='controls'" class="hidden sm:block">
						<button @click="showCreateCustomControlModal=true" class="btn btn-xs btn-primary">Create Control</button>
					</span>
				</div>
			</div>
			<div x-cloak x-show="!simpleInterface" x-transition
				 class="flex flex-row border-b border-base-300 py-1 cursor-pointer">
				<div @click="showMetadataModal=true" class="flex gap-x-1 py-2 pr-2 tooltip" data-tip="Framework">
					<i class="ti ti-frame text-md"></i>
					<span x-transition
					  :class="loadingProjectData ? 'loading loading-spinner loading-xs' : 'font-medium text-xs uppercase'"
					  x-text="loadingProjectData ? '' : projectData.framework">
					</span>
				</div>
				<div class="divider divider-horizontal mx-0 my-1"></div>
				<div @click="showMetadataModal=true" class="flex gap-x-1 py-2 px-2 tooltip hover:opacity-75" data-tip="Completion">
					<span x-transition
					  :class="loadingProjectData ? 'loading loading-spinner loading-xs' : 'font-medium text-xs'"
					  x-text="loadingProjectData ? '' : projectData.completion_progress + '%'">
					</span>
					<progress
					  :class="{
						'progress-error': projectData.completion_progress < 30,
						'progress-warning': projectData.completion_progress >= 30 && projectData.completion_progress < 75,
						'progress-success': projectData.completion_progress >= 75
					  }"
					  class="progress w-40 my-auto"
					  :value="projectData.completion_progress+2"
					  max="100">
					</progress>
					<i
					  :class="{
						'text-error': projectData.completion_progress < 30,
						'text-warning': projectData.completion_progress >= 30 && projectData.completion_progress < 75,
						'text-success': projectData.completion_progress >= 75
					  }"
					  class="ti ti-progress-check text-md">
					</i>
				</div>
				<div class="divider divider-horizontal mx-0 py-1"></div>
				<div class="flex space-x-3 tabs my-auto">
					<template x-for="tab in tabs" :key="tab">
					  <span
							  @click="switchTab({tab: tab})"
							  x-bind:id="'tab-' + tab"
							  class="cursor-pointer rounded-md btn btn-xs bg-base-100 btn-ghost font-medium capitalize px-2"
							  x-bind:class="{ 'bg-base-300': selectedTab === tab }"
							  x-text="tab"
					  ></span>
					</template>
				</div>
			</div>

		</div>
	</div>
	<div x-cloak id="main-body" class="grid grid-cols-6">
			<div class="col-span-full mx-auto mt-10" x-show="tabLoading" x-transition x-html="loadingSkeleton"></div>
			<div class="col-span-full" x-show="selectedTab === 'summary' && !tabLoading">
				<div x-show="projectRefreshRequired" role="alert" class="alert bg-base-200 mb-2">
					<i class="ti ti-alert-triangle text-error text-md"></i>
					<span class="text-xs">Project statistics are out of date. Please click the refresh button.</span>
					<button class="btn btn-xs btn-success" @click="getProject;projectRefreshRequired=false">Refresh Stats</button>
				</div>
				<div class="grid grid-cols-8 gap-4">
					<div class="flex flex-col col-span-2 border bg-base-200 border-base-200 rounded-lg">
					  <div class="p-6">
						<div class="flex items-center gap-x-2 tooltip" data-tip="Status of project">
						  <p class="text-sm font-semibold">
							Project Status
						  </p>
						  <i :class="{'ti-check text-success':projectData.status === 'complete', 'ti-x text-error':projectData.status === 'not started', 'ti-progress text-warning':projectData.status === 'in progress'}" class="ti"></i>
						</div>
						<h3 class="mt-2 text-xl capitalize">
						  <span x-transition
							  :class="loadingProjectData ? 'loading loading-spinner loading-xs' : 'font-semibold'"
							  x-text="loadingProjectData ? '' : projectData.status">
						  </span>
						  <button @click="switchTab({'tab':'controls'})" class="btn btn-sm btn-ghost"><i class="ti ti-external-link my-auto"></i></button>
						</h3>
					  </div>
					</div>
					<div class="flex flex-col col-span-2 border bg-base-200 border-base-200 rounded-lg">
					  <div class="p-6">
						<div class="flex items-center gap-x-2 tooltip" data-tip="% of controls completed">
						  <p class="text-sm font-semibold">
							Project Completion
						  </p>
						  <i :class="{'text-error':projectData.completion_progress===0, 'text-warning':projectData.completion_progress>0 && projectData.completion_progress<100, 'text-success':projectData.completion_progress===100}" class="ti ti-progress-check"></i>
						</div>
						<h3 class="mt-2 text-2xl">
						  <span x-transition
							  :class="loadingProjectData ? 'loading loading-spinner loading-xs' : 'font-semibold'"
							  x-text="loadingProjectData ? '' : projectData.completion_progress">
						  </span>
						  <span class="text-sm opacity-75">/100</span>
						  <button @click="switchTab({'tab':'controls'})" class="btn btn-sm btn-ghost"><i class="ti ti-external-link my-auto"></i></button>
						</h3>
					  </div>
					</div>
					<div class="flex flex-col col-span-2 border bg-base-200 border-base-200 rounded-lg">
					  <div class="p-6">
						<div class="flex items-center gap-x-2 tooltip" data-tip="% of controls implemented">
						  <p class="text-sm font-semibold">
							Controls Implemented
						  </p>
						  <i :class="{'text-error':projectData.implemented_progress===0, 'text-warning':projectData.implemented_progress>0 && projectData.implemented_progress<100, 'text-success':projectData.implemented_progress===100}" class="ti ti-progress-check"></i>
						</div>
						<h3 class="mt-2 text-2xl">
						  <span x-transition
							  :class="loadingProjectData ? 'loading loading-spinner loading-xs' : 'font-semibold'"
							  x-text="loadingProjectData ? '' : projectData.implemented_progress">
						  </span>
						  <span class="text-sm opacity-75">/100</span>
						  <button @click="switchTab({'tab':'controls'})" class="btn btn-sm btn-ghost"><i class="ti ti-external-link my-auto"></i></button>
						</h3>
					  </div>
					</div>
					<div class="flex flex-col col-span-2 border bg-base-200 border-base-200 rounded-lg">
					  <div class="p-6">
						<div class="flex items-center gap-x-2 tooltip" data-tip="% of evidence collected">
						  <p class="text-sm font-semibold">
							Evidence Collected
						  </p>
						  <i :class="{'text-error':projectData.evidence_progress===0, 'text-warning':projectData.evidence_progress>0 && projectData.evidence_progress<100, 'text-success':projectData.evidence_progress===100}" class="ti ti-progress-check"></i>
						</div>
						<h3 class="mt-2 text-2xl">
						  <span x-transition
							  :class="loadingProjectData ? 'loading loading-spinner loading-xs' : 'font-semibold'"
							  x-text="loadingProjectData ? '' : projectData.evidence_progress">
						  </span>
						  <span class="text-sm opacity-75">/100</span>
						  <button @click="switchTab({'tab':'controls'})" class="btn btn-sm btn-ghost"><i class="ti ti-external-link my-auto"></i></button>
						</h3>
					  </div>
					</div>
					<div class="col-span-2 card border border-base-200 shadow-md bg-base-200 mb-20">
						<div class="card-body text-sm">
							<div class="flex flex-row mb-4">
								<i class="ti ti-list-details text-2xl my-auto"></i>
								<h2 class="card-title ml-2 my-auto">Overview</h2>
							</div>

							<div x-transition x-show="loadingProjectData" class="flex flex-col gap-4 w-full">
							  <div class="skeleton h-32 w-full"></div>
							  <div class="skeleton h-4 w-28"></div>
							  <div class="skeleton h-4 w-full"></div>
							  <div class="skeleton h-4 w-full"></div>
							  <div class="skeleton mt-10 h-32 w-full"></div>
							  <div class="skeleton h-4 w-28"></div>
							  <div class="skeleton h-4 w-full"></div>
							  <div class="skeleton h-4 w-full"></div>
							</div>

							<div x-transition x-show="!loadingProjectData">
								<div class="flex flex-col mb-2">
									<span class="font-semibold">Project Name</span>
									<span class="capitalize text-sm" x-text="projectData.name"></span>
								</div>
								<div class="flex flex-col mb-2">
									<span class="font-semibold">Description</span>
									<span class="text-sm" x-text="projectData.description"></span>
								</div>
								<div class="flex flex-row justify-between">
									<div class="flex flex-col mb-2">
										<span class=" font-semibold">Status</span>
										<div class="flex flex-row">
											<i :class="{'ti-check text-success':projectData.status === 'complete', 'ti-x text-error':projectData.status === 'not started', 'ti-progress text-warning':projectData.status === 'in progress'}" class="ti text-lg my-auto"></i>
											<p class="capitalize my-auto ml-2" x-text="projectData.status"></p>
										</div>
									</div>
									<button @click="switchTab({'tab': 'controls'})" class="btn btn-sm btn-ghost"><i class="ti ti-arrow-right my-auto"></i></button>
								</div>
								<div class="flex flex-row justify-between">
									<div class="flex flex-col mb-2">
										<span class=" font-semibold">Framework</span>
										<span class="uppercase text-sm" x-text="projectData.framework"></span>
									</div>
								</div>
								<div class="flex flex-row justify-between">
									<div class="flex flex-col mb-2">
										<span class=" font-semibold">Total Controls</span>
										<span class="capitalize text-sm" x-text="projectData.total_controls"></span>
									</div>
									<button @click="switchTab({'tab': 'controls'})" class="btn btn-sm btn-ghost"><i class="ti ti-arrow-right my-auto"></i></button>
								</div>
								<div class="flex flex-row justify-between">
									<div class="flex flex-col mb-2">
										<span class=" font-semibold">Total Policies</span>
										<span class="capitalize text-sm" x-text="projectData.total_policies"></span>
									</div>
									<button @click="switchTab({'tab': 'policies'})" class="btn btn-sm btn-ghost"><i class="ti ti-arrow-right my-auto"></i></button>
								</div>
								<div class="flex flex-row justify-between">
									<div class="flex flex-col mb-2">
										<span class=" font-semibold mb-2">Auditor Enabled</span>
										<div x-show="projectData.auditor_enabled" class="badge badge-sm rounded-lg badge-success">True</div>
										<div x-show="!projectData.auditor_enabled" class="badge badge-sm rounded-lg badge-error">False</div>
									</div>
									<button @click="switchTab({'tab': 'settings'})" class="btn btn-sm btn-ghost"><i class="ti ti-arrow-right my-auto"></i></button>
								</div>
							</div>

						</div>
					</div>

					<div class="col-span-6 card border border-base-300 shadow-md mb-20">
						<div class="card-body bg-base-200">
							<div class="flex justify-between mb-4">
								<div class="flex flex-row">
									<i class="ti ti-road text-2xl my-auto"></i>
									<h2 x-show="projectData.completion_progress === 0" class="card-title ml-2 my-auto">Project Journey</h2>
									<h2 x-show="projectData.completion_progress !== 0" class="card-title ml-2 my-auto">Project Completion - Past 30 Days</h2>

								</div>
								<button @click="showHelpMenu=true" class="btn btn-sm btn-ghost">Help<i class="ti ti-external-link text-lg ml-2"></i></button>
							</div>
							<div x-transition x-show="loadingProjectData" class="flex flex-col gap-4 w-full">
							  <div class="skeleton h-32 w-full"></div>
							  <div class="skeleton h-4 w-28"></div>
							  <div class="skeleton h-4 w-full"></div>
							  <div class="skeleton h-4 w-full"></div>
							</div>
							<div x-show="!loadingProjectData && projectData.completion_progress !== 0" id="chart"></div>
							<div x-transition x-show="!loadingProjectData && projectData.completion_progress === 0" class="overflow-x-auto">
							  <table class="table">
								<thead>
								  <tr>
									<th class="w-1 bg-base-200 rounded-s-md">#</th>
									<th class="bg-base-200 rounded-s-md">Action Item</th>
									<th class="bg-base-200">Description</th>
									<th class="w-1 bg-base-200">Completed</th>
									<th class="w-1 bg-base-200 rounded-e-md">View</th>
								  </tr>
								</thead>
								<tbody>
									<tr>
										<td class="capitalize font-bold"><i class="ti ti-number-1"></i></td>
										<td class="capitalize font-semibold">Add Members</td>
										<td>Add users to your project for collaboration</td>
										<td><button class="btn btn-ghost">
											<i x-show="projectData.members.length > 1" class="ti ti-check text-success"></i>
											<i x-show="projectData.members.length <= 1" class="ti ti-x text-error"></i>
										</button></td>
										<td><button class="btn btn-sm btn-ghost" @click="switchTab({'tab': 'user management'})"><i class="ti ti-arrow-right text-lg"></i></button></td>
									</tr>
									<tr>
										<td class="capitalize font-bold"><i class="ti ti-number-2"></i></td>
										<td class="capitalize font-semibold">Add Policies</td>
										<td>Add Policies to your project and start editing</td>
										<td><button class="btn btn-ghost">
											<i x-show="policies.length > 0" class="ti ti-check text-success"></i>
											<i x-show="policies.length < 1" class="ti ti-x text-error"></i>
										</button></td>
										<td><button class="btn btn-sm btn-ghost" @click="switchTab({'tab': 'policies'})"><i class="ti ti-arrow-right text-lg"></i></button></td>
									<tr>
										<td class="capitalize font-bold"><i class="ti ti-number-3"></i></td>
										<td class="capitalize font-semibold">Policy Review</td>
										<td>Review and accept policies in your project</td>
										<td><button class="btn btn-ghost">
											<i x-show="policyAcceptance === 'complete'" class="ti ti-check text-success"></i>
											<i x-show="policyAcceptance === 'not started'" class="ti ti-x text-error"></i>
											<i x-show="policyAcceptance === 'in progress'" class="ti ti-progress text-warning"></i>
										</button></td>
										<td><button class="btn btn-sm btn-ghost" @click="switchTab({'tab': 'policies'})"><i class="ti ti-arrow-right text-lg"></i></button></td>
									</tr>
									<tr>
										<td class="capitalize font-bold"><i class="ti ti-number-4"></i></td>
										<td class="capitalize font-semibold">Add Auditor</td>
										<td>Add Auditor to your project</td>
										<td><button class="btn btn-ghost">
											<i x-show="!projectData.auditor_enabled || projectData.auditors.length" class="ti ti-check text-success"></i>
											<i x-show="projectData.auditor_enabled && !projectData.auditors.length" class="ti ti-x text-error"></i>
										</button></td>
										<td><button class="btn btn-sm btn-ghost" @click="switchTab({'tab': 'user management'})"><i class="ti ti-arrow-right text-lg"></i></button></td>
									</tr>
									<tr>
										<td class="capitalize font-bold"><i class="ti ti-number-5"></i></td>
										<td class="capitalize font-semibold">Risk Register</td>
										<td>Add risks to the risk register</td>
										<td><button class="btn btn-ghost">
											<i x-show="risks.length > 0" class="ti ti-check text-success"></i>
											<i x-show="risks.length === 0" class="ti ti-x text-error"></i>
										</button></td>
										<td><button class="btn btn-sm btn-ghost" @click="switchTab({'tab': 'risk register'})"><i class="ti ti-arrow-right text-lg"></i></button></td>
									</tr>
									<tr>
										<td class="capitalize font-bold"><i class="ti ti-number-6"></i></td>
										<td class="capitalize font-semibold">Implement Controls</td>
										<td>Review and assert to controls</td>
										<td><button class="btn btn-ghost"><i :class="{'ti-check text-success':projectData.implemented_progress === 100, 'ti-x text-error':projectData.implemented_progress === 0, 'ti-progress text-warning':projectData.implemented_progress > 0 && projectData.implemented_progress < 100}" class="ti text-lg"></i></button></td>
										<td><button class="btn btn-sm btn-ghost" @click="switchTab({'tab': 'controls'})"><i class="ti ti-arrow-right text-lg"></i></button></td>
									</tr>
									<tr>
										<td class="capitalize font-bold"><i class="ti ti-number-7"></i></td>
										<td class="capitalize font-semibold">Evidence Collection</td>
										<td>Achieve 100% evidence collection by adding evidence to your controls</td>
										<td><button class="btn btn-ghost"><i :class="{'ti-check text-success':projectData.evidence_progress === 100, 'ti-x text-error':projectData.evidence_progress === 0, 'ti-progress text-warning':projectData.evidence_progress > 0 && projectData.evidence_progress < 100}" class="ti text-lg"></i></button></td>
										<td><button class="btn btn-sm btn-ghost" @click="switchTab({'tab': 'controls'})"><i class="ti ti-arrow-right text-lg"></i></button></td>
									</tr>
								</tbody>
							  </table>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="col-span-full" x-show="selectedTab === 'controls' && !tabLoading">
				<div x-transition x-show="rowsSelected.length>0" class="grid grid-cols-12 mb-2">
					<div class="col-span-12 gap-x-2 flex justify-end">
						<span class="my-auto" x-text="'Rows selected: '+rowsSelected.length"></span>
						<div class="my-auto">
						  <details class="dropdown dropdown-bottom dropdown-end">
							  <summary class="btn btn-sm"><i class="ti ti-dots text-lg"></i></summary>
							  <ul class="menu dropdown-content bg-neutral text-neutral-content rounded-box z-[1] w-52 p-2 shadow">
								  <li><a @click="toggleAllRows(true)"><i class="ti ti-checks mr-1 text-success"></i>Select all</a></li>
								  <li><a @click="deselectedAllRows"><i class="ti ti-x mr-1 text-error"></i>Deselect all</a></li>
								  <li><a @click="showUpdateAssigneeModal = true"><i class="ti ti-user mr-1"></i>Update Assignee</a></li>
								  <li><a @click="showSetApplicableModal = true"><i class="ti ti-check mr-1"></i>Set Applicable</a></li>
								  <li><a @click="showSetNotApplicableModal = true"><i class="ti ti-x mr-1"></i>Set Not Applicable</a></li>
								  <li><a @click="showSetTagsModal = true"><i class="ti ti-tag mr-1"></i>Set Tags</a></li>
							  </ul>
						  </details>
					  </div>						
					</div>
				</div>

				<div class="hero bg-base-200 rounded-lg min-h-screen" x-show="loadingControls">
				  <div class="hero-content text-center mb-20">
					<div class="max-w-md">
						<span class="loading loading-dots loading-lg"></span>
						<p class="py-6 font-semibold" x-text="loadingControlsMessage"></p>
					</div>
				  </div>
				</div>
				<div x-show="showDashboard" class="grid grid-cols-12">
					<div class="col-span-12">
						<div class="card bg-base-200 rounded-lg">
							<div class="card-body">
								<h2 class="card-title">Analytics for Controls</h2>
								<div class="grid grid-cols-12 gap-4">
									<div class="col-span-6">
										<div class="card-body bg-base-100 rounded-lg">
											<h2 class="card-title">Controls Status</h2>
											<div id="statusChart" x-ref="statusChart"></div>
										</div>
									</div>
									<div class="col-span-6">
										<div class="card-body bg-base-100 rounded-lg">
											<h2 class="card-title">Subcontrols Complete</h2>
											<div id="subcontrolsCompleteChart" x-ref="subcontrolsCompleteChart"></div>
										</div>
									</div>
									<div class="col-span-6">
										<div class="card-body bg-base-100 rounded-lg">
											<h2 class="card-title">Implementation Status</h2>
											<div id="implementationStatusChart" x-ref="implementationStatusChart"></div>
										</div>
									</div>
									<div class="col-span-6">
										<div class="card-body bg-base-100 rounded-lg">
											<h2 class="card-title">Evidence Status</h2>
											<div id="evidenceStatusChart" x-ref="evidenceStatusChart"></div>
										</div>
									</div>									
								</div>
							</div>
						</div>
					</div>
				</div>
				<div x-show="view === 'default' && !loadingControls && !showDashboard" class="grid grid-cols-12 h-screen">
					<!-- Filter column-->
					<div x-show="expandedRow===null" :class="{'col-span-1': hideFilterTab, 'col-span-3': !hideFilterTab}" class="rounded-tl-md border-y border-l border-base-300 bg-base-200 mb-16">
						<div :class="{'border-r border-base-300': !hideFilterTab}" class="p-3 mb-16">
							<div :class="{'mx-auto': hideFilterTab, 'px-6 pt-2': !hideFilterTab}" class="flex my-auto justify-between">
								<h3 class="card-title" x-show="!hideFilterTab"><i x-show="Object.keys(controlFilter).length>0" @click="controlFilter={}" class="ti ti-x text-error my-auto hover:opacity-75 hover:cursor-pointer"></i>Apply Filters</h3>
								<div class="flex flex-row gap-x-2">
									<button x-show="!hideFilterTab" @click="copyLink()" class="btn btn-sm btn-ghost"><i class="ti ti-share text-lg"></i></button>
									<button x-show="!hideFilterTab" @click="hideFilterTab=!hideFilterTab" class="btn btn-sm btn-ghost"><i class="ti ti-arrow-bar-to-left text-xl"></i></button>
									<button x-show="hideFilterTab" @click="hideFilterTab=!hideFilterTab" class="btn btn-md btn-ghost ml-4"><i :class="{'text-error': Object.keys(controlFilter).length>0}" class="ti ti-filter-plus text-2xl mx-auto opacity-75"></i></button>
								</div>

							</div>
							<div x-show="!hideFilterTab" class="bg-base-200 rounded-lg h-full overflow-y-scroll scrollbar">
								<ul class="menu bg-base-200 rounded-box py-0 mt-0">
								  <li>
									<div class="menu-title text-xs flex justify-between">
										<h2>Control title</h2>
										<i x-show="controlFilter.name" @click="delete controlFilter.name" class="ti ti-x text-error hover:cursor-pointer hover:opacity-75"></i>
									</div>
									<ul class="font-semibold text-xs pr-2">
									  <li>
										<label :class="{'border-error':controlFilter.name}" class="input input-xs flex items-center gap-2">
										  <input x-model="controlFilter.name" type="text" class="grow" placeholder="Search..." />
										  <svg
											xmlns="http://www.w3.org/2000/svg"
											viewBox="0 0 16 16"
											fill="currentColor"
											class="h-4 w-4 opacity-70">
											<path
											  fill-rule="evenodd"
											  d="M9.965 11.026a5 5 0 1 1 1.06-1.06l2.755 2.754a.75.75 0 1 1-1.06 1.06l-2.755-2.754ZM10.5 7a3.5 3.5 0 1 1-7 0 3.5 3.5 0 0 1 7 0Z"
											  clip-rule="evenodd" />
										  </svg>
										</label>
									  </li>
									</ul>
								  </li>
								</ul>
								<ul class="menu bg-base-200 rounded-box py-0 mt-0">
								  <li>
									<div class="menu-title text-xs flex justify-between">
										<h2>Owner</h2>
										<i x-show="controlFilter.owner" @click="delete controlFilter.owner" class="ti ti-x my-auto text-error hover:cursor-pointer hover:opacity-75"></i>
									</div>
									<ul class="font-semibold text-xs pr-2">
										<select :class="{'border-error':controlFilter.owner}" @change="changeControlOwnerFilter" x-model="controlOwner" class="select select-xs w-full max-w-xs">
											<option value="all_users" :selected="!controlFilter.owner">All Users</option>
											<template x-for="user in projectUsers">
												<option :value="user.email" :selected="user.email===controlFilter.owner" x-text="user.email"></option>
											</template>
										</select>
									</ul>
								  </li>
								</ul>
								<ul class="menu bg-base-200 rounded-box py-0 mt-0">
								  <li>
									<div class="menu-title text-xs flex justify-between">
										<h2>Status</h2>
										<i x-show="controlFilter.status" @click="delete controlFilter.status" class="ti ti-x my-auto text-error hover:cursor-pointer hover:opacity-75"></i>
									</div>
									<ul class="font-semibold text-xs">
									  <li @click="controlFilter.status='applicable'"><div :class="{'text-error-content bg-error opacity-80':controlFilter.status==='applicable'}" class="flex justify-between px-2"><span class="text-xs"><i class="ti ti-circle-dotted text-success text-xs mr-1"></i>Applicable</span><span class="text-xs" x-text="controlStatuses['applicable']"></span></div></li>
									  <li @click="controlFilter.status='not applicable'"><div :class="{'text-error-content bg-error opacity-80':controlFilter.status==='not applicable'}" class="flex justify-between px-2"><span class="text-xs"><i class="ti ti-x text-error text-xs mr-1"></i>Not Applicable</span><span class="text-xs" x-text="controlStatuses['not applicable']"></span></div></li>
									  <li @click="controlFilter.status='not started'"><div :class="{'text-error-content bg-error opacity-80':controlFilter.status==='not started'}" class="flex justify-between px-2"><span class="text-xs"><i class="ti ti-lock-access-off text-neutral-content text-xs mr-1"></i>Not Started</span><span class="text-xs" x-text="controlStatuses['not started']"></span></div></li>
									  <li @click="controlFilter.status='in progress'"><div :class="{'text-error-content bg-error opacity-80':controlFilter.status==='in progress'}" class="flex justify-between px-2"><span class="text-xs"><i class="ti ti-progress text-warning text-xs mr-1"></i>In Progress</span><span class="text-xs" x-text="controlStatuses['in progress']"></span></div></li>
									  <li @click="controlFilter.status='complete'"><div :class="{'text-error-content bg-error opacity-80':controlFilter.status==='complete'}" class="flex justify-between px-2"><span class="text-xs"><i class="ti ti-check text-success text-xs mr-1"></i>Complete</span><span class="text-xs" x-text="controlStatuses['complete']"></span></div></li>
									</ul>
								  </li>
								</ul>
								<ul x-show="projectData.auditors.length===0" class="menu bg-base-200 rounded-box py-0 mt-0">
								  <li>
									<div class="menu-title text-xs flex justify-between">
										<h2>Auditor Review</h2>
										<i x-show="controlFilter.review_status" @click="delete controlFilter.review_status" class="ti ti-x my-auto text-error hover:cursor-pointer hover:opacity-75"></i>
									</div>
									<ul class="font-semibold text-xs">
									  <li @click="controlFilter.review_status='infosec action'"><div :class="{'text-error-content bg-error opacity-80':controlFilter.review_status==='infosec action'}" class="flex justify-between px-2"><span class="text-xs"><i class="ti ti-spy text-error text-xs mr-1"></i>Waiting on InfoSec</span><span class="text-xs" x-text="controlReviewStatuses['infosec action']"></span></div></li>
									  <li @click="controlFilter.review_status='ready for auditor'"><div :class="{'text-error-content bg-error opacity-80':controlFilter.review_status==='ready for auditor'}" class="flex justify-between px-2"><span class="text-xs"><i class="ti ti-spy text-warning text-xs mr-1"></i>Ready for Auditor Review</span><span class="text-xs" x-text="controlReviewStatuses['ready for auditor']"></span></div></li>
									  <li @click="controlFilter.review_status='complete'"><div :class="{'text-error-content bg-error opacity-80':controlFilter.review_status==='complete'}" class="flex justify-between px-2"><span class="text-xs"><i class="ti ti-spy text-success text-xs mr-1"></i>Complete</span><span class="text-xs" x-text="controlReviewStatuses['complete']"></span></div></li>
									</ul>
								  </li>
								</ul>
								<ul class="menu bg-base-200 rounded-box pt-0 mt-0">
								  <li>
									<div class="menu-title text-xs flex justify-between">
										<h2>Implemented Status</h2>
										<i x-show="controlFilter.implemented_status" @click="delete controlFilter.implemented_status" class="ti ti-x my-auto text-error hover:cursor-pointer hover:opacity-75"></i>
									</div>
									<ul class="font-semibold text-xs">
									  <li @click="controlFilter.implemented_status='not implemented'"><div :class="{'text-error-content bg-error opacity-80':controlFilter.implemented_status==='not implemented'}" class="flex justify-between px-2"><span class="text-xs"><i class="ti ti-lock-access-off text-error text-xs mr-1"></i>Not Implemented</span><span class="text-xs" x-text="implementedStatuses['not implemented']"></span></div></li>
									  <li @click="controlFilter.implemented_status='partially implemented'"><div :class="{'text-error-content bg-error opacity-80':controlFilter.implemented_status==='partially implemented'}" class="flex justify-between px-2"><span class="text-xs"><i class="ti ti-lock-open-2 text-warning text-xs mr-1"></i>Partially Implemented</span><span class="text-xs" x-text="implementedStatuses['partially implemented']"></span></div></li>
									  <li @click="controlFilter.implemented_status='fully implemented'"><div :class="{'text-error-content bg-error opacity-80':controlFilter.implemented_status==='fully implemented'}" class="flex justify-between px-2"><span class="text-xs"><i class="ti ti-lock text-success text-xs mr-1"></i>Fully Implemented</span><span class="text-xs" x-text="implementedStatuses['fully implemented']"></span></div></li>
									</ul>
								  </li>
								</ul>
								<ul class="menu bg-base-200 rounded-box pt-0 mt-0">
								  <li>
									<div class="menu-title text-xs flex justify-between">
										<h2>Evidence Status</h2>
										<i x-show="controlFilter.evidence_status" @click="delete controlFilter.evidence_status" class="ti ti-x my-auto text-error hover:cursor-pointer hover:opacity-75"></i>
									</div>
									<ul class="font-semibold text-xs">
									  <li @click="controlFilter.evidence_status='no evidence'"><div :class="{'text-error-content bg-error opacity-80':controlFilter.evidence_status==='no evidence'}" class="flex justify-between px-2"><span class="text-xs"><i class="ti ti-file-text text-error text-xs mr-1"></i>No Evidence</span><span class="text-xs" x-text="evidenceStatus['no evidence']"></span></div></li>
									  <li @click="controlFilter.evidence_status='partial evidence'"><div :class="{'text-error-content bg-error opacity-80':controlFilter.evidence_status==='partial evidence'}" class="flex justify-between px-2"><span class="text-xs"><i class="ti ti-file-text text-warning text-xs mr-1"></i>Partial Evidence</span><span class="text-xs" x-text="evidenceStatus['partial evidence']"></span></div></li>
									  <li @click="controlFilter.evidence_status='full evidence'"><div :class="{'text-error-content bg-error opacity-80':controlFilter.evidence_status==='full evidence'}" class="flex justify-between px-2"><span class="text-xs"><i class="ti ti-file-text text-success text-xs mr-1"></i>Full Evidence</span><span class="text-xs" x-text="evidenceStatus['full evidence']"></span></div></li>

									</ul>
								  </li>
								</ul>
								<ul class="menu bg-base-200 rounded-box pt-0 mt-0">
								  <li>
									<div class="menu-title text-xs flex justify-between">
										<h2>Control Tags</h2>
										<i x-show="controlFilter.tags" @click="delete controlFilter.tags" class="ti ti-x my-auto text-error hover:cursor-pointer hover:opacity-75"></i>
									</div>
									<ul class="font-semibold text-xs">
										<label class="input input-bordered input-xs flex items-center gap-2">
										  <input @keydown.enter="addTag" x-model="tempTagName" type="text" class="grow" placeholder="Filter by Tag..." />
										  <button @click="addTag" class="btn btn-xs btn-ghost">Add</button>
										</label>
										<div class="flex flex-row gap-x-1 w-full mt-2">
											<template x-for="tag in controlFilter.tags">
												<div @click="removeTag(tag)" class="flex flex-row gap-x-1 bg-base-100 p-1 rounded-lg hover:opacity-50 hover:cursor-pointer">
													<span class="text-[8px]" x-text="tag"></span>
													<i class="ti ti-x text-error text-xs my-auto"></i>
												</div>
											</template>
										</div>

									</ul>
								  </li>
								</ul>
							</div>
						</div>

					</div>

					<!-- Show when there are no controls -->

					<div x-show="controls.length === 0">
						In progress
					</div>

					<!-- Show when there are filtered controls to show -->
					<div x-show="!filteringControls && !emptyControlFilter" :class="{'col-span-11': hideFilterTab, 'col-span-9': !hideFilterTab}" class="overflow-y-auto bg-base-200 border rounded-tr-md border-base-300 mb-16">

						<table x-data="{'headerCount': 5}" class="table sticky mb-16">
							<!-- Table Header -->
							<thead class="sticky top-0 z-10 border-b">
							  <tr>								
								<th class="p-4 bg-base-200 py-6 pl-4">
									<label>
									  <input x-ref="selectAllCheckbox" @click="toggleAllRows($el.checked)" type="checkbox" class="checkbox checkbox-xs mt-1" />
									</label>
								  </th>
								<th :class="{'rounded-tl-md': expandedRow!==null}" class="bg-base-200 border-base-300 p-6 text-xs border-b border-base-100">
									<div class="flex justify-between">
										<span class="my-auto">View</span>
									</div>
								</th>
								<th class="bg-base-200 p-6 text-xs border-b border-base-300">
									<div class="flex justify-between">
										<span class="my-auto" x-text="'Control Title ('+filteredControls.length+')'"></span>
									</div>
								</th>
								<th class="bg-base-200 p-6 text-xs border-b border-base-100 w-2/12 text-center border-base-300">
									<div class="flex justify-between">
										<span class="my-auto">Status</span>
									</div>
								</th>
								<th class="bg-base-200 p-6 text-xs border-b border-base-100 w-1 text-center border-base-300">
									<div class="flex justify-between">
										<span class="my-auto" x-text="'Subcontrols ('+filteredSubControls.length+')'"></span>
									</div>
								</th>
								<th x-show="projectData.auditors.length>0" class="bg-base-200 border-base-300 rounded-tr-md p-6 text-xs border-b border-base-100 w-1 text-center">
									<span class="my-auto">Review Status</span>
								</th>
								<th x-show="projectData.auditors.length===0" class="bg-base-200 border-base-300 rounded-tr-md p-6 text-xs border-b border-base-100 w-1 text-center">
									<span class="my-auto">Owner(s)</span>
								</th>

							  </tr>
							</thead>

							<!-- Table Body -->
							<tbody class="bg-base-200">
							  <template x-for="(item, index) in filteredControls" :key="item.id">
								<tr :id="'row-'+item.id" :class="{'opacity-50': previouslySelectedRowId === item.id}">
								  <th>
								    <div class="my-auto mt-1">
									  <input :checked="rowsSelected.includes(item.id)" @change="toggleRow($event.target.checked, item.id)" type="checkbox" class="checkbox checkbox-xs"/>
								    </div>
								  </th>									
								  <td>
									<div @click="openControlInDrawer(item)" class="badge badge-ghost rounded-md font-semibold gap-x-2 w-full hover:cursor-pointer hover:opacity-50 justify-start">
										<i x-show="selectedControl !== item" class="ti ti-arrow-badge-right text-xl"></i>
										<i x-show="selectedControl === item" class="ti ti-arrow-badge-left text-xl"></i>

										<span class="text-xs" x-text="item.progress_completed"></span>
										<div class="flex flex-row gap-x-0.5">
										  <div class="flex space-x-1">
											  <template x-for="n in idToProgressBarMapping[item.id].total">
												<div
												  class="flex flex-col flex-nowrap justify-end w-0.5 h-3 bg-neutral-content opacity-90 rounded-full overflow-hidden relative"
												  role="progressbar"
												  :aria-valuenow="n <= idToProgressBarMapping[item.id].filledBars ? 100 : 0"
												  aria-valuemin="0"
												  aria-valuemax="100">
												  <div
													class="rounded-full overflow-hidden"
													:class="idToProgressBarMapping[item.id].color"
													:style="`height: ${n <= idToProgressBarMapping[item.id].filledBars ? '100%' : '0%'}`">
												  </div>
												  <span class="text-xs absolute bottom-0 left-0 right-0 text-center"></span>
												</div>
											  </template>
										  </div>
										</div>
									</div>
								  </td>
								  <td colspan="1">
									<div class="flex rounded-t-lg">
									  <div @click="openControlInDrawer(item)" class="flex-1 text-xs p-4 font-semibold my-auto hover:underline hover:cursor-pointer" x-text="item.ref_code+' - '+item.name"></div>
									</div>
								  </td>
								  <td class="capitalize font-semibold text-center">
									  <span x-show="item.status === 'not applicable'" class="px-2 py-2 rounded-lg text-[9px] uppercase text-error bg-base-100" x-text="item.status"></span>
									  <span x-show="item.status === 'not started'" class="px-2 py-2 rounded-lg text-[9px] uppercase bg-base-100" x-text="item.status"></span>
									  <span x-show="item.status === 'in progress'" class="px-2 py-2 rounded-lg text-[9px] uppercase text-warning bg-base-100" x-text="item.status"></span>
									  <span x-show="item.status === 'complete'" class="px-2 py-2 rounded-lg text-[9px] uppercase text-success bg-base-100" x-text="item.status"></span>

								  </td>
								  <td class="capitalize font-semibold text-center">
									  <div @click="openControlInDrawer(item, tab='subcontrols')" class="inline-flex flex-row gap-x-1 px-2 py-1 font-semibold justify-center bg-base-100 text-[9px] rounded-lg mx-auto hover:cursor-pointer hover:opacity-75">
										  <span class="my-auto" x-show="item.status === 'complete'"><i class="ti ti-check text-success"></i></span>
										  <span class="text-[10px]" x-text="item['stats']['subcontrols_complete']"></span>
										  <span class="text-[10px]">/</span>
										  <span class="text-[10px]" x-text="item['stats']['applicable_subcontrols']"></span>
									  </div>
								  </td>
								  <td class="capitalize font-semibold text-center">
									  <div @click="openControlInDrawer(item, tab='subcontrols')" class="hover:cursor-pointer hover:opacity-75" x-show="item.stats.owners===0">
										  <div x-show="projectData.auditors.length<1">
											  <div class="avatar placeholder">
												<div class="bg-base-100 w-8 rounded-full">
													<i class="ti ti-alert-triangle"></i>
												</div>
											  </div>
										  </div>
										  <div x-show="projectData.auditors.length>0">
											<span :class="{'text-success': item.review_status === 'complete','text-error': item.review_status === 'infosec action'}" x-show="!isAuditor" x-text="item.review_status" class="px-2 py-2 rounded-lg text-[9px] uppercase bg-base-100"></span>
											<span :class="{'text-success': item.review_status === 'complete','text-error': item.review_status === 'ready for auditor'}" x-show="isAuditor" x-text="item.review_status" class="px-2 py-2 rounded-lg text-[9px] uppercase bg-base-100"></span>

										  </div>
									  </div>
									  <div @click="openControlInDrawer(item, tab='subcontrols')" class="hover:cursor-pointer hover:opacity-75" x-show="item.stats.owners>0">
										  <div x-show="projectData.auditors.length<1">
											  <div class="avatar placeholder">
												<div class="bg-base-100 w-8 rounded-full">
													<span class="text-xs" x-text="item.stats.owners+'+'"></span>
												</div>
											  </div>
										  </div>
										  <div x-show="projectData.auditors.length>0">
											<span :class="{'text-success': item.review_status === 'complete','text-error': item.review_status === 'infosec action'}" x-show="!isAuditor" x-text="item.review_status" class="px-2 py-2 rounded-lg text-[9px] uppercase bg-base-100"></span>
											<span :class="{'text-success': item.review_status === 'complete','text-error': item.review_status === 'ready for auditor'}" x-show="isAuditor" x-text="item.review_status" class="px-2 py-2 rounded-lg text-[9px] uppercase bg-base-100"></span>
										  </div>
									  </div>
								  </td>
								</tr>

							  </template>
							</tbody>
						</table>
					</div>

					<!-- Show when loading the filtered controls -->
					<div x-show="filteringControls" :class="{'col-span-11': hideFilterTab, 'col-span-9': !hideFilterTab}" class="overflow-y-auto bg-base-200">
						<div class="hero bg-base-200 rounded-lg min-h-screen">
						  <div class="hero-content text-center mb-20">
							<div class="max-w-md">
								<span class="loading loading-dots loading-lg"></span>
								<p class="py-6 font-semibold" x-text="loadingControlsMessage"></p>
							</div>
						  </div>
						</div>
					</div>

					<!-- Show when there are no filtered controls -->
					<div x-show="!filteringControls && emptyControlFilter" :class="{'col-span-11': hideFilterTab, 'col-span-9': !hideFilterTab}" class="overflow-y-auto bg-base-200">
						<div class="hero bg-base-200 rounded-lg min-h-screen">
						  <div class="hero-content text-center mb-20">
							<div class="max-w-md">
								<i class="ti ti-alert-triangle text-error text-3xl"></i>
								<p class="py-6 font-semibold">No controls match the filter</p>
							</div>
						  </div>
						</div>
					</div>
				</div>
			</div>

			<div class="col-span-6" x-show="selectedTab === 'policies' && !tabLoading">

				<div class="card border border-base-200 bg-base-200">
					<div class="card-body">
						<div class="flex justify-between align-items-center">
							<h2 class="card-title" x-text="'Project Policies ('+policies.length+')'"></h2>
							<div class="flex flex-row gap-x-2">
								<div class="space-x-2 flex">
									<a :href="'/projects/'+projectId+'/policy-center?create=true'" class="btn btn-xs capitalize btn-ghost text-success bg-base-100 text-xs"
											 >Add Policy</a>
									<a :href="'/projects/'+projectId+'/policy-center'" class="btn btn-xs capitalize btn-ghost bg-base-100 text-xs"
											 >Policy Center</a>
								</div>
							</div>
						</div>
						<div x-show="!policies.length" class="grid grid-cols-4 text-center">
						  <div class="col-span-full hero-content text-center">
							<div class="max-w-md">
							  <h1 class="text-2xl font-bold">No Policies</h1>
							  <p class="py-6">
								You have not added any policies to you project. Let's add some, make edits and publish them.
							  </p>
							  <button @click="showAddPolicy=true" class="btn btn-sm btn-primary">Add Policy</button>
							</div>
						  </div>
						</div>
						<div x-show="policies.length" class="grid grid-cols-4">
							<div class="col-span-4">
								<table class="table">
								<!-- Table Header -->
								<thead class="border-b">
								  <tr>
									<th class="bg-base-200 rounded-tl-md p-2 text-xs border-b border-base-100 w-1">View</th>
									<th class="bg-base-200 p-2 text-xs border-b border-base-100">Policy Title</th>
									<th class="bg-base-200 p-2 text-xs border-b border-base-100 w-2/12">Published</th>
									<th class="bg-base-200 p-2 text-xs border-b border-base-100 w-2/12">Reviewer</th>
									<th class="bg-base-200 p-2 rounded-tr-md text-xs border-b border-base-100 w-1">Versions</th>
								  </tr>
								</thead>
								<!-- Table Body -->
								<tbody class="bg-base-200">
								  <template x-for="item in policies" :key="item.id">
									<tr>
										<td>
											<button @click="openPolicyDrawer(item)" class="btn btn-xs btn-ghost"><i class="ti ti-maximize text-lg"></i></button>
										</td>
										<td class="capitalize" x-text="item.name"></td>
										<td>
											<span x-show="!item.is_published" class="p-2 rounded-lg text-[10px] uppercase bg-base-100 text-warning">False</span>
											<span x-show="item.is_published" class="p-2 rounded-lg text-[10px] uppercase bg-base-100 text-success">True</span>
										</td>
										<td x-text="item.reviewer ||  'No reviewer'"></td>
										<td>
											<span class="p-2 rounded-lg text-[10px] uppercase bg-base-100" x-text="item.versions.length"></span>
										</td>
									</tr>
								  </template>
								</tbody>
							</table>
							</div>

						</div>


					</div>
				</div>

			</div>
			<div class="col-span-6" x-show="selectedTab === 'comments' && !tabLoading">
				<div class="card bg-base-200">
					<div class="card-body">
						<div class="flex justify-between align-items-center">
							<h2 class="card-title" x-text="'Project Comments ('+messages.length+')'"></h2>
							<div class="flex flex-row gap-x-2">
								<div class="space-x-2 flex">
									<button class="btn btn-sm text-success tooltip"
											@click="loadComments" data-tip="Refresh comments"><i class="ti ti-refresh"></i>
									</button>
								</div>
							</div>
						</div>
					   <div id="messageDiv" class="flex flex-col py-6 pt-4 px-10 overflow-y-auto h-96 bg-base-200 rounded-lg">

						 <div x-transition x-show="loadingProjectData" class="flex flex-col gap-4 w-full">
							  <div class="skeleton h-32 w-full"></div>
							  <div class="skeleton h-4 w-28"></div>
							  <div class="skeleton h-4 w-full"></div>
							  <div class="skeleton h-4 w-full"></div>
						 </div>

						 <div class="text-xl font-semibold mx-auto my-auto" x-show="!loadingProjectData && messages.length === 0">No comments!</div>
						 <template x-for="message in messages" :key="message.id">
							<div :class='{"chat-start": isMessageFromAuditor(message), "chat-end": !isMessageFromAuditor(message)}' class="chat">
							  <div @click="deleteMessage(message)" @mouseenter="showDeleteMessage=true" @mouseleave="showDeleteMessage=false" class="chat-image avatar placeholder cursor-pointer">
								  <div class="bg-neutral text-neutral-content rounded-full w-8">
									<span x-show="!showDeleteMessage" class="text-xs uppercase" x-text="message.author_email[0]"></span>
									<span x-show="showDeleteMessage" class="text-xs uppercase"><i class='ti ti-trash text-error'></i></span>
								  </div>
							  </div>
							  <div class="chat-header mb-2">
								<span class="text-xs opacity-50 mr-1" x-text="simpleDate(message.date_added)"></span>
								<span x-text="message.author_email"></span>
							  </div>
							  <div class="chat-bubble text-sm" x-html="formatComment(message.message)"></div>
							</div>
						 </template>
					   </div>
							<div x-data="mentions()" x-init="setInput($refs.textarea)" class="w-full relative" @click.outside="onBlur">
								<div class="relative flex">
									 <textarea x-model="currentMessage" class="w-full text-sm bg-base-200 border-2 border-base-300 shadow-lg px-3 py-2 rounded-lg focus:outline-none focus:border-primary" rows="2" placeholder="Type @ to tag users and # to tag controls" @input="onInput" @keydown="onKeyDown" @keyup="onKeyUp" @scroll="onScroll" x-ref="textarea"></textarea>
									 <div class="absolute right-4 items-center inset-y-0 hidden sm:flex">
										<button @click="createMessage" :class='{"btn-disabled": !currentMessage}' class="btn btn-primary text-neutral-content">
										   <span class="font-bold">Send</span>
										   <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-6 w-6 ml-2 transform rotate-90">
											  <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"></path>
										   </svg>
										</button>
									 </div>
								</div>
								<div class="absolute z-30" style="display:none;" :style="`top: ${caretPosition.top-5}px; left: ${caretPosition.left-10}px`" x-show="showPopover" x-transition:enter="transition ease duration-100 transform" x-transition:enter-start="opacity-0 scale-90 translate-y-1" x-transition:enter-end="opacity-100 scale-100 translate-y-0" >
									<span class="absolute top-0 left-0 w-2 h-2 bg-white transform rotate-45 -mt-1 ml-3 border-gray-300 border-r border-b z-20"></span>
									<div class="bg-base-200 overflow-auto rounded-lg shadow-md z-10 py-2 border border-base-300 text-xs absolute bottom-full">
										<ul class="list-reset">
											<template x-if="!displayedItems.length">
												<li>
													<span class="block px-4 py-1 text-nowrap whitespace-nowrap">No results</span>
												</li>
											</template>
											<template x-if="displayedItems.length">
												<template x-for="(item, index) in displayedItems" :key="item.label+item.value+index">
													<li @click.prevent="applyMention(index)" class="px-4 py-1 flex no-underline hover:no-underline transition-colors duration-100 text-nowrap whitespace-nowrap" :class="selectedIndex == index ? 'bg-primary' : 'hover:bg-base-200'">
														<span x-text="item.label" class="font-bold"></span>
														<span x-text="`[${key||''}${item.value}]`" class="ml-2"></span>
													</li>
												</template>
											</template>
										</ul>
									</div>
								</div>
							</div>
					</div>
				</div>
			</div>
			<div class="col-span-6" x-show="selectedTab === 'evidence' && !tabLoading">
				<div class="card border border-base-200 bg-base-200">
					<div class="card-body">
						<div class="flex justify-between align-items-center">
							<h2 class="card-title" x-text="'Project Evidence ('+filteredEvidence.length+')'"></h2>
							<div class="flex flex-row gap-x-2">
								<div class="space-x-2 flex">
									<button @click="evidenceFilter.name=''" x-show="evidenceFilter.name" class="btn btn-ghost btn-xs"><i class="ti ti-x text-error"></i></button>
									<label :class="{'border-error':evidenceFilter.name}" class="input input-xs flex items-center gap-2">
										  <input x-model="evidenceFilter.name" type="text" class="grow" placeholder="Search..." />
										  <svg
											xmlns="http://www.w3.org/2000/svg"
											viewBox="0 0 16 16"
											fill="currentColor"
											class="h-4 w-4 opacity-70">
											<path
											  fill-rule="evenodd"
											  d="M9.965 11.026a5 5 0 1 1 1.06-1.06l2.755 2.754a.75.75 0 1 1-1.06 1.06l-2.755-2.754ZM10.5 7a3.5 3.5 0 1 1-7 0 3.5 3.5 0 0 1 7 0Z"
											  clip-rule="evenodd" />
										  </svg>
										</label>

									<button :disabled="isAuditor" class="btn btn-xs text-xs capitalize tooltip bg-base-100 text-success"
											@click="openCreateEvidenceModal" data-tip="Create Evidence">Create Evidence
									</button>
								</div>
							</div>
						</div>
						<div class="grid grid-cols-4">
							<div class="col-span-4">
								<table x-data="{'headerCount': 4}" class="table">
									<!-- Table Header -->
									<thead class="border-b">
									  <tr>
										<th class="bg-base-200 p-2 text-xs border-b border-base-100 w-2">View</th>
										<th class="bg-base-200 p-2 text-xs border-b border-base-100">Evidence Title</th>
										<th class="bg-base-200 p-2 text-xs border-b border-base-100 w-2/12 text-center">Files</th>
										<th class="bg-base-200 rounded-tr-md p-2 text-xs border-b border-base-100 w-1 text-center">Subcontrols</th>

									  </tr>
									</thead>

									<!-- Table Body -->
									<tbody class="bg-base-200">
									  <template x-for="item in filteredEvidence">
										<tr>
											<td>
												<button @click="openEvidenceDrawer(item)" class="btn btn-xs btn-ghost"><i class="ti ti-maximize text-lg"></i></button>
											</td>
											<td x-text="item.name"></td>
											<td class="text-center">
												<span x-show="!item.has_file" class="p-2 rounded-lg text-[10px] uppercase bg-base-100 text-warning">False</span>
												<span x-show="item.has_file" class="p-2 rounded-lg text-[10px] uppercase bg-base-100 text-success">True</span>
											</td>
											<td>
												<div @click="openEvidenceDrawer(item)" class="flex flex-row gap-x-1 font-semibold justify-center bg-base-100 p-1 rounded-md hover:cursor-pointer" x-text="item.control_count"></div>
											</td>
										</tr>

									  </template>
									</tbody>
								</table>
							</div>
						</div>
					</div>
				</div>
			</div>

			<div class="col-span-6" x-show="selectedTab === 'settings' && !tabLoading">
				<div class="card border border-base-200 bg-base-200">
					<div class="card-body">
						<div class="flex justify-between align-items-center">
							<h2 class="card-title mb-4">Project Settings</h2>
							<div class="flex flex-row gap-x-2">
								<div class="space-x-2 flex">
									<button :disabled="isAuditor" class="btn btn-sm border border-base-300 capitalize tooltip btn-success"
											@click="saveSettings;location.reload()" data-tip="Save data">Save Changes
									</button>
								</div>
							</div>
						</div>
						<div class="grid grid-cols-4 gap-6">
							<div class="col-span-2">
								<label class="block text-sm font-medium mb-2">Name</label>
								<input :disabled="isAuditor" x-model="projectData.name" type="text" placeholder="Add project name" class="input input-sm input-bordered w-full" />
							</div>
							<div class="col-span-2">
								<label class="block text-sm font-medium mb-2">Description</label>
								<input :disabled="isAuditor" x-model="projectData.description" type="text" placeholder="Add description" class="input input-sm input-bordered w-full" />
							</div>
							<div class="col-span-1">
								<label class="block text-sm font-medium mb-2">Auditor Enabled</label>
								<input :disabled="isAuditor" x-model="projectData.auditor_enabled" :checked="projectData.auditor_enabled" type="checkbox" class="toggle toggle-sm toggle-success"/>
							</div>
							<div class="col-span-1">
								<label class="block text-sm font-medium mb-2">Auditor Read Comments</label>
								<input :disabled="isAuditor" x-model="projectData.can_auditor_read_comments" :checked="projectData.can_auditor_read_comments" type="checkbox" class="toggle toggle-sm toggle-success"/>
							</div>
							<div class="col-span-1">
								<label class="block text-sm font-medium mb-2">Auditor Write Comments</label>
								<input :disabled="isAuditor" x-model="projectData.can_auditor_write_comments" :checked="projectData.can_auditor_write_comments" type="checkbox" class="toggle toggle-sm toggle-success"/>
							</div>
							<div class="col-span-1">
								<label class="block text-sm font-medium mb-2">Policies Require Change Control</label>
								<input :disabled="isAuditor" x-model="projectData.policies_require_cc" :checked="projectData.policies_require_cc" type="checkbox" class="toggle toggle-sm toggle-success"/>
							</div>
						</div>

					</div>
				</div>
			</div>
			<div class="col-span-6" x-show="selectedTab === 'user management' && !tabLoading">
				<div class="card border border-base-200 bg-base-200">
					<div class="card-body">
						<div class="flex justify-between align-items-center">
							<h2 class="card-title mb-4">Project Users</h2>
							<div class="flex flex-row gap-x-2">
								<div class="space-x-2 flex">
									<button :disabled="isAuditor" class="btn btn-xs text-xs bg-base-100 tooltip text-success"
											@click="showAddUser=true" data-tip="Add User">Add User
									</button>
								</div>
							</div>
						</div>
						<div x-show="!projectUsers.some(obj => obj.member === true)" class="grid grid-cols-4 text-center">
						  <div class="col-span-full hero-content text-center">
							<div class="max-w-md">
							  <h1 class="text-2xl font-bold">No users</h1>
							  <p class="py-6">
								You have not added any users to your project. Users in your tenant do not automatically get access to projects. Provision users/auditors below.
							  </p>
							  <button @click="showAddUser=true" class="btn btn-sm btn-primary">Add User</button>
							</div>
						  </div>
						</div>

						<div x-show="projectUsers.some(obj => obj.member === true)" class="overflow-x-auto">
						  <table class="table">
							<thead>
							  <tr>
								<th>Email</th>
								<th class="w-1/5">Role</th>
								<th class="w-1/5">Edit</th>
							  </tr>
							</thead>
							<tbody>
							  <template x-for="user in projectUsers">
								  <tr x-show="user.member">
									<td x-text="user.email"></td>
									<td class="capitalize font-semibold" x-text="user.access_level"></td>
									<td><div class="gap-x-4"><button :disabled="isAuditor" @click="selectedUser=user;showEditUserModal=true" class="btn btn-xs btn-ghost text-warning mr-2"><i class="ti ti-edit"></i></button><button :disabled="isAuditor" @click="selectedUser=user;showRemoveUserModal=true" class="btn btn-xs btn-ghost text-error"><i class="ti ti-trash"></i></button></div></td>
								  </tr>
							  </template>
							</tbody>
						  </table>
						</div>
					</div>
				</div>
			</div>
			<div class="col-span-6" x-show="selectedTab === 'control tags' && !tabLoading">
				<div class="alert bg-base-200 mb-4">
					<div class="alert-content">
						<i class="ti ti-info-circle text-lg"></i>
						<span>Tags are used to categorize controls. You can add a tag to a control by selecting the tag from the dropdown in the control editor.</span>
					</div>
				</div>
				<div class="card border border-base-200 bg-base-200">
					<div class="card-body">
						<div class="flex justify-between align-items-center">
							<h2 class="card-title mb-4">Project Tags</h2>
							<div class="flex flex-row gap-x-2">
								<div class="space-x-2 flex">
									<button :disabled="isAuditor" class="btn btn-xs text-xs bg-base-100 tooltip text-success"
											@click="showCreateTagModal=true" data-tip="Add Tag">Add Tag
									</button>
								</div>
							</div>
						</div>
						<div x-show="!projectTags.length" class="grid grid-cols-4 text-center">
						  <div class="col-span-full hero-content text-center">
							<div class="max-w-md">
							  <h1 class="text-2xl font-bold">No tags</h1>
							  <p class="py-6">
								You have not added any tags to your project.
							  </p>
							  <button @click="showCreateTagModal=true" class="btn btn-sm btn-primary">Add Tag</button>
							</div>
						  </div>
						</div>

						<div x-show="projectTags.length" class="overflow-x-auto">
						  <table class="table">
							<thead>
							  <tr>
								<th>Tag Name</th>
							  </tr>
							</thead>
							<tbody>
							  <template x-for="tag in projectTags">
								  <tr>
									<td x-text="tag.name"></td>
								  </tr>
							  </template>
							</tbody>
						  </table>
						</div>
					</div>
				</div>
			</div>			

			<div class="col-span-6 text-center" x-show="selectedTab === 'report' && !tabLoading">
				<div class="grid grid-cols-10 gap-x-2">
					<div class="col-span-2">
						<ul class="menu bg-base-200 rounded-box">
						  <li>
							<h2 class="menu-title">Available Reports</h2>
							<ul>
							  <li><a>Coming Soon</a></li>
							</ul>
						  </li>
						</ul>
					</div>
					<div class="col-span-8">
						<div class="card-body bg-base-200 rounded-lg">
							Coming Soon
						</div>
					</div>
				</div>
			</div>

			<div class="col-span-6 text-center" x-show="selectedTab === 'risk register' && !tabLoading">
				<div class="grid grid-cols-10">
					<div class="col-span-2 rounded-tl-lg border-y border-l border-base-300 bg-base-200 sticky top-0 h-screen">
						<div class="card">
						<div class="card-body px-6">
							<div class="flex justify-between">
								<div class="text-lg font-semibold my-auto">Filter Risks</div>
								<button x-show="hasFilter" @click="disableFilter" :class="{'text-error':hasFilter}" class="btn btn-xs btn-ghost border border-base-300"><i class="ti ti-filter-x text-lg"></i></button>
							</div>
							<ul class="menu p-0">
							  <li>
								<div class="menu-title p-0 flex justify-between mb-1">
									<h2 class="my-auto text-xs"><span class="tooltip" data-tip="Risk after review"><i class="ti ti-info-hexagon mr-1 text-sm"></i></span>Created Within</h2>
									<button @click="filter.createdWithin = null" x-show="filter.createdWithin && Object.keys(filter.createdWithin).length" class="btn btn-xs btn-ghost border border-base-300"><i class="ti ti-x text-error text-md"></i></button>
								</div>
								<ul class="text-xs font-medium">
									<li>
									  <a :class="{'bg-error opacity-80': filter.createdWithin === 'today'}"
										 @click="filterCreatedAt('today')"
										 class="flex justify-between w-full text-xs">
										<span class="text-xs"><i class="ti ti-calendar-event mr-1"></i>Today</span>
										<span class="text-xs" x-text="createdTodayCount"></span>
									  </a>
									</li>
									<li>
									  <a :class="{'bg-error opacity-80': filter.createdWithin === '7'}"
										 @click="filterCreatedAt('7')"
										 class="flex justify-between w-full text-xs">
										<span class="text-xs"><i class="ti ti-calendar-week mr-1"></i>Last 7 days</span>
										<span class="text-xs" x-text="created7Count"></span>
									  </a>
									</li>
									<li>
									  <a :class="{'bg-error opacity-80': filter.createdWithin === '30'}"
										 @click="filterCreatedAt('30')"
										 class="flex justify-between w-full text-xs">
										<span class="text-xs"><i class="ti ti-calendar-month mr-1"></i>Last 30 days</span>
										<span class="text-xs" x-text="created30Count"></span>
									  </a>
									</li>
								</ul>
							  </li>
							</ul>
			
							<ul class="menu p-0">
							  <li>
								<div class="menu-title p-0 flex justify-between mb-1">
									<h2 class="my-auto text-xs"><span class="tooltip" data-tip="Status of report"><i class="ti ti-info-hexagon mr-1 text-sm"></i></span>Status</h2>
									<button @click="filter.status = null" x-show="filter.status && Object.keys(filter.status).length" class="btn btn-xs btn-ghost border border-base-300"><i class="ti ti-x text-error text-md"></i></button>
								</div>
								<ul class="text-xs font-medium">
									<li>
									  <a :class="{'bg-error opacity-80': filter.status === 'new'}"
										 @click="filterStatus('new')"
										 class="flex justify-between w-full text-xs">
										<span class="text-xs">New</span>
										<span class="text-xs" x-text="newReportsCount"></span>
									  </a>
									</li>
									<li>
									  <a :class="{'bg-error opacity-80': filter.status === 'triage'}"
										 @click="filterStatus('triage')"
										 class="flex justify-between w-full text-xs">
										<span class="text-xs">In Progress</span>
										<span class="text-xs" x-text="triageReportsCount"></span>
									  </a>
									</li>
									<li>
									  <a :class="{'bg-error opacity-80': filter.status === 'accepted'}"
										 @click="filterStatus('accepted')"
										 class="flex justify-between w-full text-xs">
										<span class="text-xs">Accepted</span>
										<span class="text-xs" x-text="acceptedReportsCount"></span>
									  </a>
									</li>
									<li>
									  <a :class="{'bg-error opacity-80': filter.status === 'mitigated'}"
										 @click="filterStatus('mitigated')"
										 class="flex justify-between w-full text-xs">
										<span class="text-xs">Mitigated</span>
										<span class="text-xs" x-text="mitigatedReportsCount"></span>
									  </a>
									</li>
								</ul>
							  </li>
							</ul>
							<ul class="menu p-0">
							  <li>
								<div class="menu-title p-0 flex justify-between mb-1">
									<h2 class="my-auto text-xs"><span class="tooltip" data-tip="Risk by author"><i class="ti ti-info-hexagon mr-1 text-sm"></i></span>Risk Rating</h2>
									<button @click="filter.risk = null" x-show="filter.risk && Object.keys(filter.risk).length" class="btn btn-xs btn-ghost border border-base-300"><i class="ti ti-x text-error text-md"></i></button>
								</div>
								<ul class="text-xs font-medium">
									<li>
									  <a :class="{'bg-error opacity-80': filter.risk === 'critical'}"
										 @click="filterRisk('critical')"
										 class="flex justify-between w-full text-xs">
										<span class="text-xs"><i class="ti ti-alert-circle text-error mr-1"></i>Critical</span>
										<span class="text-xs" x-text="initialCriticalRiskCount"></span>
									  </a>
									</li>
									<li>
									  <a :class="{'bg-error opacity-80': filter.risk === 'high'}"
										 @click="filterRisk('high')"
										 class="flex justify-between w-full text-xs">
										<span class="text-xs"><i class="ti ti-alert-circle text-error opacity-80 mr-1"></i>High</span>
										<span class="text-xs" x-text="initialHighRiskCount"></span>
									  </a>
									</li>
									<li>
									  <a :class="{'bg-error opacity-80': filter.risk === 'moderate'}"
										 @click="filterRisk('moderate')"
										 class="flex justify-between w-full text-xs">
										<span class="text-xs"><i class="ti ti-alert-circle text-warning mr-1"></i>Moderate</span>
										<span class="text-xs" x-text="initialModerateRiskCount"></span>
									  </a>
									</li>
									<li>
									  <a :class="{'bg-error opacity-80': filter.risk === 'low'}"
										 @click="filterRisk('low')"
										 class="flex justify-between w-full text-xs">
										<span class="text-xs"><i class="ti ti-alert-circle text-success mr-1"></i>Low</span>
										<span class="text-xs" x-text="initialLowRiskCount"></span>
									  </a>
									</li>
									<li>
									  <a :class="{'bg-error opacity-80': filter.risk === 'unknown'}"
										 @click="filterRisk('unknown')"
										 class="flex justify-between w-full text-xs">
										<span class="text-xs"><i class="ti ti-alert-circle mr-1"></i>Unknown</span>
										<span class="text-xs" x-text="initialUnknownRiskCount"></span>
									  </a>
									</li>
								</ul>
							  </li>
							</ul>
						</div>
					</div>
					</div>
					<div class="col-span-8 px-6 py-2 border rounded-tr-lg overflow-y-auto h-screen border-base-300">
						<div class="overflow-x-auto">
					  <div class="flex justify-between my-2">
						<div class="flex flex-row gap-x-2 py-2 my-auto">
							<span class="card-title">Risk Reports</span>
							<span class="pill text-ss bg-base-300" x-text="'Showing: '+filteredRisks.length"></span>
						  <span x-show="false" x-text="JSON.stringify(filter)"></span>
						</div>
						<div class="flex flex-row gap-x-4">
							<button @click="search=''" x-show="search.length>0" class="btn btn-xs btn-ghost border border-base-300 my-auto"><i class="ti ti-x text-error"></i></button>
							<label class="input input-sm input-bordered flex items-center gap-2 my-auto">
							  <input type="text" class="grow text-sm" x-model="search" placeholder="Search by Title" />
							  <svg
								xmlns="http://www.w3.org/2000/svg"
								viewBox="0 0 16 16"
								fill="currentColor"
								:class="{'text-error': search.length>0}"
								class="h-4 w-4 opacity-70">
								<path
								  fill-rule="evenodd"
								  d="M9.965 11.026a5 5 0 1 1 1.06-1.06l2.755 2.754a.75.75 0 1 1-1.06 1.06l-2.755-2.754ZM10.5 7a3.5 3.5 0 1 1-7 0 3.5 3.5 0 0 1 7 0Z"
								  clip-rule="evenodd" />
							  </svg>
							</label>
							<button @click="showCreateRisk=true" class="btn my-auto btn-sm btn-success">Create Risk</button>
							  <span class="my-auto" x-show="riskRowsSelected.length>0" x-text="'Rows selected: '+riskRowsSelected.length"></span>
							  <div class="my-auto" x-show="riskRowsSelected.length>0">
								<details class="dropdown dropdown-bottom dropdown-end">
									<summary class="btn btn-sm btn-ghost border border-base-300"><i class="ti ti-dots text-lg"></i></summary>
									<ul class="menu dropdown-content bg-base-100 rounded-box z-[1] w-52 p-2 shadow">
										<li><a @click="toggleAllRiskRows(true)"><i class="ti ti-checks mr-1 text-success"></i>Select all</a></li>
										<li><a @click="deselectedAllRiskRows"><i class="ti ti-x mr-1 text-error"></i>Deselect all</a></li>
										<li><a @click="showUpdateStatusModal = true"><i class="ti ti-progress mr-1"></i>Update Status</a></li>
										<li><a @click="showUpdateRiskModal = true"><i class="ti ti-alarm mr-1"></i>Update Risk</a></li>
									</ul>
								</details>
							</div>
			
						</div>
					  </div>
			<!--          When we are loading/filtering reports-->
					  <div x-show="loadingReports">
						<div class="hero bg-base-200 min-h-screen">
						  <div class="hero-content text-center">
							<div class="max-w-full">
							  <span class="loading loading-dots loading-lg"></span>
							</div>
						  </div>
						</div>
					  </div>
			
			<!--          When the filter does not match any data-->
					  <div x-show="!loadingReports && filteredRisks.length===0">
						<div class="hero bg-base-200 min-h-screen">
						  <div class="hero-content text-center">
							<div class="max-w-full">
							  <h1 class="text-2xl font-semibold">No Risks!</h1>
							  <p x-show="!hasFilter" class="py-4">
								You have not logged any risks. Let's get started.
							  </p>
							  <button x-show="!hasFilter" @click="showCreateRisk=true" class="btn btn-sm btn-success">Create Risk</button>
							  <p x-show="hasFilter" class="py-4">
								The filter you applied does not match any reports.
							  </p>
							  <button x-show="hasFilter" @click="disableFilter" class="btn btn-sm btn-error">Remove Filter</button>
							</div>
						  </div>
						</div>
					  </div>
			
			<!--          When we have results to show-->
					  <div x-show="!loadingReports && filteredRisks.length>0">
						  <table class="table">
						<!-- head -->
						<thead>
						  <tr>
							<th class="p-4 bg-base-200 rounded-tl-lg w-1">
							  <label>
								<input x-ref="selectAllRiskCheckbox" @click="toggleAllRiskRows($el.checked)" type="checkbox" class="checkbox checkbox-xs mt-1" />
							  </label>
							</th>
							<th class="p-4 bg-base-200">Status</th>
							<th class="p-4 bg-base-200">Title</th>
							<th class="p-4 bg-base-200">Description</th>
							<th class="p-4 bg-base-200">Risk</th>
							  <th class="p-4 bg-base-200">Created</th>
							<th class="p-4 bg-base-200 rounded-tr-lg w-1">Open</th>
			
						  </tr>
						</thead>
						<tbody class="border border-base-300 px-1">
							<template x-for="report in filteredRisks" :key="report.id">
							  <tr :class="{'opacity-70': previousSelectedReport === report}">
								<th>
								  <div class="my-auto mt-1">
									<input :checked="riskRowsSelected.includes(report.id)" @change="toggleRiskRow($event.target.checked, report.id)" type="checkbox" class="checkbox checkbox-xs"/>
								  </div>
								</th>
								<td>
									<span :class="{'bg-primary': report.status==='new', 'bg-warning': report.status==='in_progress', 'bg-success': report.status==='mitigated', 'bg-success opacity-80': report.status==='accepted'}" class="p-1 px-2 rounded-lg uppercase text-ss text-primary-content" x-text="report.status"></span>
								</td>
								<td @click="openReportDrawer(report)" class="underline hover:cursor-pointer hover:opacity-75">
									<div class="flex flex-row">
										<span x-text="report.title"></span>
									</div>
								</td>
								<td>
									<div
									  x-data="{ expanded: false }"
									  class="overflow-y-auto"
									  :class="expanded ? 'h-40' : ''"
									>
									  <span class="text-xs">
										<template x-if="report.description.length > 200">
										  <p class="text-xs" x-text="expanded ? report.description : report.description.slice(0, 200) + '...'"></p>
										</template>
										<template x-if="report.description.length <= 200">
										  <p class="text-xs" x-text="report.description"></p>
										</template>
									  </span>
			
									  <button
										x-show="report.description.length > 200"
										@click="expanded = !expanded"
										class="underline text-ss"
									  >
										<span class="text-xs" x-text="expanded ? 'See less' : 'See more'"></span>
									  </button>
									</div>
								</td>
			
								<td>
									<span :class="{'bg-primary': report.risk==='unknown', 'bg-success': report.risk==='low', 'bg-warning': report.risk==='moderate', 'bg-error opacity-80': report.risk==='high', 'bg-error': report.risk==='critical'}" class="p-1 px-2 rounded-lg uppercase text-ss text-white" x-text="report.risk"></span>
								</td>
								  <td>
									<span class="tooltip text-xs" :data-tip="report.created_at_h" x-text="report.created_at"></span>
								</td>
								<td>
									<button @click="openReportDrawer(report)" class="btn btn-xs btn-ghost border border-base-300"><i class="ti ti-arrow-right text-md"></i></button>
								</td>
							  </tr>
							</template>
						</tbody>
					  </table>
			
					  </div>
			
		
					</div>
					</div>
				</div>
			</div>	

			<div class="col-span-6 text-center" x-show="selectedTab === 'audit review' && !tabLoading">
				<div class="grid grid-cols-12 gap-4">
					<div x-show="projectData.auditors.length" class="col-span-12">
						<div role="alert" class="alert bg-base-200">
							<i class="ti ti-alert-triangle text-md"></i>
							<span class="text-xs">Each control will have a review status to guide the review process. The three (3) possible review statuses are shown below with the number of controls for each one.</span>
						</div>
					</div>
					<div x-show="!projectData.auditors.length" class="col-span-12">
						<div role="alert" class="alert bg-base-200">
							<i class="ti ti-alert-triangle text-warning text-md"></i>
							<span class="text-xs">Please add a Auditor to your project! The Auditor will have access to change the review status.</span>
							<div>
								<button class="btn btn-sm" @click="switchTab({'tab': 'user management'})">Add Auditor</button>
							</div>
						</div>
					</div>

					<div class="col-span-3">
						<div class="card bg-base-200">
							<div class="card-body">
								<div class="card-title text-lg">Auditor Details</div>
								<div role="alert" class="alert bg-base-300">
									<i class="ti ti-alert-triangle text-md"></i>
									<span class="text-xs">If you would like to add/edit the Auditors in the project, see the "User Management" tab.</span>
								</div>
								<div class="flex flex-col text-left mt-2">
									<span class="font-bold">Auditors:</span>
									<template x-for="user in projectUsers">
										<span x-show="user.access_level==='auditor'" x-text="user.email"></span>
									</template>
								</div>
							</div>
						</div>
					</div>

					<div class="col-span-9">
						<div class="grid grid-cols-12 gap-4">
							<div class="col-span-4">
								<div class="card border border-base-200 bg-base-200">
									<div class="card-body">
										<div class="flex justify-between align-items-center">
											<h2 class="card-title mb-4"><i class="ti ti-shield-pause my-auto text-warning text-lg mr-2"></i>Waiting on InfoSec</h2>
										</div>
										<div class="grid grid-cols-12">
											<div class="col-span-4 my-auto">
												<span x-text="controlReviewStatuses['infosec action']" class="text-4xl"></span>
											</div>
											<div class="col-span-8">
												<span class="text-xs" x-text="'There are '+controlReviewStatuses['infosec action']+' controls waiting on the InfoSec team. Please select below to see the specific controls.'"></span>
											</div>
										</div>
										<button @click="switchTab({tab: 'controls'});controlFilter.review_status='infosec action'" class="btn btn-block bg-base-300">View Controls</button>
									</div>
								</div>
							</div>
							<div class="col-span-4">
								<div class="card border border-base-200 bg-base-200">
									<div class="card-body">
										<div class="flex justify-between align-items-center">
											<h2 class="card-title mb-4"><i class="ti ti-spy my-auto text-error text-lg mr-2"></i>Ready for Auditor</h2>
										</div>
										<div class="grid grid-cols-12">
											<div class="col-span-4 my-auto">
												<span class="text-4xl" x-text="controlReviewStatuses['ready for auditor']"></span>
											</div>
											<div class="col-span-8">
												<span class="text-xs" x-text="'There are '+controlReviewStatuses['ready for auditor']+' controls waiting on the Auditor to review. Please select below to see the specific controls.'"></span>
											</div>
										</div>
										<button @click="switchTab({tab: 'controls'});controlFilter.review_status='ready for auditor'" class="btn btn-block bg-base-300">View Controls</button>

									</div>
								</div>
							</div>
							<div class="col-span-4">
								<div class="card border border-base-200 bg-base-200">
									<div class="card-body">
										<div class="flex justify-between align-items-center">
											<h2 class="card-title mb-4"><i class="ti ti-check my-auto text-success text-lg mr-2"></i>Complete</h2>
										</div>
										<div class="grid grid-cols-12">
											<div class="col-span-4 my-auto">
												<span class="text-4xl" x-text="controlReviewStatuses['complete']"></span>
											</div>
											<div class="col-span-8">
												<span class="text-xs" x-text="'There are '+controlReviewStatuses['complete']+' controls where the Auditor review is complete. Please select below to see the specific controls.'"></span>
											</div>
										</div>
										<button @click="switchTab({tab: 'controls'});controlFilter.review_status='complete'" class="btn btn-block bg-base-300">View Controls</button>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>

	</div>
	<div>
		<div class="modal" x-bind:class="{ 'modal-open': showMetadataModal }">
			<div class="modal-box px-20">
				<form method="dialog">
					<button @click="showMetadataModal = false"
							class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕
					</button>
				</form>
				<div class="text-center bg-base-200 rounded-lg mt-5">
					<div
					  class="radial-progress text-sm font-semibold my-2 border-base-100 border-2 mt-8"
					  :style="'--value:' + projectData.completion_progress + '; --size: 12rem; --thickness: 2px;'"
					  role="progressbar" x-text="projectData.completion_progress+'%'">
					</div>
				</div>
				<div class="card-body bg-base-200 text-sm">
					<div class="flex justify-between gap-x-5">
						<span class="font-semibold">Completion</span>
						<span x-text="projectData.completion_progress+'%'"></span>
					</div>
					<div class="flex justify-between gap-x-5">
						<span class="font-semibold">Implemention</span>
						<span x-text="projectData.implemented_progress+'%'">10</span>
					</div>
					<div class="flex justify-between gap-x-5">
						<span class="font-semibold">Evidence</span>
						<span x-text="projectData.evidence_progress+'%'">10</span>
					</div>
				</div>
				<div class="modal-action">
					<button class="btn" @click="showMetadataModal = false">Close</button>
				</div>
			</div>
		</div>
	</div>
	<div>
		<div data-theme="dim" class="modal" x-bind:class="{ 'modal-open': showAddPolicy }">
			<div class="modal-box w-11/12 max-w-4xl">
				<form method="dialog">
					<button @click="showAddPolicy=false"
							class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕
					</button>
				</form>
				<h2 class="py-2 text-xl font-semibold px-6">Add Policy</h2>
				<p class="px-6">Once a policy is added to your project, you can make any required changes. You can visit the <a class="underline" :href="'/projects/'+projectId+'/policy-center'">policy center</a> to view/edit all your project policies.</p>
				<div class="grid grid-cols-10 gap-6 px-6 mt-4">
					<div class="col-span-10">
						<label class="block text-sm font-medium mb-2">Add Policy from Template</label>
						<select x-model="policyId" class="select select-sm select-bordered w-full">
						  <option selected>Please select...</option>
						  <template x-for="policy in tenantPolicies" :key="policy.id">
							  <option class="capitalize" :value="policy.id" x-text="policy.name"></option>
						  </template>
						</select>
					</div>
				</div>
				<div class="modal-action">
					<button class="btn" @click="showAddPolicy=false">Close</button>
					<button :disabled="!policyId" @click="addPolicy" class="btn btn-primary">Add Policy</button>
				</div>
			</div>
		</div>
	</div>
	<div>
		<div data-theme="dim" class="modal" x-bind:class="{ 'modal-open': showAddUser }">
			<div class="modal-box w-11/12 max-w-4xl">
				<form method="dialog">
					<button @click="showAddUser=false"
							class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕
					</button>
				</form>
				<h2 class="py-2 text-xl font-semibold px-6">Add User to Project</h2>
				<div class="grid grid-cols-10 gap-4 px-6">
					<div class="col-span-full">
						<div role="alert" class="alert bg-base-200 px-6">
							<i class="ti ti-alert-triangle text-md"></i>
							<span class="text-xs">Before a user is added to the project, they must first be invited to your Tenant.</span>
							<a href="/users" class="btn btn-xs btn-success">Tenant Users</a>
						</div>
					</div>
					<div class="col-span-5">
						<label class="block text-sm font-medium mb-2">Select user to add</label>
						<select x-model="addUserId" class="select select-sm select-bordered w-full">
						  <option selected>Please select...</option>
						  <template x-for="user in projectUsers" :key="user.id">
							  <option x-show="!user.member" :value="user.id" x-text="user.email"></option>
						  </template>
						</select>
					</div>
					<div class="col-span-5">
						<label class="block text-sm font-medium mb-2">Select Role<i @click="showRoleHelp=!showRoleHelp" class="ti ti-question-mark ml-2 text-warning hover:cursor-pointer"></i></label>
						<select x-model="addUserRole" class="select select-sm select-bordered w-full">
						  <option value="viewer">Viewer</option>
						  <option value="contributor">Contributor</option>
						  <option value="manager">Manager</option>
						  <option value="auditor">Auditor</option>
						</select>
					</div>
					<div x-show="showRoleHelp===true" class="mt-4 col-span-10 w-full">
						<div class="overflow-x-auto">
						  <table class="table">
							<thead>
							  <tr>
								<th>Role</th>
								<th>Description</th>
							  </tr>
							</thead>
							<tbody>
							  <tr>
								<th>Viewer</th>
								<td>Grant user the ability to view everything in the project but with no create/edit permissions</td>
							  </tr>
							  <tr>
								<th>Contributor</th>
								<td>Allow user to contribute to controls and evidence in the project</td>
							  </tr>
							  <tr>
								<th>Manager</th>
								<td>Allow user to manage the project and create/edit/delete most items</td>
							  </tr>
							  <tr>
								<th>Auditor</th>
								<td>Auditor allows the user to audit the project and create/edit/view pages only the Auditor should see</td>
							  </tr>
							</tbody>
						  </table>
						</div>
					</div>
				</div>
				<div class="modal-action">
					<button class="btn" @click="showAddUser=false">Close</button>
					<button :class="{'btn-disabled': !addUserId || !addUserRole}" @click="addUser" class="btn btn-success">Add User</button>
				</div>
			</div>
		</div>
	</div>
	<div>
		<div data-theme="dim" class="modal" x-bind:class="{ 'modal-open': showEditUserModal }">
			<div class="modal-box w-11/12 max-w-4xl">
				<form method="dialog">
					<button @click="showEditUserModal=false"
							class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕
					</button>
				</form>
				<h2 class="py-2 text-xl font-semibold px-6" x-text="'Edit Access: '+selectedUser.email"></h2>
				<div class="grid grid-cols-10 gap-6 card-body">
					<div class="col-span-5">
						<label class="block text-sm font-medium mb-2">Select Role</label>
						<select x-model="updatedAccessLevel" class="select select-bordered w-full">
						  <option :selected="selectedUser.access_level==='viewer'" value="viewer">Viewer</option>
						  <option :selected="selectedUser.access_level==='contributor'" value="contributor">Contributor</option>
						  <option :selected="selectedUser.access_level==='manager'" value="manager">Manager</option>
						  <option :selected="selectedUser.access_level==='auditor'" value="auditor">Auditor</option>
						</select>
					</div>
				</div>
				<div class="modal-action">
					<button class="btn" @click="showEditUserModal=false">Close</button>
					<button :class="{'btn-disabled': !updatedAccessLevel}" @click="updateUser" class="btn btn-warning">Update</button>
				</div>
			</div>
		</div>
	</div>
	<div>
	  <div class="modal" x-bind:class="{ 'modal-open': showRemoveUserModal }">
		  <div class="modal-box">
			  <form method="dialog">
				  <button @click="showRemoveUserModal = false"
						  class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕
				  </button>
			  </form>
			  <span class="text-lg font-semibold">Remove User from Project</span>
			  <div class="grid grid-cols-6 gap-4 mt-4">
				  <div class="col-span-6">
					  <span class="block text-sm font-medium mb-2" x-text="'Are you sure you want to remove '+selectedUser.email+' from the project?'"></span>
				  </div>
			  </div>
			  <div class="modal-action">
				  <button class="btn" @click="showRemoveUserModal = false">Close</button>
				  <button class="btn btn-error" @click="removeUser">Remove</button>
			  </div>
		  </div>
	  </div>
	</div>
	<div>
	  <div class="modal" x-bind:class="{ 'modal-open': showRemoveEvidenceModal }">
		  <div class="modal-box">
			  <form method="dialog">
				  <button @click="showRemoveEvidenceModal = false"
						  class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕
				  </button>
			  </form>
			  <span class="text-lg font-semibold">Remove Evidence?</span>
			  <div class="grid grid-cols-6 gap-4 mt-4">
				  <div class="col-span-6">
					  <span class="block text-sm font-medium mb-2">Are you sure you want to remove the evidence? The evidence will not be deleted, the association will just be removed from the control. You can always quickly add it back.</span>
				  </div>
			  </div>
			  <div class="modal-action">
				  <button class="btn" @click="showRemoveEvidenceModal = false">Close</button>
				  <button class="btn btn-error" @click="removeEvidence(removeEvidenceIndex)">Remove</button>
			  </div>
		  </div>
	  </div>
	</div>
	<div>
		<div data-theme="dim" class="modal" x-bind:class="{ 'modal-open': showCreateRisk }">
			<div class="modal-box w-11/12 max-w-2xl">
				<form method="dialog">
					<button @click="showCreateRisk=false"
							class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕
					</button>
				</form>
				<h2 class="py-2 text-xl font-semibold px-6">Create Risk</h2>
				<div class="grid grid-cols-12 gap-4 card-body">
					<div class="col-span-6">
						<label class="block text-sm font-medium mb-2">Title</label>
						<input x-model="riskPayload.title" type="text" placeholder="Provide a title for the risk" class="input input-sm input-bordered w-full" />
					</div>
					<div class="col-span-6">
						<label class="block text-sm font-medium mb-2">Description</label>
						<textarea x-model="riskPayload.description" class="textarea textarea-sm textarea-bordered w-full" placeholder="Provide a description for the risk"></textarea>
					</div>

					<div class="col-span-4">
						<label class="block text-sm font-medium mb-2">Risk</label>
						<select x-model="riskPayload.risk" class="select select-sm select-bordered w-full">
						  <option selected>Please select...</option>
						  <option class="capitalize" value="unknown">unknown</option>
						  <option class="capitalize" value="low">low</option>
						  <option class="capitalize" value="moderate">moderate</option>
						  <option class="capitalize" value="high">high</option>
						  <option class="capitalize" value="critical">critical</option>
						</select>
					</div>
					<div class="col-span-4">
						<label class="block text-sm font-medium mb-2">Status</label>
						<select x-model="riskPayload.status" class="select select-sm select-bordered w-full">
						  <option selected>Please select...</option>
						  <option class="capitalize" value="new">new</option>
						  <option class="capitalize" value="in_progress">In Progress</option>
						  <option class="capitalize" value="accepted">accepted</option>
						  <option class="capitalize" value="mitigated">mitigated</option>
						  <option class="capitalize" value="false_positive">False Positive</option>
						</select>
					</div>
					<div class="col-span-4">
						<label class="block text-sm font-medium mb-2">Priority</label>
						<select x-model="riskPayload.priority" class="select select-sm select-bordered w-full">
						  <option selected>Please select...</option>
						  <option class="capitalize" value="unknown">unknown</option>
						  <option class="capitalize" value="low">low</option>
						  <option class="capitalize" value="moderate">moderate</option>
						  <option class="capitalize" value="high">high</option>
						</select>
					</div>
				</div>
				<div class="modal-action">
					<button class="btn" @click="showCreateRisk=false">Close</button>
					<button :disabled="!riskPayload.title" @click="createRisk" class="btn btn-primary">Create</button>
				</div>
			</div>
		</div>
	</div>
	<div>
		<div data-theme="dim" class="modal" x-bind:class="{ 'modal-open': showPolicyModal }">
			<div class="modal-box w-11/12 max-w-4xl">
				<form method="dialog">
					<button @click="showPolicyModal=false"
							class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕
					</button>
				</form>
				<h2 class="py-2 text-xl font-semibold px-6 capitalize" x-text="selectedPolicy.name"></h2>
				<div class="grid grid-cols-12 gap-4 card-body">
					<div class="col-span-6">
						<label class="block text-sm font-medium mb-2">Title</label>
						<input x-model="selectedPolicy.name" type="text" placeholder="Provide a title for the policy" disabled class="input input-sm input-bordered w-full capitalize">
					</div>
					<div class="col-span-6">
						<label class="block text-sm font-medium mb-2">Description</label>
						<textarea x-model="selectedPolicy.description" class="textarea textarea-bordered w-full" disabled placeholder="Provide a description for the policy"></textarea>
					</div>

					<div class="col-span-4">
						<label class="block text-sm font-medium mb-2">Reviewer</label>
						<select x-model="selectedPolicy.reviewer_id" class="select select-sm select-bordered w-full">
						  <option value="" selected="">Please select...</option>
						  <template x-for="user in projectUsers">
							<option :selected="selectedPolicy.reviewer_id === user.id" x-text="user.email" :value="user.id"></option>
						  </template>
						</select>
					</div>
					<div class="col-span-4">
						<label class="block text-sm font-medium mb-2">Policy Accepted</label>
						<select x-model="selectedPolicy.accepted" class="select select-sm select-bordered w-full">
						  <option value="" selected="">Please select...</option>
						  <option :selected="selectedPolicy.accepted === 'yes' || selectedPolicy.accepted === true" class="capitalize" value="yes">Yes</option>
						  <option :selected="selectedPolicy.accepted === 'no' || selectedPolicy.accepted === false" class="capitalize" value="no">No</option>
						</select>
					</div>
					<div class="col-span-4">
						<label class="block text-sm font-medium mb-2">Version</label>
						<input x-model="selectedPolicy.version" type="text" disabled class="input input-sm input-bordered w-full capitalize">
					</div>
				</div>

				<div class="modal-action">
					<button class="btn" @click="showPolicyModal=false">Close</button>
					<button @click="updatePolicy" class="btn">Update</button>
					<a :href="'/projects/'+projectId+'/policies/'+selectedPolicy.id" class="btn">View Policy</a>

				</div>
			</div>
		</div>
	</div>

	<div>
		<div data-theme="dim" class="modal" x-bind:class="{ 'modal-open': addControlModal }">
			<div class="modal-box w-11/12 max-w-4xl">
				<form method="dialog">
					<button @click="addControlModal=false"
							class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕
					</button>
				</form>
				<h2 class="py-2 text-xl font-semibold px-6">Add Control</h2>
				<div class="grid grid-cols-10 gap-6 card-body">
					Coming Soon!
				</div>
				<div class="modal-action">
					<button class="btn" @click="addControlModal=false">Close</button>
					<button  @click="addControl" class="btn btn-success">Update</button>
				</div>
			</div>
		</div>
	</div>
	<div>
		<div data-theme="dim" class="modal" x-bind:class="{ 'modal-open': showHelpMenu }">
			<div class="modal-box w-11/12 max-w-4xl">
				<form method="dialog">
					<button @click="showHelpMenu=false"
						class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕
					</button>
				</form>
				<h2 class="py-2 text-xl font-semibold px-6">Help</h2>
				<div class="grid grid-cols-10 gap-6 card-body">
					<div class="col-span-full">
						<p>Complete all of the objectives inside of the Project Journey to complete your project. You can get started by reviewing the controls and adding policies to your project.</p>
					</div>
				</div>
				<div class="modal-action">
					<button class="btn" @click="showHelpMenu=false">Close</button>
				</div>
			</div>
		</div>
	</div>
	<div>
		<div data-theme="dim" class="modal" x-bind:class="{ 'modal-open': showReviewHelp }">
			<div class="modal-box w-11/12 max-w-4xl">
				<form method="dialog">
					<button @click="showReviewHelp=false"
							class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕
					</button>
				</form>
				<h2 class="py-2 text-xl font-semibold px-6">Help</h2>
				<div class="grid grid-cols-10 gap-6 card-body">
					<table class="table w-full col-span-10">
				<thead>
				<tr>
					<th class="w-1">Status</th>
					<th>Description</th>
					<th class="w-1">InfoSec Team</th>
					<th class="w-1">Auditor</th>
				</tr>
				</thead>
				<tbody>
				<tr>
					<th>Not Started</th>
					<td>
						<div class="whitespace-normal">The default status that is used to inform the InfoSec team that
							they have outstanding work to do.
						</div>
					</td>
					<td>
						<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
							 stroke="currentColor" class="w-6 h-6 text-green-400">
							<path stroke-linecap="round" stroke-linejoin="round"
								  d="M9 12.75L11.25 15 15 9.75M21 12c0 1.268-.63 2.39-1.593 3.068a3.745 3.745 0 01-1.043 3.296 3.745 3.745 0 01-3.296 1.043A3.745 3.745 0 0112 21c-1.268 0-2.39-.63-3.068-1.593a3.746 3.746 0 01-3.296-1.043 3.745 3.745 0 01-1.043-3.296A3.745 3.745 0 013 12c0-1.268.63-2.39 1.593-3.068a3.745 3.745 0 011.043-3.296 3.746 3.746 0 013.296-1.043A3.746 3.746 0 0112 3c1.268 0 2.39.63 3.068 1.593a3.746 3.746 0 013.296 1.043 3.746 3.746 0 011.043 3.296A3.745 3.745 0 0121 12z"></path>
						</svg>
					</td>
					<td></td>
				</tr>
				<tr>
					<th>InfoSec Action</th>
					<td>
						<div class="whitespace-normal">Status is used by the InfoSec team to track which controls are
							currently in progress.
						</div>
					</td>
					<td>
						<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
							 stroke="currentColor" class="w-6 h-6 text-green-400">
							<path stroke-linecap="round" stroke-linejoin="round"
								  d="M9 12.75L11.25 15 15 9.75M21 12c0 1.268-.63 2.39-1.593 3.068a3.745 3.745 0 01-1.043 3.296 3.745 3.745 0 01-3.296 1.043A3.745 3.745 0 0112 21c-1.268 0-2.39-.63-3.068-1.593a3.746 3.746 0 01-3.296-1.043 3.745 3.745 0 01-1.043-3.296A3.745 3.745 0 013 12c0-1.268.63-2.39 1.593-3.068a3.745 3.745 0 011.043-3.296 3.746 3.746 0 013.296-1.043A3.746 3.746 0 0112 3c1.268 0 2.39.63 3.068 1.593a3.746 3.746 0 013.296 1.043 3.746 3.746 0 011.043 3.296A3.745 3.745 0 0121 12z"></path>
						</svg>
					</td>
					<td></td>
				</tr>
				<tr>
					<th>Ready for Auditor</th>
					<td>
						<div class="whitespace-normal">This status is used by the InfoSec team to tell the auditor or
							reviewer that they are ready for the control to be looked at. The auditor can review the
							control and determine if it is satisfied
						</div>
					</td>
					<td>
						<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
							 stroke="currentColor" class="w-6 h-6 text-green-400">
							<path stroke-linecap="round" stroke-linejoin="round"
								  d="M9 12.75L11.25 15 15 9.75M21 12c0 1.268-.63 2.39-1.593 3.068a3.745 3.745 0 01-1.043 3.296 3.745 3.745 0 01-3.296 1.043A3.745 3.745 0 0112 21c-1.268 0-2.39-.63-3.068-1.593a3.746 3.746 0 01-3.296-1.043 3.745 3.745 0 01-1.043-3.296A3.745 3.745 0 013 12c0-1.268.63-2.39 1.593-3.068a3.745 3.745 0 011.043-3.296 3.746 3.746 0 013.296-1.043A3.746 3.746 0 0112 3c1.268 0 2.39.63 3.068 1.593a3.746 3.746 0 013.296 1.043 3.746 3.746 0 011.043 3.296A3.745 3.745 0 0121 12z"></path>
						</svg>
					</td>
					<td></td>
				</tr>
				<tr>
					<th>Complete</th>
					<td>
						<div class="whitespace-normal">This status is used by the auditor/reviewer to signify that the
							control is complete and no further work is required
						</div>
					</td>
					<td></td>
					<td>
						<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
							 stroke="currentColor" class="w-6 h-6 text-green-400">
							<path stroke-linecap="round" stroke-linejoin="round"
								  d="M9 12.75L11.25 15 15 9.75M21 12c0 1.268-.63 2.39-1.593 3.068a3.745 3.745 0 01-1.043 3.296 3.745 3.745 0 01-3.296 1.043A3.745 3.745 0 0112 21c-1.268 0-2.39-.63-3.068-1.593a3.746 3.746 0 01-3.296-1.043 3.745 3.745 0 01-1.043-3.296A3.745 3.745 0 013 12c0-1.268.63-2.39 1.593-3.068a3.745 3.745 0 011.043-3.296 3.746 3.746 0 013.296-1.043A3.746 3.746 0 0112 3c1.268 0 2.39.63 3.068 1.593a3.746 3.746 0 013.296 1.043 3.746 3.746 0 011.043 3.296A3.745 3.745 0 0121 12z"></path>
						</svg>
					</td>
				</tr>
				</tbody>
			</table>
				</div>
				<div class="modal-action">
					<button class="btn" @click="showReviewHelp=false">Close</button>
				</div>
			</div>
		</div>
	</div>
	<div>
		<div data-theme="dim" class="modal" x-bind:class="{ 'modal-open': showAuditHelp }">
			<div class="modal-box w-11/12 max-w-4xl">
				<form method="dialog">
					<button @click="showAuditHelp=false"
							class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕
					</button>
				</form>
				<h2 class="py-2 text-xl font-semibold px-6">Help</h2>
				<p class="card-body">
					When a user has the "Auditor" role in the project, they are able to audit the controls and subcontrols, add feedback, etc.
				</p>
				<div class="modal-action">
					<button class="btn" @click="showAuditHelp=false">Close</button>
				</div>
			</div>
		</div>
	</div>
	<div>
		<div data-theme="dim" class="modal" x-bind:class="{ 'modal-open': showNAModalDisable}">
			<div class="modal-box w-11/12 max-w-4xl">
				<form method="dialog">
					<button @click="showNAModalDisable=false"
							class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕
					</button>
				</form>
				<h2 class="py-2 text-xl font-semibold px-6">Warning</h2>
				<p class="card-body">
					You are about to set the control as Not Applicable. If you proceed, the control will be disabled in the project and may impact your completion percentage. You can always re-enable the control.
				</p>
				<div class="modal-action">
					<button class="btn" @click="showNAModalDisable=false">Close</button>
					<button @click="setAsNotApplicable(selectedControl);showNAModalDisable=false" class="btn btn-error">Disable Control</button>
				</div>
			</div>
		</div>
	</div>
	<div>
		<div data-theme="dim" class="modal" x-bind:class="{ 'modal-open': showNAModalEnable }">
			<div class="modal-box w-11/12 max-w-4xl">
				<form method="dialog">
					<button @click="showNAModalEnable=false"
							class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕
					</button>
				</form>
				<h2 class="py-2 text-xl font-semibold px-6">Warning</h2>
				<p class="card-body">
					You are about to set the control as Applicable. If you proceed, the control will be included in the project and may impact your completion percentage. You can always disable the control.
				</p>
				<div class="modal-action">
					<button class="btn" @click="showNAModalEnable=false">Close</button>
					<button @click="setAsApplicable(selectedControl);showNAModalEnable=false" class="btn btn-success">Enable Control</button>
				</div>
			</div>
		</div>
	</div>
	<div>
		<div data-theme="dim" class="modal" x-bind:class="{ 'modal-open': addFeedbackModal }">
			<div class="modal-box w-11/12 max-w-4xl">
				<form method="dialog">
					<button @click="addFeedbackModal=false"
							class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕
					</button>
				</form>
				<h2 class="py-2 text-xl font-semibold px-6">Create Feedback</h2>
				<div class="grid grid-cols-6 px-6 mt-2 gap-4">
					<div class="col-span-6">
						<div role="alert" class="alert bg-base-200">
							<i class="ti ti-info-circle text-warning text-lg"></i>
							<span class="text-sm">Create feedback for the InfoSec team such as questions and/or remediation items.</span>
						</div>
					</div>
					<div class="col-span-6">
						<h5 class="font-semibold mb-2 text-sm">Feedback Title</h5>
						<input x-model="feedbackTitle" type="text" placeholder="Provide a title for the feedback" class="input text-sm input-sm input-bordered w-full" />
					</div>
					<div class="col-span-6">
						<h5 class="font-semibold mb-2 text-sm">Feedback Description</h5>
						<textarea x-model="feedbackDescription" class="textarea textarea-bordered w-full" placeholder="Provide a description for the InfoSec team"></textarea>
					</div>
					<div class="col-span-6">
						<h5 class="font-semibold mb-2 text-sm">Relates to Subcontrol (Optional)</h5>
						<div class="flex flex-row">
							<select x-model="feedbackRelatesTo" class="select select-sm select-bordered w-full">
							  <option :selected="!item.subcontrol_id">Select a Subcontrol</option>
								<template x-for="subcontrol in selectedControl.subcontrols">
									<option :value="subcontrol.id" x-text="getSubcontrolSelection(subcontrol)"></option>
								</template>
							</select>
						</div>
					</div>

				</div>
				<div class="modal-action">
					<button class="btn" @click="addFeedbackModal=false">Close</button>
					<button :disabled="!feedbackTitle" class="btn btn-success" @click="addItem">Create Feedback</button>
				</div>
			</div>
		</div>
	</div>
	<div>
		<div data-theme="dim" class="modal" x-bind:class="{ 'modal-open': showFeedbackModal }">
			<div class="modal-box w-11/12 max-w-4xl">
				<form method="dialog">
					<button @click="showFeedbackModal=false"
							class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕
					</button>
				</form>

				<h2 class="py-2 text-xl font-semibold px-6">Feedback</h2>
				<div class="grid grid-cols-6 px-6 gap-x-10">
					<div class="col-span-3 mt-4">
						<div class="grid grid-cols-6 gap-4">
							<div class="col-span-full space-y-2">
								<label class="text-sm font-medium"><i class="ti ti-alert-triangle mr-2 text-warning"></i>Feedback Title</label>
								<div class="w-full leading-none my-auto">
									<input :disabled="!isAuditor" type="text"
										   class="text-md w-full bg-base-200 input input-sm leading-none"
										   x-model="selectedFeedback.title"
										   placeholder="Add Feedback..."/>
								</div>
							</div>
							<div class="col-span-full space-y-2">
								<label class="block text-sm font-medium"><i class="ti ti-alert-triangle mr-2 text-warning"></i>Description from Auditor</label>
								<textarea :disabled="!isAuditor" class="textarea bg-base-200 w-full leading-tight"
										  rows="3" x-model="selectedFeedback.description"
										  placeholder="Describe the feedback/question for the InfoSec team. For example, 'Supplied evidence is not sufficient for X reasons'"></textarea>
							</div>

							<div class="col-span-full space-y-2">
								<label x-show="isAuditor || selectedFeedback.relates_to" class="text-sm font-medium"><i class="ti ti-alert-triangle text-md mr-2 text-warning"></i>(Optional) Which subcontrol does the feedback relate to?</label>
								<div x-show="isAuditor || selectedFeedback.relates_to" class="flex flex-row">
									<select :disabled="!isAuditor" x-model="selectedFeedback.relates_to" class="select select-sm select-bordered w-full">
									  <option disabled :selected="!selectedFeedback.relates_to">Select a Subcontrol</option>
										<template x-for="subcontrol in selectedControl.subcontrols">
											<option :selected="selectedFeedback.relates_to === subcontrol.id" :value="subcontrol.id" x-text="getSubcontrolSelection(subcontrol)"></option>
										</template>
									</select>
									<button class="btn ml-8" x-show="selectedFeedback.subcontrol_id" @click="openSubcontrolInModalById(selectedFeedback.subcontrol_id)">View Subcontrol<i class="ti ti-arrow-right ml-2 text-lg"></i></button>
								</div>
							</div>
						</div>
					</div>
					<div class="col-span-3 mt-4">
						<div class="col-span-full space-y-2">
							<label class="text-sm font-medium"><i x-show="!selectedFeedback.response" class="ti ti-alert-triangle text-md mr-2 text-warning"></i>
							Response from InfoSec Team</label>
							<textarea :disabled="isAuditor || !isAuditor && (selectedControl.review_status === 'ready for auditor' || selectedControl.review_status === 'complete')" :class="{'border border-error':!isAuditor && !selectedFeedback.response}" :disabled="isAuditor" class="textarea bg-base-200 w-full leading-tight"
								  rows="10" @change="updateItem(selectedFeedback)"
								  x-model="selectedFeedback.response"
								  placeholder="Provide a explanation to the Auditors feedback"></textarea>
						</div>
					</div>

					<div x-show="isAuditor" class="col-span-full">
						<div class="divider divider-warning font-semibold text-sm">Auditor Review</div>
						<table class="table bg-base-200">
							<thead>
							  <tr>
								<th>Description</th>
								<th class="w-1/4">Action</th>
							  </tr>
							</thead>
							<tbody>
							  <tr>
								<td>Mark the feedback as complete. There are no more action items for either party.</td>
								<td><button @click="markFeedbackAsComplete(selectedFeedback)" class="btn btn-xs btn-success">Mark as Complete</button></td>
							  </tr>
							  <tr>
								<td>Create a record in the Risk Register. Use this if the InfoSec response was not adequete (e.g. lack of MFA).</td>
								<td><button :disabled="selectedFeedback.risk_relation" @click="createRiskRecordForFeedback(selectedFeedback)" class="btn btn-xs btn-warning">Create Risk Record</button></td>
							  </tr>
							</tbody>
						  </table>
					</div>

				</div>
				<div class="modal-action">
					<button class="btn" @click="showFeedbackModal=false">Close</button>
				</div>
			</div>
		</div>
	</div>

	<div>
		<div data-theme="dim" class="modal" x-bind:class="{ 'modal-open': showViewEvidenceModal }">
			<div class="modal-box w-11/12 max-w-4xl">
				<form method="dialog">
					<button @click="showViewEvidenceModal=false"
							class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕
					</button>
				</form>
				<h2 class="py-2 text-xl font-semibold px-6">Update Evidence</h2>
				<div class="grid grid-cols-6 px-6 mt-4 gap-y-4 gap-x-2">
					<div class="col-span-6">
					  <label class="block text-sm font-medium mb-2">Evidence Name</label>
					  <input type="text"
						   class="input input-sm input-bordered w-full"
						   x-model="selectedEvidence.name"
						   placeholder="Provide name for the evidence..."/>
					</div>
					<div class="col-span-3">
					  <label class="block text-sm font-medium mb-2">Description</label>
					  <textarea class="textarea textarea-bordered w-full" x-model="selectedEvidence.description" placeholder="Add description"></textarea>
					</div>
					<div class="col-span-3">
					  <label class="block text-sm font-medium mb-2">Content</label>
					  <textarea class="textarea textarea-bordered w-full" x-model="selectedEvidence.content" placeholder="Add content"></textarea>
					</div>
				   <div class="col-span-6">
						  <div class="flex flex-row gap-x-2 mb-2">
							<i x-show="!selectedEvidence.file_name" class="ti ti-alert-triangle text-error my-auto"></i>
							<label class="block text-sm font-medium">Evidence File</label>
						  </div>
						  <table x-show="selectedEvidence.file_name" class="table bg-base-200">
							<thead>
							  <tr>
								<th class="py-4">Uploaded File</th>
								<th class="py-4">Backend</th>
								<th class="text-center w-1">Actions</th>
							  </tr>
							</thead>
							<tbody>
							  <tr>
								<td class="font-semibold" x-text="selectedEvidence.file_name"></td>
								<td class="font-semibold" x-text="selectedEvidence.file_provider.toUpperCase()"></td>
								<td>
									<div class="flex flex-row gap-x-4">
<!--                                        <button @click="deleteEvidenceFile(selectedEvidence)" class="btn btn-xs btn-error"><i class="ti ti-trash"></i></button>-->
										<a :href="'/api/v1/evidence/'+selectedEvidence.id+'/file'" :download="selectedEvidence.file['name']" class="btn btn-xs bg-base-100">Download</a>
									</div>
								</td>
							  </tr>
							</tbody>
						  </table>
				   </div>

					<div x-show="!selectedEvidence.file_name" class="col-span-6">
					  <input type="file" id="updateEvidenceUploader">
					</div>
				</div>
				<div class="modal-action">
					<button class="btn" @click="showViewEvidenceModal=false">Close</button>
					<button @click="updateEvidence" class="btn btn-success">Update Evidence</button>
				</div>
			</div>
		</div>
	</div>
	<div>
		<div data-theme="dim" class="modal" x-bind:class="{ 'modal-open': showAssociationModal }">
			<div class="modal-box w-11/12 max-w-4xl">
				<form method="dialog">
					<button @click="showAssociationModal=false"
							class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕
					</button>
				</form>
				<h2 class="py-2 text-xl font-semibold px-6">Associate Subcontrols with Evidence</h2>
				<div class="card-body">
				  <table class="table table-xs">
					<thead>
					  <tr>
						<th class="w-1">Associated</th>
						<th>Subcontrol</th>
					  </tr>
					</thead>
					<tbody>
					  <template x-for="subcontrol in subcontrols">
					  <tr>
						<th>
							<button x-show="associatedEvidence.controls.some(control => control.id === subcontrol.id)" @click="removeAssociation(subcontrol)" class="btn btn-sm btn-success"><i class="ti ti-check"></i></button>
							<button x-show="!associatedEvidence.controls.some(control => control.id == subcontrol.id)" @click="addAssociation(subcontrol)" class="btn btn-sm"><i class="ti ti-square-rounded"></i></button>
						</th>
						<td x-text="subcontrol.ref_code+' - '+subcontrol.name"></td>
					  </tr>
					  </template>
					</tbody>
				  </table>
				</div>
				<div class="modal-action">
					<button class="btn" @click="showAssociationModal=false">Close</button>
				</div>
			</div>
		</div>
	</div>
	<div>
		<div data-theme="dim" class="modal" x-bind:class="{ 'modal-open': showCreateEvidenceModal }">
			<div class="modal-box w-11/12 max-w-4xl">
				<form method="dialog">
					<button @click="showCreateEvidenceModal=false"
							class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕
					</button>
				</form>
				<h2 class="py-2 text-xl font-semibold px-6">Create Evidence</h2>
				<div class="grid grid-cols-6 px-6 mt-4 gap-y-4 gap-x-2">
					<div class="col-span-6">
					  <label class="block text-sm font-medium mb-2">Evidence Name</label>
					  <input type="text"
						   class="input input-sm input-bordered w-full"
						   x-model="createEvidencePayload.name"
						   placeholder="Provide name for the evidence..."/>
					</div>
					<div class="col-span-3">
					  <label class="block text-sm font-medium mb-2">Description</label>
					  <textarea class="textarea textarea-bordered w-full" x-model="createEvidencePayload.description" placeholder="Add description"></textarea>
					</div>
					<div class="col-span-3">
					  <label class="block text-sm font-medium mb-2">Content</label>
					  <textarea class="textarea textarea-bordered w-full" x-model="createEvidencePayload.content" placeholder="Add content"></textarea>
					</div>
					<div class="col-span-6">
					  <label class="block text-sm font-medium mb-2">Evidence File</label>
					  <input type="file" id="createEvidenceUploader">
					  <p class="text-xs text-warning mt-2">Note: Only 1 evidence file is attached to each Evidence object.</p>
					</div>
				</div>
				<div class="modal-action">
					<button class="btn" @click="showCreateEvidenceModal=false">Close</button>
					<button :disabled="!createEvidencePayload.name" @click="createEvidence" class="btn btn-success">Create New Evidence</button>
				</div>
			</div>
		</div>
	</div>
	<div>
		<div class="modal" x-bind:class="{ 'modal-open': showAttachModal }">
			<div class="modal-box max-w-2xl">
				<form method="dialog">
					<button @click="showAttachModal=false"
							class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕
					</button>
				</form>
				<h2 class="text-xl font-semibold px-6 my-4">Attach Evidence</h2>
				<p class="text-sm font-semibold px-6 mb-4">Select evidence below to associate it with your subcontrol. If you prefer to create new evidence <span class="underline hover:cursor-pointer" @click="showAttachModal=false;openCreateEvidenceModal()">click here.</span></p>
				<div class="grid grid-cols-10 gap-6 px-6 pt-0">

					<div class="col-span-10">
						<label class="block text-sm font-medium mb-2">Selected Evidence</label>
						<div class="msa-wrapper border border-base-content border-opacity-40 rounded-lg">
							<input x-model="seSelectedString" type="text" id="msa-input" aria-hidden="true" x-bind:aria-expanded="seListActive.toString()" aria-haspopup="tag-list" hidden>
							<div class="input-presentation rounded-lg" @click="seListActive = !seListActive" @click.away="seListActive = false" x-bind:class="{'active': seListActive}">
								<span class="text-sm font-semibold" x-show="seSelected.length == 0">Select Evidence</span>
								<template x-for="(tag, index) in seSelected">
									<div class="tag-badge bg-base-200">
										<span x-text="tag"></span>
										<button x-bind:data-index="index" @click.stop="seRemoveMe($event)">x</button>
									</div>
								</template>
							</div>
							<ul class="overflow-auto h-52" id="tag-list" x-show.transition="seListActive" role="listbox">
								<template x-for="(tag, index, collection) in seUnselected">
									<li class="hover:cursor-pointer hover:bg-base-200 hover:p-2 hover:rounded-lg mx-5 text-sm font-semibold mb-2" x-show="!seSelected.includes(tag)" x-bind:value="tag" x-text="tag" aria-role="button" @click.stop="seAddMe($event)" x-bind:data-index="index" role="option"></li>
								</template>
							</ul>
						</div>
					</div>
				</div>
				<div class="modal-action">
					<button class="btn" @click="showAttachModal=false">Close</button>
					<button @click="saveAttachedEvidence" class="btn btn-success">Update</button>
				</div>
			</div>
		</div>
	</div>

	<div>
		<div class="modal" x-bind:class="{ 'modal-open': showQuickHelpModal }">
			<div class="modal-box max-w-2xl">
				<form method="dialog">
					<button @click="showQuickHelpModal=false"
							class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕
					</button>
				</form>
				<h2 class="text-xl font-semibold px-6 my-4">Help</h2>
				<p class="text-sm font-semibold px-6 mb-4" x-text="quickHelpText"></p>
				<div class="modal-action">
					<button class="btn" @click="showQuickHelpModal=false">Close</button>
				</div>
			</div>
		</div>
	</div>
	<div>
		<div class="modal" x-bind:class="{ 'modal-open': showReviewModal }">
			<div class="modal-box max-w-2xl">
				<form method="dialog">
					<button @click="showReviewModal=false"
							class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕
					</button>
				</form>
				<h2 class="text-xl font-semibold px-6 my-4">Update Review Status</h2>
				<div x-show="isAuditor" class="px-6">
					<p x-show="tempReviewStatus==='infosec action'">You are updating the status to 'Infosec Action'. The Infosec team will need to review your feedback and respond to your comments.</p>
					<p x-show="tempReviewStatus==='complete'">You are updating the status to 'Complete'. The InfoSec team will be notified and there will be no more actions required.</p>

				</div>
			   <div x-show="!isAuditor" class="px-6">
					<p x-show="tempReviewStatus==='ready for auditor'">You are updating the status to 'Ready for Auditor'. The auditor will be notified that the control is ready for their review. Please be sure to respond to any feedback and/or comments.</p>
				</div>
				<div class="modal-action">
					<button class="btn" @click="showReviewModal=false">Close</button>
					<button class="btn btn-success" @click="updateReviewStatus(tempReviewStatus);showReviewModal=false">Continue</button>
				</div>
			</div>
		</div>
	</div>
	<div x-show="showUpdateAssigneeModal" class="modal modal-open">
		<div class="modal-box">
			<h3 class="font-bold text-lg mb-4" x-text="'Update Assignee for '+rowsSelected.length+' controls'"></h3>
			<div class="form-control">
				<label class="label">
					<span class="label-text">Select User</span>
				</label>
				<select x-model="selectedAssignee" class="select select-bordered w-full">
					<option value="">Select a user...</option>
					<template x-for="user in projectUsers">
						<option :value="user.id" x-text="user.email"></option>
					</template>
				</select>
				<p class="text-xs text-warning mt-2">Note: This will override the assignee for all subcontrols associated with the control.</p>
			</div>
			<div class="modal-action">
				<button @click="showUpdateAssigneeModal = false" class="btn">Cancel</button>
				<button @click="updateAssignee" class="btn btn-primary">Update</button>
			</div>
		</div>
	</div>
	<div x-show="showSetApplicableModal" class="modal modal-open">
		<div class="modal-box">
			<h3 class="font-bold text-lg mb-4" x-text="'Set Controls as Applicable for '+rowsSelected.length+' controls'"></h3>
			<div class="form-control">
				<div role="alert" class="alert">
					<svg
					  xmlns="http://www.w3.org/2000/svg"
					  fill="none"
					  viewBox="0 0 24 24"
					  class="stroke-warning h-6 w-6 shrink-0">
					  <path
						stroke-linecap="round"
						stroke-linejoin="round"
						stroke-width="2"
						d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
					</svg>
					<span x-text="'You have selected '+rowsSelected.length+' controls to set as applicable. Please confirm to proceed.'"></span>
				</div>
			</div>
			<div class="modal-action">
				<button @click="showSetApplicableModal = false" class="btn">Cancel</button>
				<button @click="updateApplicable" class="btn btn-primary">Confirm</button>
			</div>
		</div>
	</div>
	<div x-show="showSetNotApplicableModal" class="modal modal-open">
		<div class="modal-box">
			<h3 class="font-bold text-lg mb-4" x-text="'Set Controls as Not Applicable for '+rowsSelected.length+' controls'"></h3>
			<div class="form-control">
				<div role="alert" class="alert">
					<svg
					  xmlns="http://www.w3.org/2000/svg"
					  fill="none"
					  viewBox="0 0 24 24"
					  class="stroke-warning h-6 w-6 shrink-0">
					  <path
						stroke-linecap="round"
						stroke-linejoin="round"
						stroke-width="2"
						d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
					</svg>
					<span x-text="'You have selected '+rowsSelected.length+' controls to set as not applicable. Please confirm to proceed.'"></span>
				</div>
			</div>
			<div class="modal-action">
				<button @click="showSetNotApplicableModal = false" class="btn">Cancel</button>
				<button @click="updateNotApplicable" class="btn btn-primary">Confirm</button>
			</div>
		</div>
	</div>
	<div x-show="showSetTagsModal" class="modal modal-open">
		<div class="modal-box">
			<h3 class="font-bold text-lg mb-4" x-text="'Update Tags for '+rowsSelected.length+' controls'"></h3>
			<p class="text-sm font-semibold my-2">Select tags below to associate them with your controls. If you prefer to create new tags <span class="underline hover:cursor-pointer" @click="showSetTagsModal=false;switchTab({tab: 'control tags'})">click here.</span></p>
			<div class="form-control">
				<label class="label">
					<span class="label-text">Select Tags</span>
				</label>
				<select @change="addTempTag" class="select select-bordered w-full">
					<option value="">Select a tag...</option>
					<template x-for="tag in projectTags">
						<option :value="tag.name" x-text="tag.name"></option>
					</template>
				</select>
				<div class="flex flex-wrap gap-2 mt-2" x-show="tempControlTags.length > 0">
					<span class="text-sm font-semibold my-auto">Selected Tags:</span>
					<template x-for="tag in tempControlTags">
						<div class="pill bg-base-300 my-auto hover:cursor-pointer" @click="removeTempTag(tag)">
							<i class="ti ti-x text-sm text-error"></i>
							<span class="text-ss" x-text="tag"></span>
						</div>
					</template>
				</div>
				<p class="text-xs text-warning mt-2">Note: The selected tags will override the existing tags for the selected controls.</p>
			</div>
			<div class="modal-action">
				<button @click="showSetTagsModal = false" class="btn">Cancel</button>
				<button :class="{'btn-disabled': tempControlTags.length === 0}" @click="updateTags" class="btn btn-primary">Update</button>
			</div>
		</div>
	</div>	
	<div x-show="showCreateTagModal" class="modal modal-open">
		<div class="modal-box">
			<h3 class="font-bold text-lg mb-4">Create New Tag</h3>
			<div class="form-control">
				<label class="label">
					<span class="label-text">Tag Name</span>
				</label>
				<input type="text" x-model="newTagName" class="input input-bordered w-full">
			</div>
			<div class="modal-action">
				<button @click="showCreateTagModal = false" class="btn">Cancel</button>
				<button :class="{'btn-disabled': newTagName.length === 0}" @click="createTag" class="btn btn-primary">Create</button>
			</div>
		</div>
	</div>	
	<div x-show="showCreateCustomControlModal" class="modal modal-open">
		<div class="modal-box">
			<h3 class="font-bold text-lg mb-4">Create Custom Control</h3>
			<div role="alert" class="alert">
				<svg
				  xmlns="http://www.w3.org/2000/svg"
				  fill="none"
				  viewBox="0 0 24 24"
				  class="stroke-warning h-6 w-6 shrink-0">
				  <path
					stroke-linecap="round"
					stroke-linejoin="round"
					stroke-width="2"
					d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
				</svg>
				<span>You are creating a custom control. By default, the control will not be added to the underlying framework.</span>
			</div>			
			<div class="form-control">
				<label class="label">
					<span class="label-text">Title of the control</span>
				</label>
				<input type="text" x-model="customControlName" class="input input-sm input-bordered w-full">
			</div>
			<div class="form-control">
				<label class="label">
					<span class="label-text">Description of the control</span>
				</label>
				<textarea x-model="customControlDescription" class="textarea text-lg textarea-bordered w-full"></textarea>
			</div>
			<div class="form-control">
				<label class="label">
					<span class="label-text">Implementation Guidance</span>
				</label>
				<textarea x-model="customControlGuidance" class="textarea text-lg textarea-bordered w-full"></textarea>
			</div>
			<div class="modal-action">
				<button @click="showCreateCustomControlModal = false" class="btn">Cancel</button>
				<button :class="{'btn-disabled': customControlName.length === 0}" @click="createCustomControl" class="btn btn-primary">Create</button>
			</div>
		</div>
	</div>

</div>

{%endblock%}

{%block extrajs%}
<script>
function project(){
	return {
		init() {
		  this.hasSidebar = false;
		  if ("{{project.has_auditor(current_user)}}".toLowerCase() === "true") {
			this.isAuditor = true
		  } else {
			this.isAuditor = false
		  }

		  this.$watch('seSelected', value => seSelectedString = value.join(','))

		  this.$watch(
			"controlFilter", (newValue, oldValue) => {
				this.filteringControls = true
				this.setControlData()
				setTimeout(() => {
					this.filteringControls = false
				}, 1000);
			   this.setFiltersForControl(newValue)
			}
		  )
		  this.$watch(
			"evidenceFilter", (newValue, oldValue) => {
				if (newValue.name.length > 0) {
					this.filteredEvidence = this.projectEvidence.filter(item => item.name.includes(newValue.name));
				} else {
					this.filteredEvidence = this.projectEvidence
				}

			}
		  )
		  this.$watch(
			"filteredRisks", (newValue, oldValue) => {
				this.drawTable({"selector": "#risk-table", "tableData":newValue, "formatter": "risks"})
		  })
		  this.$watch(
			"riskFilterStatus", (newValue, oldValue) => {this.riskViewFilter(newValue)}
		  )
		  this.$watch(
			"riskFilterPriority", (newValue, oldValue) => {this.riskViewFilter(newValue)}
		  )
		  this.$watch(
			"riskFilterRisk", (newValue, oldValue) => {this.riskViewFilter(newValue)}
		  )
		  this.$watch(
                "filter", (newValue, oldValue) => {
                    this.hasFilter = !Object.values(this.filter).every(value => value === null) || this.search.length>0;
					this.filterReports()
                }
		    )
		    this.$watch(
                "search", (newValue, oldValue) => {
                    this.hasFilter = !Object.values(this.filter).every(value => value === null) || this.search.length>0;
					this.filterReports()
                }
		    )		  

		  // TODO
		  // projectData.show_driver (boolean)
<!--          setTimeout(() => {-->
<!--              this.driverQuestionnaireTour()-->
<!--              this.dropZoneHeight = `${document.getElementById("main").clientHeight+document.getElementById("pageHeader").clientHeight}px`;-->
<!--          }, 1000);-->

		  this.setFiltersForControl()

		  this.getUsersForProject()
		  this.getProject()
		  this.getControls(useCache=true)
		  this.getPolicies()
		  //this.getTenantPolicies()
		  this.getProjectTags()
		  this.getRisks()
		  this.getProjectEvidence()
		  this.loadComments()
		  var params = new window.URLSearchParams(window.location.search);
		  this.switchTab({"tab": params.get('tab') ?? "summary", "view": params.get('view') ?? "default"})

		  this.initCompletionChart()
		},
		openTodoId: null,
		rowsSelected: [],
		showCreateCustomControlModal: false,
		customControlName: "",
		customControlDescription: "",
		customControlGuidance: "",
		showUpdateAssigneeModal: false,		
		showSetApplicableModal: false,
		showSetNotApplicableModal: false,
		showSetTagsModal: false,
		showAuditHelp: false,
		showReviewHelp: false,
		todos: [],
		newTagName: "",
		showCreateTagModal: false,
		showStats: false,
		showDeleteMessage: false,
		showRoleHelp: false,
		showAttachModal: false,
		selectedUser: {},
		addControlModal: false,
		showEditUserModal: false,
		showRemoveUserModal: false,
		showRemoveEvidenceModal: false,
		addUserId: null,
		addUserRole: "viewer",
		showAddUser: false,
		projectUsers: [],
		controlTab: "overview",
		subcontrolTab: "overview",
		projectData: {},
		projectId: "{{project.id}}",
		isAuditor: false,
		showPolicyModal: false,
		showControlModal: false,
		showMetadataModal: false,
		currentUserEmail: "{{current_user.email}}",
		simpleInterface: false,
		policyId: null,
		controls: [],
		subcontrols: [],
		filteredControls: [],
		filteredSubControls: [],
		showFeedbackModal: false,
		selectedFeedback: null,
		policies: [],
		risks: [],
		filteredRisks: [],
		deleteControlMessage: false,
		showDeleteControlMessage: false,
		messages: [],
		riskMessages: [],
		messagesForControl: [],
		tenantPolicies: [],
		tabs: ["summary", "controls", "policies", "evidence", "comments", "risk register", "settings", "user management", "control tags"],
		loadingSkeleton: '<span class="loading loading-dots loading-lg"></span>',
		tabLoading: true,
		tableLoading: true,
		selectedControl: {},
		selectedTab: "summary",
		view: "default",
		contextEditor: null,
		respMatrixOwner: [],
		respMatrixOperator: [],
		policyAcceptance: "not started",
		showHelpMenu: false,

		// vars for controls tab
		controlFilter: {},
		controlsFilterOwner: "",
		controlsFilterOperator: "",
		evidenceFilter: {},

		//uppy: null,
		loadingEvidence: false,

		riskFilterStatus: null,
		riskFilterPriority: null,
		riskFilterRisk: null,
		riskFilter: [],
		policyFilter: null,
		controlsGrid: null,
		subcontrolsGrid: null,
		policyGrid: null,
		riskGrid: null,
		selectedPolicy: {},
		selectedRisk: {},
		showSubControlSidebar: true,
		showAddPolicy: false,
		currentMessage: "",
		controlCurrentMessage: "",
		updatedAccessLevel: false,
		showCreateRisk: false,
		riskPayload: {},
		controlApplicableCount: 0,
		controlCompleteCount: 0,
		controlEvidenceCount: 0,
		controlImplementedCount: 0,
		subcontrolApplicableCount: 0,
		subcontrolCompleteCount: 0,
		subcontrolEvidenceCount: 0,
		subcontrolImplementedCount: 0,
		editSubColumnsModal: false,
		disableRefreshBtn: false,
		removeEvidenceIndex: "",
		loadingProjectData: true,
		showCreateEvidenceModal: false,
		showViewEvidenceModal: false,
		selectedEvidence: {},
		updatePondInstance: null,
		createPondInstance: null,
		createEvidencePayload: {},
		expandedRow: null,
		isControlOpen: false,
		testSelectedSubControl: null,
		hideFilterTab: false,
		loadingControls: true,
		loadingControlsMessage: "Loading controls. Please wait...",
		projectRefreshRequired: false,
		filteringControls: false,
		emptyControlFilter: false,
		addFeedbackModal: false,
		feedbackTitle: "",
		feedbackDescription: "",
		feedbackRelatesTo: "",
		controlOwner: "",
		tempReviewStatus: "",
		previouslySelectedRowId: "",
		tempTagName: "",
		showAssociationModal: false,
		associatedEvidence: {},
		selectedControlTab: null,
		showNAModalDisable:false,
		showNAModalEnable:false,
		selectedControl: null,
		activeSideTab: "details",
		activeSubSideTab: "details",
		selectedSubControl:null,
		showQuickHelpModal: false,
		quickHelpText: "",
		showReviewModal: false,
		evidenceFile: null,
		selectedAssignee: null,
		projectTags: [],
		selectedTags: [],
		tempControlTags: [],
		showDashboard: false,
		loadingReports: true,
		hasFilter: false,
		riskRowsSelected: [],
		filter: {
          status: null,
          impact: null
        },
		search: "",

		activeReportTab: "overview",

		controlReviewStatuses: {
			"infosec action": 0,
			"ready for auditor": 0,
			"complete": 0
		},
		controlStatuses: {
			"applicable": 0,
			"not applicable": 0,
			"not started": 0,
			"in progress": 0,
			"complete": 0
		},
		implementedStatuses: {
			"not implemented": 0,
			"partially implemented": 0,
			"fully implemented": 0
		},
		evidenceStatus: {
			"has evidence": 0,
			"missing evidence": 0
		},
		idToProgressBarMapping: {},
		policyTableHeaders: [
		  {"field": "id", "headerName": "#", "width": 25, "filter": "agTextColumnFilter", "hide": true},
		  {"field": "name", "headerName": "Name", "filter": "agTextColumnFilter", "cellClass": "capitalize"},
		  {"field": "description", "headerName": "Description", "filter": "agTextColumnFilter"},
		  {"field": "accepted", "headerName": "Accepted", "filter": "agTextColumnFilter", "cellRenderer": booleanBadge},
		  {"field": "version", "headerName": "Version", "filter": "agTextColumnFilter", "cellClass": "capitalize"},
		  {"field": "reviewer", "headerName": "Reviewer", "filter": "agTextColumnFilter"},

		],
		riskTableHeaders: [
		  {"field": "id", "headerName": "#", "width": 25, "filter": "agTextColumnFilter", "hide": true},
		  {"field": "title", "headerName": "Title", "filter": "agTextColumnFilter", "cellClass": "capitalize"},
		  {"field": "status", "headerName": "Status", "filter": "agTextColumnFilter", "cellRenderer": riskStatusToBadge},
		  {"field": "risk", "headerName": "Risk", "filter": "agTextColumnFilter", "cellRenderer": riskToVertBar},
		  {"field": "priority", "headerName": "Priority", "filter": "agTextColumnFilter", "cellRenderer": priorityToVertBar},
		],
		// add new functions here
		setFiltersForControl: function(controlFilter=null) {
			console.log("Updating control filter")
			const validKeys = new Set(["status", "review_status", "implemented_status", "owner", "name", "evidence_status", "tags"]);
			if (controlFilter === null) {
				controlFilter = {}; // Initialize it as an empty object
				validKeys.forEach(key => {
					const value = this.getURLParam(key);
					if (value !== "" && value !== null && value !== undefined) {
					if (key === "tags") {
						controlFilter[key] = Array.isArray(value)
						? value
						: value.split(',').map(v => v.trim()).filter(Boolean);
					} else {
						controlFilter[key] = value;
					}
					}
				});
				this.controlFilter = controlFilter;
			}

			// First, handle existing keys in controlFilter
			for (const key in controlFilter) {
			  if (validKeys.has(key)) {
				this.setURLParam(key, controlFilter[key]);
			  }
			}

			// Second, ensure missing keys are deleted
			for (const key of validKeys) {
			  if (!(key in controlFilter)) {
				this.deleteURLParam(key);
			  }
			}

		},
		filterReports: function() {
			if (!this.risks.length) return [];
		  	const filtered = this.risks.filter(report => {
			  const statusMatch = this.filter.status ? report.status === this.filter.status : true;
			  const riskMatch = this.filter.risk ? report.risk === this.filter.risk : true;

			  // Search filter (case-insensitive)
			  const searchMatch = this.search
				? report.title.toLowerCase().includes(this.search.toLowerCase())
				: true;

			  // Date filter (e.g., "Apr 2, 2025")
			  let dateMatch = true;
			  if (this.filter.createdWithin) {
				const createdAt = new Date(report.created_at);  // works with "Apr 2, 2025"
				const now = new Date();
				const diffMs = now - createdAt;

				let maxAgeMs;
				if (this.filter.createdWithin === "today") {
				  maxAgeMs = 24 * 60 * 60 * 1000;
				} else {
				  const days = parseInt(this.filter.createdWithin, 10);
				  maxAgeMs = days * 24 * 60 * 60 * 1000;
				}

				dateMatch = diffMs <= maxAgeMs;
			  }

			  return statusMatch && riskMatch && searchMatch && dateMatch;
		  	});
			this.filteredRisks = filtered;
		},
        disableFilter() {
            this.filter = {
              status: null,
              risk: null,
              triage_risk: null,
              createdWithin: null,
            }
            this.search = "";
            this.deselectedAllRiskRows()
        },		
        toggleAllRiskRows: function(checked) {
            if (checked) {
                this.riskRowsSelected = [];
                this.filteredRisks.forEach(report => {
                    this.riskRowsSelected.push(report.id);
                });
            } else {
                this.deselectedAllRiskRows()
            }
        },
        filterStatus(status) {
          this.filter.status = status;
        },
        filterRisk(risk) {
          this.filter.risk = risk;
        },
        filterTriageRisk(risk) {
          this.filter.triage_risk = risk;
        },
        filterCreatedAt(createdWithin) {
          this.filter.createdWithin = createdWithin;
        },		
        deselectedAllRiskRows: function() {
           this.riskRowsSelected = []
           this.$refs.selectAllRiskCheckbox.checked = false
        },
        toggleRiskRow: function(checked, reportId) {
            if (checked) {
                this.riskRowsSelected.push(reportId);
            } else {
                this.riskRowsSelected = this.riskRowsSelected.filter(id => id !== reportId);
            }
        },		
		changeTabInDrawer: function(tab) {
        	this.activeReportTab = tab;
			if (tab === "comments") {
				this.scrollToRecentRiskMessagesInDrawer()
			}
        },
        openReportDrawer: function(report) {
        	this.selectedReport = report;
        	if (this.selectedReport.risk === "critical") {
        		this.selectedReport.risk_level = 95
        	} else if (this.selectedReport.risk === "high") {
				this.selectedReport.risk_level = 80
        	} else if (this.selectedReport.risk === "moderate") {
				this.selectedReport.risk_level = 50
        	} else if (this.selectedReport.risk === "low") {
				this.selectedReport.risk_level = 20
        	} else {
        		this.selectedReport.risk_level = 10
        	}
			this.riskMessages = report.comments;
			document.getElementById('report-drawer').checked = true;
        },		
		closeReportDrawer: function() {
			this.previousSelectedReport = this.selectedReport
			this.selectedReport = {}
			document.getElementById('report-drawer').checked = false;
        },
		toggleDashboard() {
			this.showDashboard = !this.showDashboard;
			if (this.showDashboard) {
				this.switchToChart();
			}
		},
		switchToChart: function() {
		    this.$nextTick(() => {
				this.statusChartComponent();
				this.subcontrolsCompleteChartComponent();
				this.implementationStatusChartComponent();
				this.evidenceStatusChartComponent();
		    });
		},
		subcontrolsCompleteChartComponent() {
		  // Group and count status
		  const { complete, incomplete } = this.subcontrols.reduce(
			(acc, subcontrol) => {
				if (subcontrol.is_complete) {
				acc.complete += 1;
				} else {
				acc.incomplete += 1;
				}
				return acc;
			},
			{ complete: 0, incomplete: 0 }
		  );
		  const labels = ["Complete", "Incomplete"];
		  const data = [complete, incomplete];

		  this.chart = new ApexCharts(this.$refs.subcontrolsCompleteChart, {
			chart: {
			  type: 'donut'
			},
			labels: labels,
			series: data,
		    colors: labels.map(status => {
				switch (status) {
				  case 'Complete':
					return '#34d399'; // green-400
				  case 'Incomplete':
					return '#f87171'; // red-400
				  default:
					return '#d8d8d8'; // gray-300
				}
		    }),
		    dataLabels: {
				enabled: false
		    },
		  });
		  this.chart.render();			
		},
		statusChartComponent() {
		  // Group and count status
		  const statusCounts = this.controls.reduce((acc, control) => {
			const status = control.status || "unknown";
			acc[status] = (acc[status] || 0) + 1;
			return acc;
		  }, {});
		  const labels = Object.keys(statusCounts);
		  const uppercasedLabels = labels.map(label => label.toUpperCase());
		  const data = Object.values(statusCounts);

		  this.chart = new ApexCharts(this.$refs.statusChart, {
			chart: {
			  type: 'donut'
			},
			labels: uppercasedLabels,
			series: data,
		    colors: labels.map(status => {
				switch (status) {
				  case 'complete':
					return '#34d399'; // green-400
				  case 'not applicable':
					return '#f87171'; // red-400
				  case 'in progress':
					return '#fbbf24'; // yellow-400
				  default:
					return '#d8d8d8'; // gray-300
				}
		    }),
		    dataLabels: {
				enabled: false
		    },
		  });
		  this.chart.render();
		},
		implementationStatusChartComponent() {
		  const implementedStatusLabels = Object.keys(this.implementedStatuses);
		  const implementedStatusSeries = Object.values(this.implementedStatuses);
		  this.chart = new ApexCharts(this.$refs.implementationStatusChart, {
			chart: {
			  type: 'donut'
			},
			labels: implementedStatusLabels,
			series: implementedStatusSeries,
		    colors: implementedStatusLabels.map(status => {
				switch (status) {
				  case 'not implemented':
					return '#f87171'; // red-400
				  case 'partially implemented':
					return '#fbbf24'; // yellow-400
				  case 'fully implemented':
					return '#34d399'; // green-400
				  default:
					return '#d8d8d8'; // gray-300
				}
		    }),
		    dataLabels: {
				enabled: false
		    },
		  });
		  this.chart.render();
		},
		evidenceStatusChartComponent() {
		  const evidenceStatusLabels = Object.keys(this.evidenceStatus);
		  const evidenceStatusSeries = Object.values(this.evidenceStatus);
		  this.chart = new ApexCharts(this.$refs.evidenceStatusChart, {
			chart: {
			  type: 'donut'
			},
			labels: evidenceStatusLabels,
			series: evidenceStatusSeries,
		    colors: evidenceStatusLabels.map(status => {
				switch (status) {
				  case 'full evidence':
					return '#34d399'; // green-400
				  case 'no evidence':
					return '#f87171'; // red-400
				  default:
					return '#fbbf24';
				}
		    }),
		    dataLabels: {
				enabled: false
		    },
		  });
		  this.chart.render();
		},
		addTempTag(event) {
			const selectedTag = event.target.value;
			if (selectedTag && !this.tempControlTags.includes(selectedTag)) {
				this.tempControlTags.push(selectedTag);
			}
			event.target.value = ''; // reset dropdown
    	},
		removeTempTag(tag) {
			this.tempControlTags = this.tempControlTags.filter(t => t !== tag);
		},
		createTag: function() {
			request("POST",
				`/api/v1/projects/${this.projectId}/tags`,
				data => {
					this.projectTags.push(data)
					this.showCreateTagModal = false
					this.newTagName = ""
					toast("Tag created", "success");
				},
				error => {
					toast(error.message, "error");
				},
				{ "name": this.newTagName }
			);
		},
		updateApplicable: function() {
			if (this.rowsSelected.length === 0) {
				toast("Please select at least one control", "warning");
				return;
			}

			// Update each selected control
			this.rowsSelected.forEach(controlId => {
				request(
					"PUT",
					`/api/v1/project-controls/${controlId}/applicability`,
					data => {
						this.patchControl(data);
					},
					error => {
						toast(error.message, "error");
					},
					{ "applicable": true }
				);
			});
			toast("Set the controls as applicable", "success");
			this.showSetApplicableModal = false
		},
		getProjectTags: function() {
			request("GET",
				`/api/v1/projects/${this.projectId}/tags`,
				data => {
					this.projectTags = data
				},
				error => {
					toast(error.message, "error");
				}
			);
		},
		updateNotApplicable: function() {
			if (this.rowsSelected.length === 0) {
				toast("Please select at least one control", "warning");
				return;
			}

			// Update each selected control
			this.rowsSelected.forEach(controlId => {
				request(
					"PUT",
					`/api/v1/project-controls/${controlId}/applicability`,
					data => {
						this.patchControl(data);
					},
					error => {
						toast(error.message, "error");
					},
					{ "applicable": false }
				);
			});
			toast("Set the controls as not applicable", "warning");
			this.showSetNotApplicableModal = false
		},		
		updateTags: function() {
			if (this.rowsSelected.length === 0) {
				toast("Please select at least one control", "warning");
				return;
			}
			this.rowsSelected.forEach(controlId => {
				request("PUT",
					`/api/v1/project-controls/${controlId}/tags`,
					data => {
						this.refreshControlFromServer(controlId)
					},
					error => {
						toast(error.message, "error");
					},
					{ "tags": this.tempControlTags }
				);
			});
			toast("Updated tags")
			this.showSetTagsModal = false
			this.tempControlTags = []
		},
		updateAssignee: function() {
			if (this.rowsSelected.length === 0) {
				toast("Please select at least one control", "warning");
				return;
			}
			this.rowsSelected.forEach(controlId => {
				request("PUT",
					`/api/v1/project-controls/${controlId}/assignee`,
					data => {
						this.refreshControlFromServer(controlId)
					},
					error => {
						toast(error.message, "error");
					},
					{ "assignee-id": this.selectedAssignee }
				);
			});
			toast("Updated assignee")
			this.showUpdateAssigneeModal = false
		},
		openQuickHelp: function(helper) {
			if (parseInt(helper) === 1) {
				this.showQuickHelpModal = true
				this.quickHelpText = "The control status tells you the general progress of the control. Implement and add evidence for each subcontrol in order to complete the control."
				return
			} else if (parseInt(helper) === 2) {
				this.showQuickHelpModal = true
				this.quickHelpText = "The review status tells the InfoSec team and the Auditor of the current review status. Only the Auditor can move the control to 'complete'."
				return
			}
			toast("No help page registered", "warning")
		},
		addAssociation: function(subcontrol) {
		  data = {
			"evidence": this.associatedEvidence.id
		  }
		  request("PUT",
			`/api/v1/subcontrols/${subcontrol.id}/associate-evidence`,
			data => {
			  toast("Added association", level="success", duration=2000, bottom=true)
			  this.refreshControlFromServer(subcontrol.project_control_id)
			  this.associatedEvidence.controls.push(subcontrol)
			  return(data)
			},
			error => {
			  toast(error.message, "error");
			},
			data
		  );
		},
		removeAssociation: function(subcontrol) {
		  console.log(subcontrol)
		  data = {
			"evidence": this.associatedEvidence.id
		  }
		  request("DELETE",
			`/api/v1/subcontrols/${subcontrol.id}/disassociate-evidence`,
			data => {
			  toast("Removed association", level="success", duration=2000, bottom=true)
			  this.refreshControlFromServer(subcontrol.project_control_id)
			  this.associatedEvidence.controls = this.associatedEvidence.controls.filter(control => control.id !== subcontrol.id);
			  return(data)
			},
			error => {
			  toast(error.message, "error");
			},
			data
		  );

		},
        toggleAllRows: function(checked) {
            if (checked) {
                this.rowsSelected = [];
                this.filteredControls.forEach(control => {
                    this.rowsSelected.push(control.id);
                });
            } else {
                this.deselectedAllRows()
            }
        },
        deselectedAllRows: function() {
           this.rowsSelected = []
           this.$refs.selectAllCheckbox.checked = false
        },
        toggleRow: function(checked, controlId) {
            if (checked) {
                this.rowsSelected.push(controlId);
            } else {
                this.rowsSelected = this.rowsSelected.filter(id => id !== controlId);
            }
        },		
		addTag: function() {
			if (!this.tempTagName) {
				return
			}
			if (!this.controlFilter.tags) {
				this.controlFilter.tags = [];
			}

			this.controlFilter.tags.push(this.tempTagName);
			this.tempTagName = ""

		},
		removeTag: function(name) {
			this.controlFilter.tags = this.controlFilter.tags.filter(tag => tag !== name);
		},
		addTagToControl: function(control) {
			payload = {"tags": [this.tempTagName]}
			request("PUT",
				`/api/v1/controls/${control.id}/tags`,
				data => {
				  toast("Added tag")
				  this.tempTagName = ""
				  this.refreshControlFromServer(control.id)
				},
				error => {
				  toast(error.message, "error");
				},
				payload
			);
		},
		removeTagFromControl: function(control, tag_name) {
			payload = {"tags": [tag_name]}
			request("DELETE",
				`/api/v1/controls/${control.id}/tags`,
				data => {
				  toast("Removed tag")
				  this.tempTagName = ""
				  this.refreshControlFromServer(control.id)
				},
				error => {
				  toast(error.message, "error");
				},
				payload
			);
		},
		createRiskRecordForFeedback: function(feedback) {
			request("POST",
				`/api/v1/controls/${this.selectedControl.id}/feedback/${feedback.id}/risk`,
				data => {
				  toast("Created Risk Record")
				  this.refreshControlFromServer(this.selectedControl.id)
				},
				error => {
				  toast(error.message, "error");
				}
			);
		},
		markFeedbackAsComplete: function(feedback) {
			feedback.is_complete = true
			this.updateItem(feedback)

		},
		initCompletionChart: function() {
			request("GET",
				`/api/v1/projects/${this.projectId}/history`,
				data => {
					const generateColors = (data) => {
						return data.map((d, idx) => {
							let color;
							if (d > 70) {
							  color = '#4ade80'; // Green
							} else if (d >= 40 && d <= 70) {
							  color = '#eab308'; // Yellow
							} else {
							  color = '#f87171'; // Red
							}
							return {
								offset: idx / data.length * 100,
								color,
								opacity: 1
							}
						})
					}
					const categories = data.map((item) => item.date);
					const seriesData = data.map((item) => item.value);
					const formattedCategories = categories.map((value, index) => (index % 2 === 0 ? value : ""));

					var options = {
					  series: [
						{
						  name: "Completion",
						  data: seriesData,
						},
					  ],
					  chart: {
						height: 350,
						type: "line",
						toolbar: {
						  show: false
						},
						zoom: {
						  enabled: false,
						},
					  },
					  grid: {
						show: false, // Disable the grid
					  },
					  xaxis: {
						categories: formattedCategories,
						labels: {
						  style: {
							colors: "#6a6f7a", // Set the color of y-axis labels
							fontSize: "10px",  // Optional: Set font size
						  },
						},
					  },
					  yaxis: {
						max: 100, // Set the maximum value for the y-axis
						title: {
						  text: "Completion %",
						  style: {
							color: "#6a6f7a", // Set the color of y-axis labels
							fontSize: "10px",  // Optional: Set font size
						  },
						},
						labels: {
						  style: {
							colors: "#6a6f7a", // Set the color of y-axis labels
							fontSize: "10px",  // Optional: Set font size
						  },
						},
					  },

					  dataLabels: {
						enabled: false,
					  },
					  fill: {
						type: 'gradient',
						gradient: {
							shadeIntensity: 1,
							opacityFrom: 0.7,
							opacityTo: 0.9,
							colorStops: generateColors(seriesData)
						}
					  },
					};

					var chart = new ApexCharts(document.querySelector("#chart"), options);
					chart.render();
				},
				error => {
				  toast(error.message, "error");
				}
			);
		},
		setSubControlAsNotApplicable: function(subcontrol) {
			subcontrol.is_applicable = false
			this.updateSubcontrol(subcontrol)
		},
		setSubControlAsApplicable: function(subcontrol) {
			subcontrol.is_applicable = true
			this.updateSubcontrol(subcontrol)
		},
		setAsNotApplicable: function(control) {
			let payload = {"applicable": false}
			request("PUT",
				`/api/v1/project-controls/${control.id}/applicability`,
				data => {
				  toast("Set the control as not applicable", "warning")
				  this.patchControl(data)
				},
				error => {
				  toast(error.message, "error");
				},
				payload
			);
		},
		setAsApplicable: function(control) {
			let payload = {"applicable": true}
			request("PUT",
				`/api/v1/project-controls/${control.id}/applicability`,
				data => {
					toast("Set the control as applicable", "success")
					this.patchControl(data)
				},
				error => {
				  toast(error.message, "error");
				},
				payload
			);
		},
		updateControlFilter: function() {
			this.setControlData({"controls": this.controls})
		},
		refreshSelectedControl: function() {
			if (!this.selectedControl) {
				return
			}
			this.refreshControlFromServer(this.selectedControl.id)
			toast("Refreshed control")
		},
		copyControlLink(controlId) {
			this.setURLParam("control-id", controlId)
			this.copyLink()
		},
		copySubControlLink(subcontrolId) {
			this.setURLParam("subcontrol-id", subcontrolId)
			this.copyLink()
		},
		copyRiskLink(riskId) {
			this.copyLink()
		},
		copyLink: function(url=null) {
			// Create a temporary textarea element
			let textarea = document.createElement('textarea');
			if (url === null) {
				// Set the value of the textarea to the text you want to copy
				url = new URL(window.location.href);
			}

			textarea.value = url.toString();

			// Append the textarea to the document
			document.body.appendChild(textarea);

			// Select the text in the textarea
			textarea.select();

			// Execute the copy command
			document.execCommand('copy');

			// Remove the textarea from the document
			document.body.removeChild(textarea);
			toast("Link copied to your clipboard")
		},
		removeRiskFilter: function() {
			this.riskFilter = []
			this.filteredRisks = this.risks

		},
		progressBars: function(filledPercentage, total=10) {
			return {
			  filledPercentage: filledPercentage, // Number between 0 and 100
			  total: total, // Total number of bars
			  filledBars: Math.round((filledPercentage / 100) * total),
			  get color() {
				// Dynamically determine the color based on the percentage
				if (this.filledPercentage < 40) {
				  return 'bg-red-500'; // Red for less than 40%
				} else if (this.filledPercentage < 70) {
				  return 'bg-yellow-500'; // Yellow for 40%-69%
				} else {
				  return 'bg-green-500'; // Green for 70%-100%
				}
			  },
			};
		},
		jumpToSection: function(id) {
			this.$nextTick(() => {
				const element = document.getElementById(id);
				if (element) {
					element.scrollIntoView({ behavior: 'smooth', block: 'start' });
				}
			});

		},
		jumpToControl: function(event) {
			const message = event.currentTarget.dataset.message;
			console.log("Clicked message:", message);

			// Try to extract the control reference (e.g., "#164.412(a)")
			const match = message.match(/^#\S+/);
			const extracted = match ? match[0].slice(1) : null;  // remove the "#"
			if (!extracted) {
				console.log(`Parsing error for the control extraction:${message}`)
				toast("Unable to view control", "warning")
				return
			}
			const control = this.controls.find(obj => obj.ref_code === extracted.toLowerCase());
			if (control) {
				this.switchTab({"tab":"controls"})
				this.openControlInDrawer(control)
			} else {
				console.log(`We couldn't find the control:${message}`)
				toast("Unable to view control", "warning")
			}
		},
		openReviewModal: function(tempStatus) {
			this.tempReviewStatus = tempStatus
			this.showReviewModal = true
		},
		updateReviewStatus: function(tempReviewStatus) {
			let payload = {"review-status": tempReviewStatus}
			request("PUT",
				`/api/v1/controls/${this.selectedControl.id}/status`,
				data => {
					toast("Updated review status")
					this.patchControl(data)
				},
				error => {
				  toast(error.message, "error");
				},
				payload
			);
		},
		isMessageFromAuditor: function(message) {
			const user = this.projectUsers.find(obj => obj.id === message.owner_id);
			if (!user) {
				return false
			}
			if (user.access_level === "auditor") {
				return true
			}
			return false
		},
		getSubcontrolSelection: function(subcontrol) {
			let text = `(${subcontrol.ref_code}): ${subcontrol.name}`
			console.log(text)
			return text.length > 100
				? text.substring(0, 100) + '.....'
				: text;
		},
		updateSubcontrol: function(subcontrol) {
			let payload = {
				"applicable": subcontrol.is_applicable,
				"implemented": subcontrol.implemented,
				"owner-id": subcontrol.owner_id,
				"context": subcontrol.context
			}

			request("PUT",
				`/api/v1/project-controls/${subcontrol.project_control_id}/subcontrols/${subcontrol.id}`,
				data => {
					toast("Updated subcontrol", level="success", duration=2000, bottom=true)
					this.selectedSubControl = data;
					this.refreshControlFromServer(this.selectedControl.id)
					this.projectRefreshRequired = true;
				},
				error => {
				  toast(error.message, "error");
				},
				payload
			);
		},
		refreshControlFromServer: function(controlId) {
			request("GET",
				`/api/v1/projects/${this.projectId}/controls/${controlId}`,
				data => {
					this.patchControl(data)
				},
				error => {
				  toast(error.message, "error");
				}
			);
		},
		deleteMessage: function(message) {
			request("DELETE",
				`/api/v1/projects/${this.projectId}/comments/${message.id}`,
				data => {
					toast("Removed message")
					this.messages = this.messages.filter(item => item.id !== message.id);
				},
				error => {
				  toast(error.message, "error");
				}
			);
		},
		deleteControlMessage: function(message) {
			request("DELETE",
				`/api/v1/projects/${this.projectId}/controls/${this.selectedControl.id}/comments/${message.id}`,
				data => {
					toast("Removed message")
					this.messagesForControl = this.messages.filter(item => item.id !== message.id);
				},
				error => {
				  toast(error.message, "error");
				}
			);
		},
		simpleDate: function(dateString) {
			var date = new Date(dateString);
			var dayOfWeek = date.toLocaleDateString('en', { weekday: 'short' });
			var dayOfMonth = date.getDate();
			var year = date.getFullYear();

			// Format the result string
			return dayOfWeek + ', ' + (dayOfMonth < 10 ? '0' : '') + dayOfMonth + ', ' + year;

		},
		addPolicy: function() {
			if (!this.policyId) {
				toast("Please select a policy", "warning")
			}
			request("PUT",
				`/api/v1/policies/${this.policyId}/projects/${this.projectId}`,
				data => {
				  toast("Added policy")
				  this.showAddPolicy = false;
				  this.policyId = null;
				  this.policies.push(data)
				},
				error => {
				  toast(error.message, "error");
				}
			);
		},
		updateUser: function() {
			if (!this.updatedAccessLevel) {
				toast("Please select an access level", "warning")
				return
			}
			let jsonData = {"access_level": this.updatedAccessLevel};
			request("PUT",
				`/api/v1/projects/${this.projectId}/members/${this.selectedUser.id}/access`,
				data => {
				  toast("Updated User")
				  location.reload()
<!--                  const tempUserList = this.projectUsers.filter(obj => obj.id !== this.selectedUser.id);-->
<!--                  tempUserList.push({"id":this.selectedUser.id, "email": this.selectedUser.email, "access_level": this.updatedAccessLevel, "member": true})-->
<!--                  this.projectUsers = tempUserList-->
<!--                  this.showEditUserModal = false;-->
<!--                  this.updatedAccessLevel = false;-->
<!--                  this.selectedUser = {}-->
				},
				error => {
				  toast(error.message, "error");
				},
				jsonData
			);
		},
		removeUser: function() {
			if (!this.selectedUser) {
				toast("Please select a user", "warning")
				return
			}
			request("DELETE",
				`/api/v1/projects/${this.projectId}/members/${this.selectedUser.id}`,
				data => {
				  toast("Removed User")
				  const tempUserList = this.projectUsers.filter(obj => obj.id !== this.selectedUser.id);
				  tempUserList.push({"id": this.selectedUser.id, "email": this.selectedUser.email, "member": false})
				  this.projectUsers = tempUserList
				  this.showRemoveUserModal = false;
				  this.selectedUser = {}
				},
				error => {
				  toast(error.message, "error");
				}
			);
		},
		addUser: function() {
			if (!this.addUserId) {
				toast("Please select a user", "warning")
				return
			}
			const userEmail = this.projectUsers.find(obj => obj.id === this.addUserId).email;
			let record = {"id":this.addUserId, "email": userEmail, "access_level": this.addUserRole, "member": true}
			let jsonData = {
				"members": [record]
			}
			request("POST",
				`/api/v1/projects/${this.projectId}/members`,
				data => {
				  toast("Added User")
				  this.addUserId = null;
				  this.addUserRole = "viewer";
				  this.showAddUser = false;
				  const tempUserList = this.projectUsers.filter(obj => obj.id !== this.addUserId);
				  tempUserList.push(record)
				  this.projectUsers = tempUserList
				},
				error => {
				  toast(error.message, "error");
				},
				jsonData
			);
		},
		saveSettings: function() {
			let jsonData = {
				"name": this.projectData.name,
				"description": this.projectData.description,
				"auditor_enabled": this.projectData.auditor_enabled,
				"can_auditor_read_scratchpad": this.projectData.can_auditor_read_scratchpad,
				"can_auditor_write_scratchpad": this.projectData.can_auditor_write_scratchpad,
				"can_auditor_read_comments": this.projectData.can_auditor_read_comments,
				"can_auditor_write_comments": this.projectData.can_auditor_write_comments,
				"policies_require_cc": this.projectData.policies_require_cc
			}
			request("PUT",
				`/api/v1/projects/${this.projectId}/settings`,
				data => {
				  toast("Updated settings")
				},
				error => {
				  toast(error.message, "error");
				},
				jsonData
			);
		},
		initControlNotesEditor: function() {
			let selector = "controlNotesEditorDiv"
			tinymce.EditorManager.execCommand('mceRemoveEditor', true, selector);

			console.log("Trying to create editor:"+selector)
			let readOnly = false;
			if (this.projectData.auditor_enabled && this.isAuditor) {
				readOnly = true
			}
			let config = getEditorConfig("#" + selector, readOnly=readOnly);
			config.setup = (editor) => {
			  editor.on('init', () => {
				editor.setContent(this.selectedControl.notes ?? "");
			  });
			};
			tinymce.init(config);
		},
		changeControlTab: function(tab) {
		  // change the tab inside the selected control in the modal
		  console.log("changing the tab:"+tab)
		  this.controlTab = tab;
		  var queryParams = new URLSearchParams(window.location.search);
		  queryParams.set("controlTab", tab)
		  history.replaceState(null, null, "?"+queryParams.toString());

		  if (tab === "notes") {
			this.initControlNotesEditor()
		  }
		},

		evaluateCondition: function(jsonObject, filterConditions) {
			if (!Array.isArray(filterConditions)) {
				filterConditions  = [filterConditions]
			}
			for (var i = 0; i < filterConditions.length; i++) {
				var filterCondition = filterConditions[i];
				var field = filterCondition.field;
				var operator = filterCondition.operator;
				var value = filterCondition.value;

				// Ensure that the field exists in the object
				if (!jsonObject.hasOwnProperty(field)) {
					console.log("Missing field: " + field);
					return false;
				}

				// Evaluate the condition based on the operator
				switch (operator) {
					case ">":
						if (!(jsonObject[field] > value)) {
							return false;
						}
						break;
					case "<":
						if (!(jsonObject[field] < value)) {
							return false;
						}
						break;
					case "=":
						if (!(jsonObject[field] === value)) {
							return false;
						}
						break;
					case "!=":
						if (!(jsonObject[field] !== value)) {
							return false;
						}
						break;
					// Add more cases for other operators if needed
					default:
						return false;
				}
			}
			// If all conditions pass, return true
			return true;
		},
		riskViewFilter: function(value) {
			let filterDict = {
				"r0": {"field": "risk"},
				"p0": {"field": "priority"},
				"s0": {"field": "status"},
				"1": { field: "risk", operator: "=", value: "unknown" },
				"2": { field: "risk", operator: "=", value: "low" },
				"3": { field: "risk", operator: "=", value: "moderate" },
				"4": { field: "risk", operator: "=", value: "high" },
				"5": { field: "risk", operator: "=", value: "critical" },
				"6": { field: "priority", operator: "=", value: "unknown" },
				"7": { field: "priority", operator: "=", value: "low" },
				"8": { field: "priority", operator: "=", value: "moderate" },
				"9": { field: "priority", operator: "=", value: "high" },
				"10": { field: "status", operator: "=", value: "new" },
				"11": { field: "status", operator: "=", value: "in_progress" },
				"12": { field: "status", operator: "=", value: "accepted" },
				"13": { field: "status", operator: "=", value: "mitigated" },
				"14": { field: "status", operator: "=", value: "false_positive" }
			}
			if (value) {
				let newFilter = filterDict[value];
				let tempList = this.riskFilter.filter(obj => obj.field !== newFilter.field);
				if (newFilter.hasOwnProperty("value")) {
					tempList.push(newFilter)
				}
				this.riskFilter = tempList
			}

			let filteredRisks = []

			this.risks.forEach((risk) => {
				let filterResult = this.evaluateCondition(risk, this.riskFilter)
				if (filterResult === false) {
					return;
				}
				filteredRisks.push(risk)
			})
			this.filteredRisks = filteredRisks
		},
		updateRisk: function(risk) {
			//TODO
		  data = {
			"title": risk.title,
			"description": risk.description,
			"status":risk.status,
			"risk":risk.risk,
			"priority":risk.priority
		  }
		  request("PUT",
			`/api/v1/projects/${this.projectId}/risks/${risk.id}`,
			data => {
			  toast("Updated risk")
			  return(data)
			},
			error => {
			  toast(error.message, "error");
			},
			data
		  );
		},
		updatePolicy: function() {
		  data = {
			"description": this.selectedPolicy.description,
			"reviewer": this.selectedPolicy.reviewer
		  }
		  request("PUT",
			`/api/v1/projects/${this.projectId}/policies/${this.selectedPolicy.id}`,
			data => {
			  toast("Updated policy")
			  this.showPolicyModal = false
			  return(data)
			},
			error => {
			  toast(error.message, "error");
			},
			data
		  );

		},
		keyExistsInLocalStorage: function(key, parse=false) {
		  let value = localStorage.getItem(key);
		  if (value) {
			if (parse) {
			  return JSON.parse(value)
			}
			return value
		  }
		  return false
		},
		createControlMessage: function() {
			if (this.controlCurrentMessage) {

				if (this.selectedSubControl !== null) {
					let prefix = this.selectedSubControl.ref_code || "Subcontrol"
					this.controlCurrentMessage = `[${prefix}] ${this.controlCurrentMessage}`
				}
				let jsonData = {"data": this.controlCurrentMessage}
				request("POST",
					`/api/v1/projects/${this.projectId}/controls/${this.selectedControl.id}/comments`,
					data => {
						this.messagesForControl.push(data)
						this.controlCurrentMessage = "";
						this.scrollToRecentMessagesInDrawer()
					},
					error => {
					  toast(error.message, "error");
					},
					jsonData
				);
			}
		},
		createRiskMessage: function(risk) {
			if (this.currentMessage) {
				let jsonData = {"message": this.currentMessage}
				request("POST",
					`/api/v1/risks/${risk.id}/comments`,
					data => {
						this.riskMessages.push(data)
						this.currentMessage = "";
						this.scrollToRecentRiskMessagesInDrawer()
					},
					error => {
					  toast(error.message, "error");
					},
					jsonData
				);
			}
		},		
		createMessage: function() {
			if (this.$refs.textarea.value) {
				let jsonData = {"data": this.$refs.textarea.value}
				request("POST",
					`/api/v1/projects/${this.projectId}/comments`,
					data => {
						this.messages.push(data)
						this.currentMessage = "";
						this.$refs.textarea.value = "";
						setTimeout(function() {
							var divElement = document.getElementById("messageDiv");
							divElement.scrollTop = divElement.scrollHeight;
						}, 100);
					},
					error => {
					  toast(error.message, "error");
					},
					jsonData
				);
			}
		},
		switchTab: function({tab = null, view = null, useCache = true, controlsFilter = null}) {
		  this.tabLoading = true;
		  this.tableLoading = true;
		  var tab = tab ?? this.selectedTab
		  var view = view ?? this.view
		  var queryParams = new URLSearchParams(window.location.search);

		  if (tab) {
			this.selectedTab = tab;
			queryParams.set("tab", tab);
		  }

		  if (view) {
			this.view = view;
			queryParams.set("view", view);
		  }
		  if (controlsFilter) {
			this.controlsFilter = controlsFilter
			queryParams.set("controlsFilter", controlsFilter)
		  }

		  history.replaceState(null, null, "?"+queryParams.toString());

		  this.tabLoading = false;
		  this.tableLoading = false;

		  if (tab === "controls" || tab === "summary") {
			if (!useCache) {
				toast("Refreshing the controls, please wait...")
				this.getProject()
				this.getControls(useCache=useCache)
			}
		  } else if (tab === "risk register") {
			this.drawTable({"selector": "#risk-table", "tableData":this.filteredRisks, "formatter": "risks"})
		  }

		},
		formatComment: function(message) {
			let words = message.split(' ');

			let formatted = words.map(word => {
				if (word.startsWith('@')) {
					return `<i class='italic'>${word}</i>`;
				} else if (word.startsWith('#')) {
					return `<i data-message="${message}" @click="jumpToControl($event)" class="underline hover:cursor-pointer text-success">${word}</i>`;
				} else {
					return word;
				}
			}).join(' ');

			return formatted;
		},
		drawTable: function({ selector = null, tableData = null, formatter = null }) {
		  console.log("Drawing table: "+selector)
		  var data = tableData;
		  var columns = [];

		  gridOptions = {
			pagination: true,
			paginationPageSize: 25,
			domLayout: "autoHeight",
			suppressMenuHide: true,
			suppressHorizontalScroll: true,
			enableCellTextSelection:true,
			suppressFieldDotNotation: true,
			onFirstDataRendered: (params) => {
			//onGridReady: (params) => {
			  params.api.sizeColumnsToFit();
			  this.tableLoading = false;
			  window.onresize = () => {
				this.tableLoading = true;
				params.api.sizeColumnsToFit();
				this.tableLoading = false;
			  }
			},
			autoSizeStrategy: {
			  type: 'fitGridWidth',
			  defaultMinWidth: 50,
			}
		  }

		  const gridElement = document.querySelector(selector);
		  if (formatter === "policies") {
			if (this.policyGrid) {
			  this.policyGrid.destroy();
			}

			gridOptions.rowData = tableData;
			gridOptions.columnDefs = this.policyTableHeaders

			this.policyGrid = agGrid.createGrid(gridElement, gridOptions);

		  } else if (formatter === "risks") {
			if (this.riskGrid) {
			  this.riskGrid.destroy();
			}

			gridOptions.rowData = tableData;
			gridOptions.columnDefs = this.riskTableHeaders

			gridOptions.onRowDoubleClicked = (row) => {
			  this.selectedRisk = this.filteredRisks.find(obj => obj.id === row.data.id);
			  this.showRiskModal = true;
			},

			this.riskGrid = agGrid.createGrid(gridElement, gridOptions);

		  } else {
			console.log("Formatter does not exist: "+formatter)
			return
		  }

		},
		refreshData: function() {
		  this.disableRefreshBtn = true;
		  this.switchTab({"tab": this.selectedTab, "useCache": false})
		},
		getSummary: function(useCache=true) {
		  this.tabLoading=false;
		},
		getProject: function() {
		  this.loadingProjectData = true;
		  request("GET",
			"/api/v1/projects/" + this.projectId+"?summary=yes",
			data => {
			  this.projectData = data;
			  if (data.auditors.length > 0) {
				this.tabs.splice(2, 0, "audit review");
			  }
			  this.loadingProjectData = false;
			},
			error => {
			  toast(error.message, "error");
			}
		  );
		},
		patchControl: function(patchedControl) {
			// Retrieve cached controls from localStorage
			let cacheControls = this.keyExistsInLocalStorage(`${this.projectId}_controls`, parse=true);

			if (cacheControls === false) {
				console.log("Unable to find controls in cache. Try refreshing");
				return;
			}

			// Iterate through cacheControls and update the control with a matching id
			const patchedControls = cacheControls.map(control =>
				control.id === patchedControl.id ? { ...control, ...patchedControl } : control
			);

			// Save the updated controls list to localStorage
			localStorage.setItem(`${this.projectId}_controls`, JSON.stringify(patchedControls));

			// Update the control data in your application state
			this.setControlData({"controls": patchedControls});
		},
		patchSubControl: function(patchedSubcontrol) {
			// patch the existing controls by passing a subcontrol object
			let cacheControls = this.keyExistsInLocalStorage(`${this.projectId}_controls`, parse=true);
			if (cacheControls !== false) {
				console.log("Updating controls in cache")
				patchedControls = cacheControls.map(control => {
				  if (Array.isArray(control.subcontrols)) {
					// Map through subcontrols and patch the matching subcontrol by id
					control = {
					  ...control,
					  subcontrols: control.subcontrols.map(subcontrol =>
						subcontrol.id === patchedSubcontrol.id ? { ...subcontrol, ...patchedSubcontrol } : subcontrol
					  ),
					};
				  }
				  return control;
				});
				localStorage.setItem(`${this.projectId}_controls`, JSON.stringify(patchedControls));
				this.setControlData({"controls": patchedControls})
				return
			}
		},
		getControls: function(useCache=false) {
		  this.loadingControls = true;
		  console.log("Trying to load controls")
		  if (useCache) {
			let cacheValue = this.keyExistsInLocalStorage(`${this.projectId}_controls`, parse=true);

			if (cacheValue !== false) {
				console.log("Loading controls from cache")
				this.setControlData({"controls": cacheValue, "readURL":true})
				this.loadingControls = false;
				return
			}
		  }
		  console.log("Loading controls from server")
		  request("GET",
			"/api/v1/projects/" + this.projectId + "/controls?stats=yes",
			data => {
			  localStorage.setItem(`${this.projectId}_controls`, JSON.stringify(data));
			  this.setControlData({"controls": data, "readURL":true});
			  this.disableRefreshBtn = false
			  this.loadingControls = false;
			},
			error => {
			  this.loadingControlsMessage = "Something went wrong"
			  toast(error.message, "error");
			}
		  );
		},
		getPolicies: function() {
		  request("GET",
			"/api/v1/projects/{{project.id}}/policies",
			data => {
			  this.policies = data;
			  this.tabLoading = false;
			  this.tableLoading = false;
			  let acceptedPolicies = 0
			  let totalPolicies = data.length
			  for (var policy in this.policies) {
				if (this.policies[policy].accepted) {
					acceptedPolicies+=1
				}
			  }
			  if (acceptedPolicies === 0) {
				this.policyAcceptance = "not started"
			  } else if (acceptedPolicies === totalPolicies) {
				this.policyAcceptance = "complete"
			  } else {
				this.policyAcceptance = "in progress"
			  }
			},
			error => {
			  toast(error.message, "error");
			}
		  )
		},
		getRisks: function() {
		  this.loadingReports = true
		  request("GET",
			"/api/v1/projects/{{project.id}}/risks",
			data => {
			  this.risks = data;
			  this.filteredRisks = data;
			  this.tabLoading = false;
			  this.tableLoading = false;
			  this.loadingReports = false

			},
			error => {
			  toast(error.message, "error");
			}
		  )
		},
		createRisk: function() {
			request("POST",
				`/api/v1/projects/${this.projectId}/risks`,
				data => {
					this.risks.push(data)
					this.showCreateRisk = false
					this.riskPayload = {}
				},
				error => {
				  toast(error.message, "error");
				},
				this.riskPayload
			);
		},
		changeControlOwnerFilter: function() {
			if (this.controlOwner === "all_users") {
				delete this.controlFilter.owner
				return
			}
			this.controlFilter.owner = this.controlOwner
		},
		deleteRisk: function() {
			request("DELETE",
				`/api/v1/projects/${this.projectId}/risks/${selectedRisk.id}`,
				data => {
					this.risks.push(data)
					this.showCreateRisk = false
					this.riskPayload = {}
				},
				error => {
				  toast(error.message, "error");
				},
				this.riskPayload
			);
		},
		getTenantPolicies: function() {
		  request("GET",
			`/api/v1/tenants/${this.$store.currentUser.selectedTenant.id}/policies`,
			data => {
				this.tenantPolicies = data.map(item => ({
					...item,
					name: item.name.charAt(0).toUpperCase() + item.name.slice(1) // Capitalize first letter
				}));
			},
			error => {
			  toast(error.message, "error");
			}
		  )
		},
		setControlData: function(options={}) {
			console.log("Reloading the controls");
			controls = options["controls"]
			readURL = options["readURL"]

			if (!controls) {
				controls = this.controls;
			}

			this.controls = controls;

			Alpine.store('data', {
				controls: controls
			});

			let filteredControls = [];
			let subcontrols = [];

			// Reset counts before processing
			this.controlApplicableCount = 0;
			this.controlCompleteCount = 0;
			this.controlEvidenceCount = 0;
			this.controlImplementedCount = 0;

			this.controlReviewStatuses = {
				"infosec action": 0,
				"ready for auditor": 0,
				"complete": 0
			};
			this.controlStatuses = {
				"applicable": 0,
				"not applicable": 0,
				"not started": 0,
				"in progress": 0,
				"complete": 0
			};
			this.implementedStatuses = {
				"not implemented": 0,
				"partially implemented": 0,
				"fully implemented": 0
			};
			this.evidenceStatus = {
				"no evidence": 0,
				"partial evidence": 0,
				"full evidence": 0
			};

			this.subcontrolApplicableCount = 0;
			this.subcontrolCompleteCount = 0;
			this.subcontrolEvidenceCount = 0;
			this.subcontrolImplementedCount = 0;

			let progressCompleted = 0;
			let subProgressCompleted = 0;

			// If a filter is applied, use the filtered controls instead of all controls
			if (Object.keys(this.controlFilter).length > 0) {
				controls = this.filteredControls;
			}

			controls.forEach((control) => {
				this.idToProgressBarMapping[control.id] = this.progressBars(control.progress_completed);

				if (this.selectedControl?.id === control.id) {
					this.selectedControl = control;
				}
				this.controlStatuses[control.status] += 1;

				this.controlReviewStatuses[control.review_status] += 1;
				this.implementedStatuses[control.implemented_status] += 1;

				if (control.progress_evidence === 100) {
					this.evidenceStatus["full evidence"] += 1;
				} else if (control.progress_evidence > 0) {
					this.evidenceStatus["partial evidence"] += 1;
				} else {
					this.evidenceStatus["no evidence"] += 1;
				}

				if (control.is_applicable) {
					this.controlApplicableCount += 1;
					this.controlStatuses["applicable"] += 1;
				}
				if (control.is_complete) {
					this.controlCompleteCount += 1;
				}
				if (control.progress_evidence === 100) {
					this.controlEvidenceCount += 1;
				}
				if (control.progress_implemented === 100) {
					this.controlImplementedCount += 1;
				}

				progressCompleted += control.progress_completed;

				control.subcontrols.forEach((subcontrol) => {
					this.idToProgressBarMapping[subcontrol.id] = this.progressBars(subcontrol.implemented, 5);
					this.idToProgressBarMapping[subcontrol.id+"_progress"] = this.progressBars(subcontrol.progress_completed);


					if (this.selectedSubControl?.id === subcontrol.id) {
						this.selectedSubControl = subcontrol;
					}
					if (subcontrol.is_applicable) {
						this.subcontrolApplicableCount += 1;
					}
					if (subcontrol.is_complete) {
						this.subcontrolCompleteCount += 1;
					}
					if (subcontrol.has_evidence === true) {
						this.subcontrolEvidenceCount += 1;
					}
					if (subcontrol.implemented === 100) {
						this.subcontrolImplementedCount += 1;
					}
					subProgressCompleted += subcontrol.progress_completed;
					subcontrols.push(subcontrol);
				});
			});

			// Filtering logic
			if (this.controlFilter && Object.keys(this.controlFilter).length > 0) {
				for (const control of this.controls) { // Always filter from full controls list
					let matchesAllFilters = true;

					for (const [filterKey, filterValue] of Object.entries(this.controlFilter)) {
						if (filterKey === "status") {
							if (filterValue === "applicable") {
								// "applicable" should match anything that's NOT "not applicable"
								if (control.status === "not applicable") {
									matchesAllFilters = false;
									break;
								}
							} else {
								// Exact match for all other statuses
								if (control.status !== filterValue) {
									matchesAllFilters = false;
									break;
								}
							}
						}
						if (filterKey === "name" && filterValue && !control.name.toLowerCase().includes(filterValue.toLowerCase())) {
							matchesAllFilters = false;
							break;
						}
						if (filterKey === "tags" && filterValue) {
							const filterTags = (Array.isArray(filterValue) ? filterValue : [filterValue])
								.map(tag => tag.toLowerCase().trim());

							const controlTags = Array.isArray(control.tags)
								? control.tags.map(tag => (tag.name || '').toLowerCase())
								: [];

							if (!filterTags.every(tag => controlTags.includes(tag))) {
								matchesAllFilters = false;
								break;
							}
						}
						if (filterKey === "review_status" && control.review_status !== filterValue) {
							matchesAllFilters = false;
							break;
						}
						if (filterKey === "implemented_status" && control.implemented_status !== filterValue) {
							matchesAllFilters = false;
							break;
						}
						if (filterKey === "owner" && !control.owners.includes(filterValue)) {
							matchesAllFilters = false;
							break;
						}
						if (filterKey === "evidence_status") {
							let evidenceStatus = control.progress_evidence === 0
								? "no evidence"
								: control.progress_evidence < 100
								? "partial evidence"
								: "full evidence";

							if (evidenceStatus !== filterValue) {
								matchesAllFilters = false;
								break;
							}
						}
					}

					if (matchesAllFilters) {
						filteredControls.push(control);
					}
				}
			}

			this.emptyControlFilter = false;

			// If no filters are applied, reset filteredControls to all controls
			if (Object.keys(this.controlFilter).length === 0) {
				filteredControls = [...this.controls];
			} else if (filteredControls.length === 0) {
				this.emptyControlFilter = true;
			}

			this.subcontrols = subcontrols;
			this.filteredControls = filteredControls;
			this.filteredSubControls = [];

			// Update the counts and statuses based on the filtered controls
			this.controlReviewStatuses = { "infosec action": 0, "ready for auditor": 0, "complete": 0 };
			this.controlStatuses = { "applicable": 0, "not applicable": 0, "not started": 0, "in progress": 0, "complete": 0 };
			this.implementedStatuses = { "not implemented": 0, "partially implemented": 0, "fully implemented": 0 };
			this.evidenceStatus = { "no evidence": 0, "partial evidence": 0, "full evidence": 0 };

			this.filteredControls.forEach((control) => {
				this.filteredSubControls.push(...control.subcontrols);
				this.controlReviewStatuses[control.review_status] += 1;
				this.controlStatuses[control.status] += 1;
				if (control.is_applicable) {
					this.controlStatuses["applicable"] += 1;
				}

				this.implementedStatuses[control.implemented_status] += 1;

				if (control.progress_evidence === 100) {
					this.evidenceStatus["full evidence"] += 1;
				} else if (control.progress_evidence > 0) {
					this.evidenceStatus["partial evidence"] += 1;
				} else {
					this.evidenceStatus["no evidence"] += 1;
				}
			});

			if (readURL) {
				if (this.getURLParam("control-id")) {
					let control = this.controls.find(obj => obj.id === this.getURLParam("control-id"));
					this.openControlInDrawer(control)

					if (this.getURLParam("subcontrol-id")) {
						let subcontrol = this.subcontrols.find(obj => obj.id === this.getURLParam("subcontrol-id"));
						this.selectedSubControl = subcontrol
						this.changeSubControlTabInDrawer(this.getURLParam("drawer-subtab", defaultValue="details"))
					}
				  } else if (this.getURLParam("evidence-id")) {
					let evidence = this.projectEvidence.find(obj => obj.id === this.getURLParam("evidence-id"));
					this.openEvidenceDrawer(evidence)
				}
		    }

		},
		getUsersForProject: function() {
			request("GET",
				`/api/v1/projects/${this.projectId}/members`,
				data => {
				  this.projectUsers = data
				  Alpine.store('users', {
					data: data
				  })
				},
				error => {
				  toast(error.message, "error");
				}
			);
		},
		scrollToRecentRiskMessagesInDrawer: function() {
		  setTimeout(function() {
			var divElement = document.getElementById("risk-middle-section");
			if (divElement) {
				divElement.scrollTop = divElement.scrollHeight;
			}
		  }, 100);
		},		
		scrollToRecentMessagesInDrawer: function() {
		  setTimeout(function() {
			var divElement = document.getElementById("middle-section");
			if (divElement) {
				divElement.scrollTop = divElement.scrollHeight;
			}
		  }, 100);
		},
		loadCommentsForControl: function() {
			request("GET",
				`/api/v1/projects/${this.projectId}/controls/${this.selectedControl.id}/comments`,
				data => {
				  this.messagesForControl = data;
				},
				error => {
				  toast(error.message, "error");
				}
			);
		},
		loadComments: function() {
			request("GET",
				"/api/v1/projects/" + this.projectId+"/comments",
				data => {
				  this.messages = data;

				  this.tabLoading = false;
				  this.tableLoading = false;
				  setTimeout(function() {
					var divElement = document.getElementById("messageDiv");
					divElement.scrollTop = divElement.scrollHeight;
				  }, 100);
				},
				error => {
				  toast(error.message, "error");
				}
			);
		},
		// Evidence module
		fileUploadMap:{},
		evidence: [],
		filteredEvidence: [],
		projectEvidence: [],
		evidence_map: {},
		openPolicyDrawer(policy) {
			this.selectedPolicy = policy
			document.getElementById('policy-drawer').checked = true;
		},
		openEvidenceDrawer(evidence) {
			this.selectedEvidence = evidence
			this.evidenceFile = null
			document.getElementById('evidence-drawer').checked = true;
			this.setURLParam("evidence-id", evidence.id)
		},
		closeEvidenceDrawer: function() {
			this.selectedEvidence = null;
			this.deleteURLParam("evidence-id")
			document.getElementById('evidence-drawer').checked = false;
		},
		changeControlTabInDrawer(tab=null) {
			if (tab) {
				this.activeSideTab = tab
			} else {
				this.activeSideTab = "details"
			}
			this.setURLParam("drawer-tab", this.activeSideTab)
		},
		changeSubControlTabInDrawer(tab=null) {
			if (tab) {
				this.activeSubSideTab = tab
			} else {
				this.activeSubSideTab = "details"
			}
			this.setURLParam("drawer-subtab", this.activeSubSideTab)
		},
		openSubControlInDrawer(subcontrol, tab=null) {
			this.selectedSubControl = subcontrol
			this.setURLParam("subcontrol-id", subcontrol.id)
			this.changeSubControlTabInDrawer(tab || this.getURLParam("drawer-subtab", defaultValue="details"))
		},
		closeSubControlInDrawer() {
			this.selectedSubControl = null;
			this.deleteURLParam("subcontrol-id")
			this.deleteURLParam("drawer-subtab")
		},
		openControlInDrawer: function(control, tab=null) {
			this.selectedSubControl = null;
			this.selectedControl = control;
			this.changeControlTabInDrawer(tab || this.getURLParam("drawer-tab", defaultValue="details"))
			this.previouslySelectedRowId = '';
			//this.jumpToSection('row-' + control.id);
			this.isControlOpen = true
			document.getElementById('right-drawer').checked = true;
			this.setURLParam("control-id", control.id)
			this.loadCommentsForControl()

		},
		closeControlDrawer: function() {
			this.previouslySelectedRowId = this.selectedControl.id;
			this.selectedControl = null;
			this.isControlOpen = false
			this.deleteURLParam("control-id")
			this.deleteURLParam("subcontrol-id")
			this.deleteURLParam("drawer-tab")
			this.deleteURLParam("drawer-subtab")
			document.getElementById('right-drawer').checked = false;
		},
		openCreateEvidenceModal: function() {
			this.showCreateEvidenceModal = true
			const inputElement = document.getElementById("createEvidenceUploader");
			const pond = FilePond.find(inputElement);
			if (pond) {
				pond.setOptions({"files": []})
				return
			}

			FilePond.registerPlugin(FilePondPluginImagePreview);
			this.createPondInstance = FilePond.create(inputElement, {
			  allowMultiple: false,
			  acceptedFileTypes: ['image/*'],
			  labelIdle: 'Drag & Drop your evidence or <span class="filepond--label-action">Browse</span>',
			  onactivatefile: (file) => {
				console.log(file.filename)
			  }
			});
		},
		openEvidence: function(item) {
			this.selectedEvidence = item
			this.showViewEvidenceModal = true

			//Pond
			const inputElement = document.getElementById("updateEvidenceUploader");
			const pond = FilePond.find(inputElement);
			if (pond) {
				pond.setOptions({"files": []})
				return
			}
			FilePond.registerPlugin(FilePondPluginImagePreview);
			this.updatePondInstance = FilePond.create(inputElement, {
			  files: [],
			  allowMultiple: false,
			  acceptedFileTypes: ['image/*'],
			  labelIdle: 'Drag & Drop your files or <span class="filepond--label-action">Browse</span>',
			  onactivatefile: (file) => {
				console.log(file.filename)
			  }
			});
		},
		removeEvidence: function(id) {
			const evidence = this.selectedSubControl.evidence.find(evidence => evidence.id === id);

			if (!evidence) {
			  this.showRemoveEvidenceModal = false;
			  toast("Not able to find evidence", "error")
			  return
			}
			data = {
			  "evidence": evidence.id
			}
			request("DELETE",
				`/api/v1/subcontrols/${this.selectedSubControl.id}/disassociate-evidence`,
				data => {
					toast("Removed evidence", level="success", duration=2000, bottom=true)
					this.selectedSubControl = data;

					this.refreshControlFromServer(this.selectedControl.id)
					this.showRemoveEvidenceModal = false;
					return(data)
				},
				error => {
				  toast(error.message, "error");
				},
				data
			);
		},
		deleteEvidenceFile(evidence) {
			request("DELETE",
				`/api/v1/projects/${this.projectId}/subcontrols/${this.selectedSubControl.id}/evidence/${evidence.id}/file`,
				data => {
					toast("Removed evidence", level="success", duration=2000, bottom=true)
					//this.getEvidence(this.selectedControl)
					this.showRemoveEvidenceModal = false;
					return(data)
				},
				error => {
				  toast(error.message, "error");
				}
			);
		},

		saveAttachedEvidence: function() {
		  let newList = [];
		  let newEvidenceList = []
		  for (const item of this.seSelected) {
			const foundObject = this.projectEvidence.find(obj => obj.name === item);
			if (foundObject) {
				newList.push(foundObject.id)
				newEvidenceList.push(foundObject)
			}
		  }

		  data = {
			"evidence": newList
		  }
		  request("PUT",
			`/api/v1/subcontrols/${this.selectedSubControl.id}/associate-evidence`,
			data => {
			  toast("Updated evidence", level="success", duration=2000, bottom=true)
			  this.refreshControlFromServer(this.selectedControl.id)
			  this.showAttachModal = false
			  return(data)
			},
			error => {
			  toast(error.message, "error");
			},
			data
		  );
		},
		attachEvidence: function() {
		  this.seUnselected = [];
		  this.seSelected = [];

		  var currentEvidence = this.selectedSubControl.evidence;
		  for (var item of this.projectEvidence) {
			// Check if the item's id exists in currentEvidence
			var isSelected = currentEvidence.some(evidence => evidence.id === item.id);

			if (isSelected) {
			  this.seSelected.push(item.name);
			} else {
			  this.seUnselected.push(item.name);
			}
		  }
		},
		scrollDiv: function() {
		  var objDiv = document.getElementById("evidence-body");
		  objDiv.scrollTop = objDiv.scrollHeight;
		},
		updateEvidence: function() {
		  var item = this.selectedEvidence
		  var fd = new FormData();

		  if (this.evidenceFile) {
			fd.append("file", this.evidenceFile);
		  }
		  fd.append("name", item.name)
		  fd.append("content", item.content)
		  fd.append("description", item.description)

		  fetch(`/api/v1/evidence/${item.id}`, {
			  method: "PUT",
			  body: fd,
			  cache: "no-cache" // Equivalent to cache: false in jQuery
			})
			.then(response => {
			  if (!response.ok) {
				// Convert non-2xx HTTP responses into errors
				return response.json().then(errorData => {
				  throw new Error(errorData.message);
				});
			  }
			  return response.json(); // Parse JSON response
			})
			.then(data => {
			  toast("Updated evidence")
			  this.showViewEvidenceModal = false
			  this.selectedEvidence = data;
			  return data;
			})
			.catch(errMsg => {
			  toast(errMsg.message, "error");
			  return errMsg;
		  });
		},
		createEvidence: function() {
		  var fd = new FormData();

		  this.createPondInstance.getFiles().forEach(fileItem => {
			fd.append("file", fileItem.file);
		  });

		  fd.append("name", this.createEvidencePayload.name)
		  fd.append("description", this.createEvidencePayload.description)
		  fd.append("content", this.createEvidencePayload.content)

		  let url = `/api/v1/projects/${this.projectId}/evidence`;
		  let is_subcontrol = false;

		  if (this.selectedSubControl && Object.keys(this.selectedSubControl).length > 0) {
			  url = `/api/v1/projects/${this.projectId}/subcontrols/${this.selectedSubControl.id}/evidence`;
			  is_subcontrol = true;
		  }

		  fetch(url, {
			  method: "POST",
			  body: fd,
			  cache: "no-cache"
			})
			.then(response => {
			  this.createEvidencePayload = {}
			  this.showCreateEvidenceModal = false;
			  if (is_subcontrol) {
				this.refreshControlFromServer(this.selectedControl.id)
			  }

			  if (!response.ok) {
				// Convert non-2xx HTTP responses into errors
				return response.json().then(errorData => {
				  throw new Error(errorData.message);
				});
			  }
			  return response.json(); // Parse JSON response
			})
			.then(data => {
			  toast("Added evidence");
			  this.showCreateEvidenceModal = false
			  this.createEvidencePayload = {}
			  this.getProjectEvidence()
			  return data;
			})
			.catch(errMsg => {
			  toast(errMsg.message, "error");
			  this.createEvidencePayload = {}
			  this.showCreateEvidenceModal = false;
			  return errMsg;
		  });
		},
		getProjectEvidence: function() {
		  request("GET",
			`/api/v1/projects/${this.projectId}/evidence`,
			data => {
			  this.evidence = data;
			  this.filteredEvidence = this.evidence;
			  this.projectEvidence = data;
			},
			error => {
			  toast(error.message, "error");
			}
		  );
		},
		getEvidence: function(subcontrol) {
		  this.loadingEvidence = true;
		  // get evidence for a subcontrol
		  this.evidence = []
		  this.evidence_map = [];
		  this.seSelected = [];
		  this.seUnselected = [];

		  request("GET",
			`/api/v1/projects/${this.projectId}/subcontrols/${subcontrol.id}/evidence`,
			data => {
			  for (var item in data) {
				this.evidence.push(data[item])
				this.evidence_map[data[item].id] = data[item].name;
			  }
			  this.loadingEvidence = false;

			},
			error => {
			  toast(error.message, "error");
			}
		  );
		},
		// Attach Evidence to Subcontrol
		seListActive: false,
		seSelectedString: '',
		seSelected: [],
		seUnselected: [],
		seCustomTag: '',
		seAddMe(e) {
		  const index = e.target.dataset.index;
		  const extracted = this.seUnselected.splice(index, 1);
		  this.seSelected.push(extracted[0]);
		},
		seRemoveMe(e) {
		  const index = e.target.dataset.index;
		  const extracted = this.seSelected.splice(index, 1);
		  this.seUnselected.push(extracted[0]);
		},
		// feedback module
		addItem: function() {
			if (!this.feedbackTitle) {
				toast("Feedback title is required", "error")
				return
			}

			var data = {
				"title": this.feedbackTitle,
				"description": this.feedbackDescription,
				"relates_to": this.feedbackRelatesTo
			}
			request("POST",
				`/api/v1/projects/${this.projectId}/controls/${this.selectedControl.id}/feedback`,
				data => {
				  toast("Added feedback")
				  this.refreshControlFromServer(this.selectedControl.id)
				},
				error => {
				  toast(error.message, "error");
				},
				data
			);

			this.feedbackTitle = ""
			this.feedbackDescription = ""
			this.addFeedbackModal = false

		},
		updateItem: function(feedback) {
		  var data = {
			"title":feedback.title,
			"description":feedback.description,
			"is_complete":feedback.is_complete,
			"response":feedback.response
		  }
		  request("PUT",
			`/api/v1/projects/${this.projectId}/controls/${feedback.control_id}/feedback/${feedback.id}`,
			data => {
				toast("Updated feedback")
				this.refreshControlFromServer(this.selectedControl.id)
			},
			error => {
			  toast(error.message, "error");
			},
			data
		  );
		},
		createCustomControl: function() {
			var data = {
				"name": this.customControlName,
				"description": this.customControlDescription,
				"guidance": this.customControlGuidance
			}
			request("POST",
				`/api/v1/projects/${this.projectId}/controls`,
				data => {
					toast("Added custom control")
					this.getControls(useCache=false)
					this.showCreateCustomControlModal = false
				},
				error => {
					toast(error.message, "error");
				},
				data
			);
		}
	}
}

</script>

<script>
	function mentions() {
		return {
			init() {
				Alpine.effect(() => {
					const tags = Alpine.store('data').controls.map(item => ({
						label: item.ref_code,
						value: item.ref_code
					}));
					this.tags = tags
				})
				Alpine.effect(() => {
					const users = Alpine.store('users').data.map(item => ({
						label: item.email,
						value: item.email
					}));
					this.users = users
				})
			},
			keys: ['#', '@'],
			users: [],
			tags: [],
			items: [],
			placement: 'top-start',
			omitKey: false,
			filteringDisabled: false,
			insertSpace: false,
			mapInsert: null,
			limit: 4,
			key: null,
			oldKey: null,
			searchText: null,
			caretPosition: {
				top: 0,
				left: 0,
			},
			selectedIndex: 0,
			input: null,
			showPopover: false,
			filteredItems:  function() {
			  if (!this.searchText || this.filteringDisabled) {
				return this.items
			  }
			  const searchText = this.searchText.toLowerCase()
			  return this.items.filter(item => {
				/** @type {string} */
				let text
				if (item.searchText) {
				  text = item.searchText
				} else if (item.label) {
				  text = item.label
				} else {
				  text = ''
				  for (const key in item) {
					text += item[key]
				  }
				}
				return text.toLowerCase().includes(searchText)
			  })
			},
			displayedItems: [],
			updateDisplayedItems: function() {
				selectedIndex = 0;
				return this.displayedItems = this.filteredItems().slice(0, this.limit)
			},
			//
			isIe: function() {
				const userAgent = typeof window !== 'undefined' ? window.navigator.userAgent : '';
				return userAgent.indexOf('MSIE ') !== -1 || userAgent.indexOf('Trident/') !== -1;
			},
			isFirefox: function() {
				return !(window.mozInnerScreenX == null);
			},
			setInput: function(el) {
				this.input = el;
			},
			getCaretPosition: function(element, position) {
				var mirrorDiv, computed, style;
				// The properties that we copy into a mirrored div.
				// Note that some browsers, such as Firefox,
				// do not concatenate properties, i.e. padding-top, bottom etc. -> padding,
				// so we have to do every single property specifically.
				var properties = [
					'boxSizing',
					'width', // on Chrome and IE, exclude the scrollbar, so the mirror div wraps exactly as the textarea does
					'height',
					'overflowX',
					'overflowY', // copy the scrollbar for IE

					'borderTopWidth',
					'borderRightWidth',
					'borderBottomWidth',
					'borderLeftWidth',

					'paddingTop',
					'paddingRight',
					'paddingBottom',
					'paddingLeft',

					// https://developer.mozilla.org/en-US/docs/Web/CSS/font
					'fontStyle',
					'fontVariant',
					'fontWeight',
					'fontStretch',
					'fontSize',
					'lineHeight',
					'fontFamily',

					'textAlign',
					'textTransform',
					'textIndent',
					'textDecoration', // might not make a difference, but better be safe

					'letterSpacing',
					'wordSpacing'
				];
				// mirrored div
				mirrorDiv = document.getElementById(element.nodeName + '--mirror-div');
				if (!mirrorDiv) {
					mirrorDiv = document.createElement('div');
					mirrorDiv.id = element.nodeName + '--mirror-div';
					document.body.appendChild(mirrorDiv);
				}

				style = mirrorDiv.style;
				computed = getComputedStyle(element);

				// default textarea styles
				style.whiteSpace = 'pre-wrap';
				if (element.nodeName !== 'INPUT')
					style.wordWrap = 'break-word'; // only for textarea-s

				// position off-screen
				style.position = 'absolute'; // required to return coordinates properly
				style.top = element.offsetTop + parseInt(computed.borderTopWidth) + 'px';
				style.left = "400px";
				style.visibility = 'hidden'; // not 'display: none' because we want rendering

				// transfer the element's properties to the div
				properties.forEach(function(prop) {
					style[prop] = computed[prop];
				});

				if (this.isFirefox()) {
					style.width = parseInt(computed.width) - 2 + 'px' // Firefox adds 2 pixels to the padding - https://bugzilla.mozilla.org/show_bug.cgi?id=753662
					// Firefox lies about the overflow property for textareas: https://bugzilla.mozilla.org/show_bug.cgi?id=984275
					if (element.scrollHeight > parseInt(computed.height))
						style.overflowY = 'scroll';
				} else {
					style.overflow = 'hidden'; // for Chrome to not render a scrollbar; IE keeps overflowY = 'scroll'
				}

				mirrorDiv.textContent = element.value.substring(0, position);
				// the second special handling for input type="text" vs textarea: spaces need to be replaced with non-breaking spaces - http://stackoverflow.com/a/13402035/1269037
				if (element.nodeName === 'INPUT')
					mirrorDiv.textContent = mirrorDiv.textContent.replace(/\s/g, "\u00a0");

				var span = document.createElement('span');
				// Wrapping must be replicated *exactly*, including when a long word gets
				// onto the next line, with whitespace at the end of the line before (#7).
				// The  *only* reliable way to do that is to copy the *entire* rest of the
				// textarea's content into the <span> created at the caret position.
				// for inputs, just '.' would be enough, but why bother?
				span.textContent = element.value.substring(position) || '.'; // || because a completely empty faux span doesn't render at all
				mirrorDiv.appendChild(span);

				var coordinates = {
					top: span.offsetTop + parseInt(computed['borderTopWidth']) - element.scrollTop,
					left: span.offsetLeft + parseInt(computed['borderLeftWidth']),
				};

				return coordinates;
			},
			onInput: function(e) {
				this.checkKey()
			},
			onBlur: function() {
				this.closeMenu()
			},
			onKeyDown: function(e) {
				if (this.key) {
					if( this.keys.includes(e.key) ) {
						return this.cancelEvent(e);
					}
					this.updateDisplayedItems();
					if (e.key === 'ArrowDown' || e.keyCode === 40) {
						this.selectedIndex++
						if (this.selectedIndex >= this.displayedItems.length) {
							this.selectedIndex = 0
						}
						this.cancelEvent(e)
					}
					if (e.key === 'ArrowUp' || e.keyCode === 38) {
						this.selectedIndex--
						if (this.selectedIndex < 0) {
							this.selectedIndex = this.displayedItems.length - 1
						}
						this.cancelEvent(e)
					}
					if ((e.key === 'Enter' || e.key === 'Tab' || e.keyCode === 13 || e.keyCode === 9) &&
						this.displayedItems.length > 0) {
						this.applyMention(this.selectedIndex)
						this.cancelEvent(e)
					}
					if (e.key === 'Escape' || e.keyCode === 27) {
						this.closeMenu()
						this.cancelEvent(e)
					}
				}
			},
			onKeyUp: function(e) {
				if (this.cancelKeyUp && (e.key === this.cancelKeyUp || e.keyCode === this.cancelKeyCode)) {
					this.cancelEvent(e)
				}
				this.cancelKeyUp = null
				// IE
				this.cancelKeyCode = null
			},
			cancelEvent: function(e) {
				e.preventDefault()
				e.stopPropagation()
				this.cancelKeyUp = e.key
				// IE
				this.cancelKeyCode = e.keyCode
			},
			onScroll: function() {
				this.updateCaretPosition()
			},
			getSelectionStart: function() {
				return this.input.selectionStart
			},
			setCaretPosition: function(index) {
				this.$nextTick(() => {
					this.input.selectionEnd = index
				})
			},
			getValue: function() {
				return this.input.value
			},
			setValue: function(value) {
				this.input.value = value
			},
			checkKey: function() {
				const index = this.getSelectionStart()
				if (index >= 0) {
					const { key, keyIndex } = this.getLastKeyBeforeCaret(index)
					const searchText = this.lastSearchText = this.getLastSearchText(index, keyIndex)
					if (!(keyIndex < 1 || /\s/.test(this.getValue()[keyIndex - 1]))) {
						return false
					}
					if (searchText != null) {
						this.openMenu(key, keyIndex)
						this.searchText = searchText;
						this.updateDisplayedItems();
						return true
					}
				}
				this.closeMenu()
				return false
			},
			getLastKeyBeforeCaret: function(caretIndex) {
				const [keyData] = this.keys.map(key => ({
					key,
					keyIndex: this.getValue().lastIndexOf(key, caretIndex - 1),
				})).sort((a, b) => b.keyIndex - a.keyIndex)
				return keyData
			},
			getLastSearchText: function(caretIndex, keyIndex) {
				if (keyIndex !== -1) {
					const searchText = this.getValue().substring(keyIndex + 1, caretIndex)
					// If there is a space we close the menu
					if (!/\s/.test(searchText)) {
						return searchText
					}
				}
				return null
			},
			openMenu: function(key, keyIndex) {
				if (this.key !== key) {
					this.key = key
					this.keyIndex = keyIndex
					this.updateCaretPosition()
					this.selectedIndex = 0
					this.showPopover = true;
					this.items = this.key === '@' ? this.users : this.tags
				}
			},
			closeMenu: function() {
				if (this.key != null) {
					this.oldKey = this.key
					this.showPopover = false;
					this.key = null
				}
			},
			updateCaretPosition: function() {
				if (this.key) {
					this.caretPosition = this.getCaretPosition(this.input, this.keyIndex);
				}
			},
			applyMention: function(itemIndex) {
				const item = this.displayedItems[itemIndex]
				const value = (this.omitKey ? '' : this.key || '') + String(this.mapInsert ? this.mapInsert(item, this.key) : item.value) + (this.insertSpace ? ' ' : '')
				this.setValue(this.replaceText(this.getValue(), this.searchText, value, this.keyIndex))
				this.setCaretPosition(this.keyIndex + value.length);
				this.closeMenu()
			},
			replaceText: function(text, searchText, newText, index) {
				return text.slice(0, index) + newText + text.slice(index + searchText.length + 1, text.length)
			},
		};
	}
</script>

{%endblock%}
